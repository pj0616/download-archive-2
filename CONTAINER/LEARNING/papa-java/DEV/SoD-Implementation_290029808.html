<!DOCTYPE html>
<html>
    <head>
        <title>DevOps : SoD Implementation</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Home_603226548.html">DevOps Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_278921431.html">Tutorials</a></span>
                            </li>
                                                    <li>
                                <span><a href="Spring-Boot_278888737.html">Spring Boot</a></span>
                            </li>
                                                    <li>
                                <span><a href="Overrides_290029797.html">Overrides</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps : SoD Implementation
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicholas Guner</span>, last modified on Apr 19, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="SoDImplementation-Config">Config</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class AuditorAwareImpl implements AuditorAware&lt;String&gt;
{
    @Override
    public Optional&lt;String&gt; getCurrentAuditor()
    {
        //return Optional.of(SecurityContextHolder.getContext().getAuthentication().getName());
        return Optional.of(System.getProperty(&quot;user.name&quot;));
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Configuration
@Profile({&quot;db2&quot;})
public class DataSourceConfig
{
    @Value(&quot;${datasource.driver-class-name}&quot;)
    String dataSourceDriverClass;

    @Value(&quot;${datasource.url}&quot;)
    String dataSourceUrl;

    @Value(&quot;${datasource.system.account.credref}&quot;)
    String credRef;

    @Bean
    public DataSource getDataSource()
    {
        CredentialLookUp&lt;SystemAccount&gt; credentialLookUp = new CredentialLookUp&lt;&gt;();
        SystemAccount systemAccount = credentialLookUp.getCredentialObject(credRef);
        String systemAccountPassword = systemAccount.getPassword();
        String systemAccountName = systemAccount.getAccountName();
        String[] systemAccountParts = systemAccountName.split(&quot;\\\\&quot;);
        return DataSourceBuilder
                .create()
                .username(systemAccountParts[1])
                .password(systemAccountPassword)
                .url(dataSourceUrl)
                .driverClassName(dataSourceDriverClass)
                .build();
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Service(&quot;AuthenticationService&quot;)
public class GSSSOToken
{
    @Value(&quot;${datasource.system.account.credref}&quot;)
    String credRef;

    private String cookie;

    public String getCookie()
    {
        if(cookie == null)
        {
            CredentialLookUp&lt;SystemAccount&gt; credentialLookUp = new CredentialLookUp&lt;&gt;();
            SystemAccount systemAccount = credentialLookUp.getCredentialObject(credRef);
            String systemAccountPassword = systemAccount.getPassword();
            String systemAccountName = systemAccount.getAccountName();
            String[] systemAccountParts = systemAccountName.split(&quot;\\\\&quot;);
            GSSSOTokenProvider tokenProvider = new GSSSOTokenProvider(systemAccountParts[1], systemAccountPassword);
            tokenProvider.init();
            cookie = tokenProvider.getCurrentAuthenticationToken();
        }
        return cookie;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Component
@Profile({&quot;h2&quot;, &quot;db2&quot;})
public class HttpServer
{
    @Bean
    public ServletWebServerFactory servletContainer(@Value(&quot;${server.http.port}&quot;) int httpPort)
    {
        Connector connector = new Connector(TomcatServletWebServerFactory.DEFAULT_PROTOCOL);
        connector.setPort(httpPort);

        TomcatServletWebServerFactory tomcat = new TomcatServletWebServerFactory();
        tomcat.addAdditionalTomcatConnectors(connector);
        return tomcat;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Configuration
@EnableJpaAuditing(auditorAwareRef = &quot;auditorAware&quot;)
public class JpaConfig
{
    @Bean
    public AuditorAware&lt;String&gt; auditorAware()
    {
        return new AuditorAwareImpl();
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Component
@Profile({&quot;h2&quot;, &quot;db2&quot;})
public class SSLConfig implements WebServerFactoryCustomizer&lt;ConfigurableServletWebServerFactory&gt;
{
    @Value(&quot;${server.ssl.key-store}&quot;)
    private  String keyStore;

    @Value(&quot;${server.ssl.key-store-type}&quot;)
    private  String keyStoreType;

    @Value(&quot;${server.ssl.system.account.credref}&quot;)
    String credRef;

    @Value(&quot;${server.ssl.system.account.name}&quot;)
    String systemAccountName;

    @Override
    public void customize(ConfigurableServletWebServerFactory serverFactory)
    {
        CredentialLookUp&lt;SystemAccount&gt; credentialLookUp = new CredentialLookUp&lt;&gt;();
        SystemAccount systemAccount = credentialLookUp.getCredentialObject(credRef);
        String password = systemAccount.getPassword();

        Ssl ssl = new Ssl();
        ssl.setKeyStore(keyStore);
        ssl.setKeyStoreType(keyStoreType);
        ssl.setKeyPassword(password);
        ssl.setKeyStorePassword(password);
        serverFactory.setSsl(ssl);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="SoDImplementation-Controller">Controller</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RestController
@RepositoryRestController
public class ClearanceController
{
    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private PrivilegeController privilegeController;
    @Autowired
    private DutyPrivilegeMapRepository dutyPrivilegeMapRepository;
    @Autowired
    private DutyRuleMapRepository dutyRuleMapRepository;
    @Autowired
    private PrivilegeRepository privilegeRepository;
    @Autowired
    private RuleRepository ruleRepository;
    @Autowired
    private CampController campController;
    @Autowired
    private RmsComController rmsComController;
    @Autowired
    private AuditTrailRepository auditTrailRepository;
    @Autowired
    private PeopleSearchController peopleSearchController;


    private static String OVERRIDE = &quot;override&quot;;
    private static String CONTROL_ID = &quot;control id&quot;;
    private static String PRIVILEGE_OVERRIDE = &quot;PRIVILEGE_OVERRIDE&quot;;
    private static String RULE_OVERRIDE = &quot;RULE_OVERRIDE&quot;;
    private static String STATE = &quot;state&quot;;
    private static String EXPIRY_DATE = &quot;expiryDate&quot;;



    @GetMapping(&quot;/assignables/kerberos/{kerberos}&quot;)
    public ResponseEntity&lt;Resources&lt;PrivilegePresentation&gt;&gt; getAssignables(@PathVariable(&quot;kerberos&quot;) String kerberos) throws JSONException
    {
        List&lt;PrivilegePresentation&gt; privilegePresentations = new ArrayList&lt;&gt;();

        List&lt;Privilege&gt; privileges = getPrivilegesForKerberos(kerberos, false);
        for(Privilege privilege : privileges)
        {
            PrivilegePresentation privilegePresentation = privilegeController.getPrivilegePresentation(privilege.getID());
            privilegePresentations.add(privilegePresentation);
        }

        Resources&lt;PrivilegePresentation&gt; resources = new Resources&lt;&gt;(privilegePresentations);
        resources.add(linkTo(ControllerLinkBuilder.methodOn(getClass()).getPrivilegesForKerberos(kerberos, false)).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    @GetMapping(&quot;/duties/kerberos/{kerberos}&quot;)
    public ResponseEntity&lt;Resource&lt;UserDutiesPresentation&gt;&gt; getDuties(@PathVariable(&quot;kerberos&quot;) String kerberos) throws JSONException
    {
        List&lt;Privilege&gt; privileges = getPrivilegesForKerberos(kerberos, false);
        Set&lt;Duty&gt; allDuties = getDutiesForPrivileges(privileges);

        UserDutiesPresentation userDutiesPresentation = new UserDutiesPresentation(kerberos, allDuties);
        Resource&lt;UserDutiesPresentation&gt; resource = new Resource&lt;&gt;(userDutiesPresentation);

        for(Duty duty : allDuties)
        {
            resource.add(createDutyLink(duty));
        }

        return ResponseEntity.ok(resource);
    }

    //  TODO: include submitter of the request
    @GetMapping(&quot;/guid/{guid}/system/{system}/privilege/{privilegeId}&quot;)
    public ResponseEntity&lt;Resource&lt;?&gt;&gt; assignSystemPrivilegeToKerberos(@PathVariable(&quot;guid&quot;) String guid,
                                                                       @PathVariable(&quot;privilegeId&quot;) String privilegeId,
                                                                       @PathVariable(&quot;system&quot;) String system)  throws Exception
    {
        AuditTrail auditTrail = new AuditTrail();
        auditTrail.setPrivilegeId(privilegeId);
        auditTrail.setSystem(system);

        String kerberos = getKerberosFromGuid(guid, auditTrail);

        SimpleFilterProvider filterProvider = new SimpleFilterProvider();
        filterProvider.addFilter(&quot;clearanceResponse&quot;, SimpleBeanPropertyFilter.filterOutAllExcept(&quot;tmdResponse&quot;));

        ResponseEntity&lt;Resource&lt;?&gt;&gt; response;
        try
        {
            response = checkPrivilegeAssignmentToKerberos(kerberos, privilegeId, auditTrail, false, filterProvider, Arrays.asList(&quot;tmdResponse&quot;), false);
        }
        finally
        {
            auditTrailRepository.save(auditTrail);
//            try
//            {
//                auditTrailRepository.save(auditTrail);
//            }
//            catch(Exception e)
//            {
//                logger.error(&quot;Could not save to AUDIT_TRAIL table.&quot;);
//            }
        }
        return response;
    }

    @GetMapping(&quot;/privilege/{privilegeId}/kerberos/{kerberos}&quot;)
    public ResponseEntity&lt;Resource&lt;?&gt;&gt; checkPrivilegeAssignmentToKerberos(  @PathVariable(&quot;kerberos&quot;) String kerberos,
                                                                            @PathVariable(&quot;privilegeId&quot;) String privilegeId,
                                                                            @RequestParam(defaultValue = &quot;false&quot;) boolean skipOverrideCheck) throws Exception
    {
        AuditTrail auditTrail = new AuditTrail();
        peopleSearchController.findByKerberos(kerberos);

        SimpleFilterProvider filterProvider = new SimpleFilterProvider();
        filterProvider.addFilter(&quot;clearanceResponse&quot;, SimpleBeanPropertyFilter.filterOutAllExcept(&quot;violation&quot;, &quot;overrides&quot;));

        return checkPrivilegeAssignmentToKerberos(kerberos, privilegeId, auditTrail, skipOverrideCheck, filterProvider, Arrays.asList(&quot;violation&quot;, &quot;overrides&quot;), true);
    }

    @GetMapping(&quot;/privilege/{privilegeId}/guid/{guid}&quot;)
    public ResponseEntity&lt;Resource&lt;?&gt;&gt; checkPrivilegeAssignmentToGuid(  @PathVariable(&quot;guid&quot;) String guid,
                                                                        @PathVariable(&quot;privilegeId&quot;) String privilegeId,
                                                                        @RequestParam(defaultValue = &quot;false&quot;) boolean skipOverrideCheck) throws Exception
    {
        AuditTrail auditTrail = new AuditTrail();

        String kerberos = getKerberosFromGuid(guid, auditTrail);

        SimpleFilterProvider filterProvider = new SimpleFilterProvider();
        filterProvider.addFilter(&quot;clearanceResponse&quot;, SimpleBeanPropertyFilter.filterOutAllExcept(&quot;violation&quot;, &quot;overrides&quot;));

        return checkPrivilegeAssignmentToKerberos(kerberos, privilegeId, auditTrail, skipOverrideCheck, filterProvider, Arrays.asList(&quot;violation&quot;, &quot;overrides&quot;), true);
    }

    private ResponseEntity&lt;Resource&lt;?&gt;&gt; checkPrivilegeAssignmentToKerberos(String kerberos,
                                                                  String privilegeId,
                                                                  AuditTrail auditTrail,
                                                                  boolean skipOverrideCheck,
                                                                  SimpleFilterProvider filterProvider,
                                                                  List&lt;String&gt; filterNames,
                                                                  boolean includeLinks) throws JSONException, JsonProcessingException
    {
        auditTrail.setRequestedUser(kerberos);
        auditTrail.setExplanation(&quot;NO-ASSIGNABLE-CONFLICT&quot;);
        Map&lt;String,String&gt; response = new HashMap&lt;&gt;();
        response.put(&quot;Response&quot;, &quot;pass&quot;);

        try
        {
            //  Clearance API for kerberos
            //  If the privilege is not found in SoD database, it can&#39;t be part of any Duty and therefore can be assigned to user
            Optional&lt;Privilege&gt; privilegeOptional = privilegeRepository.findByPrivilegeId(privilegeId);
            if (privilegeOptional.isPresent()) //    Privilege found in SoD database
            {
                Privilege requestedPrivilege = privilegeOptional.get();
                auditTrail.setAssignableId(requestedPrivilege.getID());
                auditTrail.setAssignableName(requestedPrivilege.getPrivilegeName());
                //  check if kerberos already owns requested privilege
                List&lt;Privilege&gt; kerberosPrivileges = getPrivilegesForKerberos(kerberos, false);
                if (kerberosPrivileges.stream().noneMatch(p -&gt; p.getID() == requestedPrivilege.getID()))  // kerberos does NOT own requested privilege
                {
                    //  This privilege may NOT be associated with any Duty, if that is the case, we can assign privilege to user
                    List&lt;DutyPrivilegePair&gt; dutyPrivilegePairs = dutyPrivilegeMapRepository.findByPrivilegeId(requestedPrivilege.getID());
                    if (!dutyPrivilegePairs.isEmpty())   // requested privilege IS associated with some duty
                    {
                        if(!kerberosPrivileges.isEmpty())  //  kerberos has at least one assignable
                        {
                            //  Get all Duties for privileges owned by Kerberos
                            List&lt;Long&gt; kerberosPrivilegeIDs = kerberosPrivileges.stream().map(Privilege::getID).collect(Collectors.toList());
                            List&lt;DutyPrivilegePair&gt; kerberosDutyPrivilegePairs = dutyPrivilegeMapRepository.findByPrivilegeIdList(kerberosPrivilegeIDs);
                            //  If kerberos privileges are not associated with any Duties, we can assign this privilege
                            if (!kerberosDutyPrivilegePairs.isEmpty())   // kerberos privileges are associated with some Duties
                            {
                                List&lt;Duty&gt; dutiesForKerberos = kerberosDutyPrivilegePairs.stream().map(DutyPrivilegePair::getDuty).distinct().collect(Collectors.toList());
                                List&lt;Duty&gt; dutiesForRequestedPrivilege = dutyPrivilegePairs.stream().map(DutyPrivilegePair::getDuty).distinct().collect(Collectors.toList());

                                //  If a requested privilege belongs to conflicting duties, reject it
                                if (dutiesForRequestedPrivilege.size() &gt; 1)
                                {
                                    List&lt;Rule&gt; rulesForRequestedAssignable = getRulesForPrivilege(requestedPrivilege);
                                    if (!rulesForRequestedAssignable.isEmpty())
                                    {
                                        for(Rule rule : rulesForRequestedAssignable)
                                        {
                                            List&lt;DutyRulePair&gt; ruleDutyPairs = dutyRuleMapRepository.findByRuleId(rule.getID());
                                            List&lt;Duty&gt; dutiesForRule = ruleDutyPairs.stream().map(DutyRulePair::getDuty).collect(Collectors.toList());
                                            if(dutiesForRule.containsAll(dutiesForRequestedPrivilege))
                                            {
                                                String rejectReason = &quot;Assignment of Privilege &#39;&quot; + requestedPrivilege.getPrivilegeName() + &quot;&#39; violates rule(s) &quot; + rulesForRequestedAssignable;
                                                auditTrail.setRejectReason(rejectReason);
                                                auditTrail.setExplanation(&quot;TOXIC-ASSIGNABLE&quot;);
                                                throw new RuleViolationException(rejectReason);
                                            }
                                        }
                                    }
                                }

                                //  Find conflicting Rules
                                Set&lt;Rule&gt; conflictingRules = new HashSet&lt;&gt;();
                                Map&lt;Duty, List&lt;Privilege&gt;&gt; dutyPrivilegeMap = new HashMap&lt;&gt;();

                                for (Duty requestedPrivilegeDuty : dutiesForRequestedPrivilege)
                                {
                                    for (Duty kerberosDuty : dutiesForKerberos)
                                    {
                                        if (!requestedPrivilegeDuty.equals(kerberosDuty))
                                        {
                                            //  One privilege may be associated with multiple Duties
                                            List&lt;DutyRulePair&gt; requestedPrivilegeDutyRulePairs = dutyRuleMapRepository.findByDutyId(requestedPrivilegeDuty.getID());
                                            List&lt;DutyRulePair&gt; kerberosRuleDutyPairs = dutyRuleMapRepository.findByDutyId(kerberosDuty.getID());

                                            List&lt;Rule&gt; requestedPrivilegeRules = requestedPrivilegeDutyRulePairs.stream()
                                                    .map(DutyRulePair::getRule)
                                                    .collect(Collectors.toList());
                                            List&lt;Rule&gt; kerberosRules = kerberosRuleDutyPairs.stream()
                                                    .map(DutyRulePair::getRule)
                                                    .collect(Collectors.toList());

                                            if(!(requestedPrivilegeRules.isEmpty() || kerberosRules.isEmpty()))
                                            {
                                                List&lt;Rule&gt; intersection = new ArrayList&lt;&gt;(kerberosRules);
                                                intersection.retainAll(requestedPrivilegeRules);
                                                if (!intersection.isEmpty())
                                                {
                                                    for (Rule rule : intersection)
                                                    {
                                                        List&lt;Duty&gt; duties = rule.getDutyRulePairs().stream().map(DutyRulePair::getDuty).collect(Collectors.toList());
                                                        //  Find all privileges for this Duty belonging to kerberos
                                                        for (Duty duty : duties)
                                                        {
                                                            List&lt;Privilege&gt; privilegesForKerberosDuty = dutyPrivilegeMapRepository.findByDutyId(duty.getID())
                                                                    .stream()
                                                                    .map(DutyPrivilegePair::getPrivilege)
                                                                    .collect(Collectors.toList());
                                                            privilegesForKerberosDuty.retainAll(kerberosPrivileges);
                                                            dutyPrivilegeMap.put(duty, privilegesForKerberosDuty);
                                                        }
                                                    }

                                                    conflictingRules.addAll(intersection);
                                                }
                                            }
                                        }
                                    }
                                }

                                //  If no conflicting Rules were found, privilege may be assigned
                                if (!conflictingRules.isEmpty()) // conflicting Rules were found
                                {
                                    auditTrail.setRules(conflictingRules.stream().map(Rule::getRuleName).collect(Collectors.joining(&quot;;&quot;)));
                                    auditTrail.setExplanation(&quot;CONFLICT-FOUND&quot;);

                                    if (skipOverrideCheck || !kerberosHasOverride(kerberos, privilegeId, conflictingRules, dutyPrivilegeMap))
                                    {
                                        ClearanceViolationPresentation clearanceViolationPresentation = new ClearanceViolationPresentation(kerberos,
                                                requestedPrivilege,
                                                dutiesForRequestedPrivilege,
                                                conflictingRules,
                                                dutyPrivilegeMap);


                                        ObjectMapper om = new ObjectMapper();
                                        om.setFilterProvider(filterProvider);

                                        String jsonString = om.writeValueAsString(clearanceViolationPresentation);
                                        JSONObject jsonObject = new JSONObject(jsonString);

                                        Map&lt;String, Object&gt; clearanceResponse = new LinkedHashMap&lt;&gt;();
                                        clearanceResponse.put(&quot;Response&quot;, &quot;fail&quot;);

                                        for (String filterValue : filterNames)
                                        {
                                            JSONArray jsonArray = (JSONArray) jsonObject.get(filterValue);

                                            List&lt;String&gt; filterList = new ArrayList&lt;&gt;();
                                            for (int i = 0; i &lt; jsonArray.length(); ++i)
                                            {
                                                filterList.add((String) jsonArray.get(i));
                                            }
                                            clearanceResponse.put(filterValue, filterList);
                                        }

                                        auditTrail.setRejectReason(clearanceViolationPresentation.getRejectReason());
                                        auditTrail.setReason(clearanceViolationPresentation.getTmdResponse().stream().collect(Collectors.joining(&quot; &quot;)));
                                        auditTrail.setClear(&quot;false&quot;);

                                        Resource&lt;Map&lt;String, Object&gt;&gt; resource = new Resource&lt;&gt;(clearanceResponse);
                                        if (includeLinks)
                                        {
                                            resource.add(clearanceViolationPresentation.getLinks());
                                        }

                                        return new ResponseEntity&lt;&gt;(resource, HttpStatus.OK);
                                    }
                                    else
                                    {
                                        auditTrail.setExplanation(&quot;OVERRIDE-FOUND-FOR-CONFLICT&quot;);
                                    }
                                }   //  found conflicting rules
                            }   // privileges owned by kerberos are associated with some Duties
                        }   //  kerberos has at least one assignable
                    }   //  requested privileges is associated with some Duty
                } //  Kerberos does not own requested privilege
                else
                {
                    auditTrail.setExplanation(&quot;OWNS-REQUESTED-PRIVILEGE&quot;);
                }
            }   //  requested privilege exists in SoD database
            else
            {
                auditTrail.setExplanation(&quot;ASSIGNABLE-NOT-DUTY-CLASSIFIED&quot;);
            }

            auditTrail.setClear(&quot;true&quot;);
        }
        catch(Exception e)
        {
            auditTrail.setException(e.getMessage());
            throw e;
        }

        Resource&lt;Map&lt;String, String&gt;&gt; resource = new Resource&lt;&gt;(response);

        return new ResponseEntity&lt;&gt;(resource, HttpStatus.OK);
    }


    private String getKerberosFromGuid(String guid, AuditTrail auditTrail) throws Exception
    {
        String kerberos;
        try
        {
            kerberos = peopleSearchController.kerberosFromGuid(guid);
        }
        catch(NotFoundException e)
        {
            auditTrail.setRequestedUser(guid);
            auditTrail.setExplanation(&quot;INVALID-GUID&quot;);
            auditTrail.setException(e.getMessage());
            auditTrailRepository.save(auditTrail);
            throw e;
        }
        return kerberos;
    }


    @GetMapping(&quot;/validate/kerberos/{kerberos}&quot;)
    public ResponseEntity&lt;?&gt; validateKerberosAssignables(@PathVariable(&quot;kerberos&quot;) String kerberos,
                                                         @RequestParam(defaultValue = &quot;false&quot;) boolean skipOverrideCheck,
                                                         @RequestParam(defaultValue = &quot;true&quot;) boolean skipTestData) throws JSONException
    {
        List&lt;Privilege&gt; privilegesForkerberos = getPrivilegesForKerberos(kerberos, skipTestData);

        if(!privilegesForkerberos.isEmpty())
        {
            List&lt;Long&gt; privilegeIDsForKerberos = privilegesForkerberos.stream().map(Privilege::getID).collect(Collectors.toList());
            List&lt;DutyPrivilegePair&gt; dutyPrivilegePairsForKerberos = dutyPrivilegeMapRepository.findByPrivilegeIdList(privilegeIDsForKerberos);
            if(!dutyPrivilegePairsForKerberos.isEmpty())
            {
                Set&lt;Rule&gt; conflictingRules = new HashSet&lt;&gt;();
                Map&lt;Duty, List&lt;Privilege&gt;&gt; dutyPrivilegesMap = new HashMap&lt;&gt;();

                List&lt;Duty&gt; allDuties = dutyPrivilegePairsForKerberos.stream().map(DutyPrivilegePair::getDuty).distinct().collect(Collectors.toList());
                for(int i = 0; i &lt; allDuties.size() - 1; ++i)
                {
                    Duty duty1 = allDuties.get(i);

                    for(int j = i + 1; j &lt; allDuties.size(); ++j)
                    {
                        Duty duty2 = allDuties.get(j);

                        List&lt;DutyRulePair&gt; dutyRulePairList1 = dutyRuleMapRepository.findByDutyId(duty1.getID());
                        if(!dutyRulePairList1.isEmpty())
                        {
                            List&lt;DutyRulePair&gt; dutyRulePairList2 = dutyRuleMapRepository.findByDutyId(duty2.getID());
                            if(!dutyRulePairList2.isEmpty())
                            {
                                List&lt;Rule&gt; ruleList1 = dutyRulePairList1.stream()
                                        .map(DutyRulePair::getRule)
                                        .collect(Collectors.toList());
                                List&lt;Rule&gt; ruleList2 = dutyRulePairList2.stream()
                                        .map(DutyRulePair::getRule)
                                        .collect(Collectors.toList());

                                if(!(ruleList1.isEmpty() || ruleList2.isEmpty()))
                                {
                                    List&lt;Rule&gt; intersection = new ArrayList&lt;&gt;(ruleList1);
                                    intersection.retainAll(ruleList2);
                                    if(!intersection.isEmpty())
                                    {
                                        List&lt;Privilege&gt; privilegesForDuty1 = dutyPrivilegeMapRepository.findByDutyId(duty1.getID())
                                                .stream()
                                                .map(DutyPrivilegePair::getPrivilege)
                                                .collect(Collectors.toList());
                                        privilegesForDuty1.retainAll(privilegesForkerberos);
                                        dutyPrivilegesMap.put(duty1, privilegesForDuty1);

                                        List&lt;Privilege&gt; privilegesForDuty2 = dutyPrivilegeMapRepository.findByDutyId(duty2.getID())
                                                .stream()
                                                .map(DutyPrivilegePair::getPrivilege)
                                                .collect(Collectors.toList());
                                        privilegesForDuty2.retainAll(privilegesForkerberos);
                                        dutyPrivilegesMap.put(duty2, privilegesForDuty2);

                                        conflictingRules.addAll(intersection);
                                    }
                                }
                            }
                        }
                    }
                }

                if(!conflictingRules.isEmpty()) // conflicting Rules were found
                {
                    //  For each conflicting Rule, find privileges owned by Kerberos
                    if(skipOverrideCheck || !kerberosHasOverride(kerberos, dutyPrivilegesMap, conflictingRules))
                    {
                        List&lt;RuleViolationPresentation&gt; ruleViolationPresentations = conflictingRules.stream()
                                .map(r -&gt; new RuleViolationPresentation(kerberos, r, dutyPrivilegesMap))
                                .map(r -&gt; {r.add(linkTo(methodOn(RuleController.class).getRules(r.getRule().getID())).withRel(&quot;rule&quot;)); return r;})
                                .collect(Collectors.toList());
                        Resources&lt;RuleViolationPresentation&gt; resources = new Resources&lt;&gt;(ruleViolationPresentations);

                        return new ResponseEntity&lt;&gt;(resources, HttpStatus.FAILED_DEPENDENCY);
                    }
                }
            }
        }

        Map&lt;String,String&gt; okResponse = new HashMap&lt;String,String&gt;() {{put(&quot;status&quot;, &quot;Pass&quot;);}};
        return ResponseEntity.ok(okResponse);
    }



    private List&lt;Rule&gt; getRulesForPrivilegeIDs(List&lt;Long&gt; privilegeIdList)
    {
        List&lt;Rule&gt; result = new ArrayList&lt;&gt;();

        List&lt;DutyPrivilegePair&gt; hasDutyPrivilegePairList = dutyPrivilegeMapRepository.findByPrivilegeIdList(privilegeIdList);
        if(!hasDutyPrivilegePairList.isEmpty())
        {
            List&lt;Duty&gt; hasDutyList = hasDutyPrivilegePairList.stream().map(DutyPrivilegePair::getDuty).collect(Collectors.toList());
            List&lt;Long&gt; hasDutyIdList = hasDutyList.stream().map(Duty::getID).collect(Collectors.toList());
            List&lt;DutyRulePair&gt; dutyRulePairList = dutyRuleMapRepository.findByDutyIdList(hasDutyIdList);
            if (!dutyRulePairList.isEmpty())
            {
                result.addAll(dutyRulePairList.stream().map(DutyRulePair::getRule).collect(Collectors.toList()));
            }
        }

        return result;
    }


    private boolean kerberosHasOverride(String kerberos,
                                        String privilegeId,
                                        Set&lt;Rule&gt; conflictRules,
                                        Map&lt;Duty, List&lt;Privilege&gt;&gt; kerberosDutyPrivilegeMap) throws JSONException
    {
        Set&lt;Rule&gt; remainingConflictRules = new HashSet&lt;&gt;(conflictRules);

        List&lt;Map&lt;String, String&gt;&gt; overridesList = getComOverridesForKerberos(kerberos);

        if(!overridesList.isEmpty())
        {
            for(Map&lt;String,String&gt; overrideMap : overridesList)
            {
                if(isOverrideApprovedAndActive(overrideMap))
                {
                    String override = overrideMap.get(OVERRIDE);
                    String[] overrideParts = override.split(&quot;@&quot;);
                    if (overrideParts[0].equals(PRIVILEGE_OVERRIDE))
                    {
                        int controlId = Integer.parseInt(overrideMap.get(CONTROL_ID));

                        Privilege privilegeForRequestedPrivilegeId = privilegeRepository
                                .findByPrivilegeId(privilegeId).get();

                        String[] privilegeOverrideParts = overrideParts[1].split(&quot;:&quot;);
                        if (privilegeOverrideParts.length == 2)
                        {
                            String privilegesLeftPart = privilegeOverrideParts[0];
                            List&lt;Long&gt; leftPrivilegesIDList = Arrays.stream(privilegesLeftPart.split(&quot;~&quot;))
                                    .skip(1L)
                                    .map(Long::valueOf)
                                    .collect(Collectors.toList());
                            List&lt;Privilege&gt; leftPrivilegesList = privilegeRepository.findByIdList(leftPrivilegesIDList);

                            String rightPrivilegesPart = privilegeOverrideParts[1];
                            List&lt;Long&gt; rightPrivilegesIDList = Arrays.stream(rightPrivilegesPart.split(&quot;~&quot;))
                                    .skip(1L)
                                    .map(Long::valueOf)
                                    .collect(Collectors.toList());
                            List&lt;Privilege&gt; rightPrivilegesList = privilegeRepository.findByIdList(rightPrivilegesIDList);


                            if(leftPrivilegesList.contains(privilegeForRequestedPrivilegeId)
                                    || rightPrivilegesList.contains(privilegeForRequestedPrivilegeId))
                            {
                                List&lt;Rule&gt; rulesForRightSide = getRulesForPrivilegeIDs(rightPrivilegesIDList);
                                List&lt;Rule&gt; rulesForLeftSide = getRulesForPrivilegeIDs(leftPrivilegesIDList);

                                List&lt;Rule&gt; commonRules = new ArrayList&lt;&gt;(rulesForRightSide);
                                commonRules.retainAll(rulesForLeftSide);

                                List&lt;Rule&gt; matchingRules = remainingConflictRules.stream()
                                        .filter(r -&gt; r.getControlId() == controlId)
                                        .filter(r -&gt; commonRules.contains(r))
                                        .collect(Collectors.toList());
                                if(!matchingRules.isEmpty())
                                {
                                    List&lt;Privilege&gt; privilegeListToCheck =
                                            leftPrivilegesList.contains(privilegeForRequestedPrivilegeId)
                                                    ? rightPrivilegesList
                                                    : leftPrivilegesList;

                                    Set&lt;Duty&gt; dutiesForPrivilegesToCheck = getDutiesForPrivileges(privilegeListToCheck);
                                    for(Duty duty : dutiesForPrivilegesToCheck)
                                    {
                                        List&lt;Privilege&gt; privilegesForKerberosDuty = kerberosDutyPrivilegeMap.get(duty);
                                        if(!CollectionUtils.isEmpty(privilegesForKerberosDuty))
                                        {
                                            if(privilegeListToCheck.containsAll(privilegesForKerberosDuty))
                                            {
                                                remainingConflictRules.removeAll(matchingRules);
                                            }
                                        }
                                        if(remainingConflictRules.isEmpty())
                                        {
                                            break;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    else if (overrideParts[0].equals(&quot;RULE_OVERRIDE&quot;))
                    {
                        long ruleId = Long.valueOf(overrideParts[1]);
                        Optional&lt;Rule&gt; ruleOptional = ruleRepository.findById(ruleId);
                        if (ruleOptional.isPresent())
                        {
                            Rule rule = ruleOptional.get();
                            if (conflictRules.contains(rule))
                            {
                                remainingConflictRules.remove(rule);
                            }
                        }
                    }
                }
                if(remainingConflictRules.isEmpty())
                {
                    break;
                }
            }
        }

        return remainingConflictRules.isEmpty();
    }

    private boolean kerberosHasOverride(String kerberos,
                                        Map&lt;Duty, List&lt;Privilege&gt;&gt; kerberosDutyPrivilegeMap,
                                        Set&lt;Rule&gt; conflictRules) throws JSONException
    {
        //  This function used to validate user
        List&lt;Map&lt;String, String&gt;&gt; overridesList = getComOverridesForKerberos(kerberos);

        if(!overridesList.isEmpty())
        {
            Map&lt;List&lt;Long&gt;, List&lt;Long&gt;&gt; assignableOverridesMap = new HashMap&lt;&gt;();
            for(Map&lt;String,String&gt; overrideMap : overridesList)
            {
                if(isOverrideApprovedAndActive(overrideMap))
                {
                    String override = overrideMap.get(OVERRIDE);
                    String[] overrideParts = override.split(&quot;@&quot;);
                    if (overrideParts[0].equals(PRIVILEGE_OVERRIDE))
                    {
                        String[] assignableOverrideParts = overrideParts[1].split(&quot;:&quot;);
                        if (assignableOverrideParts.length == 2)
                        {
                            String leftAssignables = assignableOverrideParts[0];
                            String rightAssignables = assignableOverrideParts[1];
                            if(StringUtils.hasText(leftAssignables) &amp;&amp; StringUtils.hasText(rightAssignables))
                            {
                                List&lt;Long&gt; leftAssignableList = Arrays.stream(leftAssignables.split(&quot;~&quot;)).skip(1L).map(Long::valueOf).collect(Collectors.toList());
                                List&lt;Long&gt; rightAssignableList = Arrays.stream(rightAssignables.split(&quot;~&quot;)).skip(1L).map(Long::valueOf).collect(Collectors.toList());

                                assignableOverridesMap.computeIfAbsent(leftAssignableList, e -&gt; new ArrayList&lt;&gt;()).addAll(rightAssignableList);
                            }
                        }
                    }
                    else if (overrideParts[0].equals(RULE_OVERRIDE))
                    {
                        int ruleId = Integer.valueOf(overrideParts[1]);
                        Optional&lt;Rule&gt; ruleOptional = ruleRepository.findById(ruleId);
                        if (ruleOptional.isPresent())
                        {
                            Rule rule = ruleOptional.get();
                            if (conflictRules.contains(rule))
                            {
                                conflictRules.remove(rule);
                            }
                        }
                    }
                }
            }

            if(!conflictRules.isEmpty() &amp;&amp; !assignableOverridesMap.isEmpty())
            {
                Set&lt;Rule&gt; matchedRules = new HashSet&lt;&gt;();
                for(Rule rule : conflictRules)
                {
                    List&lt;Duty&gt; duties = rule.getDutyRulePairs().stream().map(DutyRulePair::getDuty).collect(Collectors.toList());
                    if (duties.size() == 2)
                    {
                        Duty duty1 = duties.get(0);
                        Duty duty2 = duties.get(1);
                        List&lt;Privilege&gt; privileges1 = kerberosDutyPrivilegeMap.get(duty1);
                        List&lt;Privilege&gt; privileges2 = kerberosDutyPrivilegeMap.get(duty2);
                        if (!(privileges1 == null || privileges2 == null || privileges1.isEmpty() || privileges2.isEmpty()))
                        {
                            List&lt;Long&gt; privileges1IDs = privileges1.stream().map(Privilege::getID).collect(Collectors.toList());
                            List&lt;Long&gt; privileges2IDs = privileges2.stream().map(Privilege::getID).collect(Collectors.toList());
                            for (Map.Entry&lt;List&lt;Long&gt;, List&lt;Long&gt;&gt; e : assignableOverridesMap.entrySet())
                            {
                                List&lt;Long&gt; leftIDs = e.getKey();
                                List&lt;Long&gt; rightIDs = e.getValue();

                                if ((leftIDs.containsAll(privileges1IDs) &amp;&amp; rightIDs.containsAll(privileges2IDs)) ||
                                        (leftIDs.containsAll(privileges2IDs) &amp;&amp; rightIDs.containsAll(privileges1IDs)))
                                {
                                    matchedRules.add(rule);
                                    break;
                                }
                            }
                        }
                    }
                }

                conflictRules.removeAll(matchedRules);
            }
        }
        return conflictRules.isEmpty();
    }

    private List&lt;Map&lt;String, String&gt;&gt; getComOverridesForKerberos(String kerberos) throws JSONException
    {
        ResponseEntity&lt;Map&lt;String,List&lt;Map&lt;String, String&gt;&gt;&gt;&gt; response = rmsComController.getComOverrides(kerberos);
        if(response != null &amp;&amp; response.getStatusCode() == HttpStatus.OK)
        {
            Map&lt;String,List&lt;Map&lt;String, String&gt;&gt;&gt; overridesMap = response.getBody();
            return overridesMap.values().stream().flatMap(List::stream).collect(Collectors.toList());
        }

        return Collections.emptyList();
    }


    private boolean isOverrideApprovedAndActive(Map&lt;String,String&gt; overrideMap)
    {
        String state = overrideMap.get(STATE);
        String expiryDateStr = overrideMap.get(EXPIRY_DATE);
        if(StringUtils.hasText(state) &amp;&amp; StringUtils.hasText(expiryDateStr))
        {
            if(!state.equals(&quot;APPROVED&quot;))
            {
                return false;
            }
            Instant expiryInstant = Instant.parse(expiryDateStr);
            if(Instant.now().compareTo(expiryInstant) &gt; 0)
            {
                return false;
            }
            return true;
        }
        return false;
    }

    private List&lt;Duty&gt; getDutiesForPrivilege(Privilege privilege)
    {
        List&lt;Duty&gt; result = new ArrayList&lt;&gt;();

        List&lt;DutyPrivilegePair&gt; dutyPrivilegePairs = dutyPrivilegeMapRepository.findByPrivilegeId(privilege.getID());
        if(!dutyPrivilegePairs.isEmpty())
        {
            result = dutyPrivilegePairs.stream().map(DutyPrivilegePair::getDuty).collect(Collectors.toList());
        }
        return result;
    }

    private List&lt;Rule&gt; getRulesForPrivilege(Privilege privilege)
    {
        List&lt;Rule&gt; result = new ArrayList&lt;&gt;();

        List&lt;Duty&gt; duties = getDutiesForPrivilege(privilege);
        if(!duties.isEmpty())
        {
            if(duties.size() == 1)
            {
                return dutyRuleMapRepository.findByDutyId(duties.get(0).getID()).stream().map(DutyRulePair::getRule).collect(Collectors.toList());
            }

            //  Create all combinations of duties
            List&lt;Pair&gt; dutyPairs = new ArrayList&lt;&gt;();
            for(int i = 0; i &lt; duties.size() - 1; ++i)
            {
                for(int j = i + 1; j &lt; duties.size(); ++j)
                {
                    dutyPairs.add(Pair.of(duties.get(i), duties.get(j)));
                }
            }

            for(Pair&lt;Duty,Duty&gt; pair : dutyPairs)
            {
                List&lt;Rule&gt; rules1 = dutyRuleMapRepository.findByDutyId(pair.getFirst().getID()).stream().map(DutyRulePair::getRule).collect(Collectors.toList());
                List&lt;Rule&gt; rules2 = dutyRuleMapRepository.findByDutyId(pair.getSecond().getID()).stream().map(DutyRulePair::getRule).collect(Collectors.toList());
                List&lt;Rule&gt; intersection = new ArrayList&lt;&gt;(rules1);
                intersection.retainAll(rules2);
                result.addAll(intersection);
            }
        }
        return result;
    }

    //  Note internal visibility
    List&lt;Privilege&gt; getPrivilegesForKerberos(String kerberos, boolean excludeTestData) throws JSONException
    {
        ResponseEntity&lt;List&lt;String&gt;&gt; response = campController.getCampPrivilegesByKerberos(kerberos);
        if(response.getStatusCode() != HttpStatus.OK)
        {
            throw new NotFoundException(&quot;kerberos-&quot; + kerberos);
        }

        List&lt;String&gt; privilegeIDs = response.getBody();
        if(privilegeIDs.isEmpty())
        {
            throw new NotFoundException(&quot;No CAMP privileges for user: &quot; + kerberos);
        }

        List&lt;Privilege&gt; privileges = privilegeRepository.findByPrivilegeIdList(privilegeIDs);

        if(!privileges.isEmpty() &amp;&amp; excludeTestData)
        {
            privileges = privileges.stream().filter(a -&gt; a.getID() &gt; 1000).collect(Collectors.toList());
        }

        return privileges;
    }

    private Set&lt;Duty&gt; getDutiesForPrivileges(List&lt;Privilege&gt; privileges)
    {
        //  Note: same function defined in UserPrivilegeController
        Set&lt;Duty&gt; allDuties = new HashSet&lt;&gt;();
        for(Privilege privilege : privileges)
        {
            List&lt;DutyPrivilegePair&gt; dutyPrivilegePairs = dutyPrivilegeMapRepository.findByPrivilegeId(privilege.getID());
            Set&lt;Duty&gt; dutiesSet = dutyPrivilegePairs.stream().map(DutyPrivilegePair::getDuty).collect(Collectors.toSet());
            allDuties.addAll(dutiesSet);
        }
        return allDuties;
    }


    private Link createDutyLink(Duty duty)
    {
        return linkTo(methodOn(DutyController.class).getDuties(duty.getID())).withRel(&quot;duty&quot;).withTitle(duty.getDutyName());
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Transactional
@RestController
@RepositoryRestController
public class DutyController
{
    @Autowired
    private DutyRepository dutyRepository;
    @Autowired
    private DutyPrivilegeMapRepository dutyPrivilegeMapRepository;
    @Autowired
    private DutyRuleMapRepository dutyRuleMapRepository;
    @Autowired
    private PrivilegeRepository privilegeRepository;

    //  Display comma separated list of privileges for current duty
    @GetMapping(&quot;/duties&quot;)
    public ResponseEntity&lt;Resources&lt;Resource&lt;DutyPresentation&gt;&gt;&gt; getDuties()
    {
        List&lt;Resource&lt;DutyPresentation&gt;&gt; resourceResult = new ArrayList&lt;&gt;();

        List&lt;Duty&gt; duties = dutyRepository.findAll();
        for(Duty duty : duties)
        {
            DutyPresentation dutyPresentation = getDutyPresentationWithPrivileges(duty);
            Resource&lt;DutyPresentation&gt; dutyPresentationResource = new Resource&lt;&gt;(dutyPresentation, createSelfLink(duty.getID()));

            addRuleLinksToDutyPresentationResource(duty.getID(), dutyPresentationResource);

            resourceResult.add(dutyPresentationResource);
        }
        Resources&lt;Resource&lt;DutyPresentation&gt;&gt; resources = new Resources&lt;&gt;(resourceResult);
        resources.add(linkTo(methodOn(getClass()).getDuties()).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    //  Display link to all privileges for current duty
    @GetMapping(&quot;/duties2&quot;)
    public ResponseEntity&lt;Resources&lt;Resource&lt;DutyPresentation&gt;&gt;&gt; getDuties2()
    {
        List&lt;Resource&lt;DutyPresentation&gt;&gt; resourceResult = new ArrayList&lt;&gt;();

        List&lt;Duty&gt; duties = dutyRepository.findAll();
        for(Duty duty : duties)
        {
            DutyPresentation dutyPresentation = getDutyPresentation(duty);
            Resource&lt;DutyPresentation&gt; dutyPresentationResource = new Resource&lt;&gt;(dutyPresentation, createSelfLink2(duty.getID()));
            dutyPresentationResource.add(createAllPrivilegesLink(duty));

            addRuleLinksToDutyPresentationResource(duty.getID(), dutyPresentationResource);

            resourceResult.add(dutyPresentationResource);
        }
        Resources&lt;Resource&lt;DutyPresentation&gt;&gt; resources = new Resources&lt;&gt;(resourceResult);
        resources.add(linkTo(methodOn(getClass()).getDuties2()).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    // Note package visibility
    ResponseEntity&lt;Resources&lt;DutyPresentation&gt;&gt; getDutyPresentationResourceInternal()
    {
        List&lt;DutyPresentation&gt; dutyPresentations = new ArrayList&lt;&gt;();

        List&lt;Duty&gt; duties = dutyRepository.findAll();
        for(Duty duty : duties)
        {
            DutyPresentation dutyPresentation = getDutyPresentationWithPrivileges(duty);
            dutyPresentations.add(dutyPresentation);
        }
        Resources&lt;DutyPresentation&gt; resources = new Resources&lt;&gt;(dutyPresentations);
        resources.add(linkTo(methodOn(getClass()).getDuties()).withSelfRel());
        return ResponseEntity.ok(resources);
    }


    //  Display comma separated list of privileges for current duty
    @GetMapping(&quot;/duties/{id}&quot;)
    public ResponseEntity&lt;Resource&lt;DutyPresentation&gt;&gt; getDuties(@PathVariable(&quot;id&quot;) long id)
    {
        Optional&lt;Duty&gt; dutyOptional = dutyRepository.findById(id);
        if(!dutyOptional.isPresent())
        {
            throwNotFoundException(id);
        }

        Duty duty = dutyOptional.get();
        DutyPresentation dutyPresentation = getDutyPresentationWithPrivileges(duty);
        Resource&lt;DutyPresentation&gt; dutyPresentationResource = getDutyPresentationResource(dutyPresentation);

        addRuleLinksToDutyPresentationResource(id, dutyPresentationResource);

        return ResponseEntity.ok(dutyPresentationResource);
    }

    //  Display link to all privileges for current duty
    @GetMapping(&quot;/duties2/{id}&quot;)
    public ResponseEntity&lt;Resource&lt;DutyPresentation&gt;&gt; getDuties2(@PathVariable(&quot;id&quot;) long id)
    {
        Optional&lt;Duty&gt; dutyOptional = dutyRepository.findById(id);
        if(!dutyOptional.isPresent())
        {
            throwNotFoundException(id);
        }

        Duty duty = dutyOptional.get();
        DutyPresentation dutyPresentation = getDutyPresentation(duty);
        Resource&lt;DutyPresentation&gt; dutyPresentationResource = getDutyPresentationResource2(dutyPresentation);
        dutyPresentationResource.add(createAllPrivilegesLink(duty));

        addRuleLinksToDutyPresentationResource(id, dutyPresentationResource);

        return ResponseEntity.ok(dutyPresentationResource);
    }

    @PostMapping(&quot;/duties&quot;)
    public ResponseEntity&lt;?&gt; createDuty(@RequestBody Duty duty)
    {
        dutyRepository.save(duty);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .path(&quot;/{id}&quot;)
                .buildAndExpand(duty.getID()).toUri();

        return ResponseEntity.created(location).build();
    }

    @PutMapping(&quot;/duties/{id}&quot;)
    public ResponseEntity&lt;?&gt; updateDuty(@PathVariable(&quot;id&quot;) int id, @RequestBody Duty duty)
    {
        Optional&lt;Duty&gt; existingDutyOptional = dutyRepository.findById(id);
        if(!existingDutyOptional.isPresent())
        {
            throwNotFoundException(duty.getID());
        }

        Duty existingDuty = existingDutyOptional.get();
        //  Create data for audit record
        Duty auditDuty = new Duty(existingDuty);

        //  Modify existing record with new values
        if(StringUtils.hasText(duty.getDutyName()))
        {
            existingDuty.setDutyName(duty.getDutyName());
        }
        dutyRepository.save(existingDuty);


        //  Create Audit record
        dutyRepository.save(auditDuty);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand(existingDuty).toUri();

        return ResponseEntity.created(location).build();
    }

    @DeleteMapping(&quot;/duties/{id}&quot;)
    public ResponseEntity&lt;?&gt; deleteDuty(@PathVariable(&quot;id&quot;) int id)
    {
        List&lt;DutyRulePair&gt; dutyRulePairs = dutyRuleMapRepository.findByDutyId(id);
        if(!dutyRulePairs.isEmpty())
        {
            throw new RuleViolationException(&quot;mapping to rules exists for dutyId-&quot; + id);
        }

        List&lt;DutyPrivilegePair&gt; dutyPrivilegePairs = dutyPrivilegeMapRepository.findByDutyId(id);
        if(!dutyPrivilegePairs.isEmpty())
        {
            throw new RuleViolationException(&quot;mapping to privileges exists for dutyId-&quot; + id);
        }

        Optional&lt;Duty&gt; existingDutyOptional = dutyRepository.findById(id);
        if(!existingDutyOptional.isPresent())
        {
            throwNotFoundException(id);
        }

        Duty duty = existingDutyOptional.get();
        duty.setOutUtc(ZonedDateTime.now());
        dutyRepository.save(duty);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand().toUri();

        return ResponseEntity.created(location).build();
    }


    private Resource&lt;DutyPresentation&gt; getDutyPresentationResource(DutyPresentation dutyPrivilegePresentation)
    {
        Resource&lt;DutyPresentation&gt; resource = new Resource&lt;&gt;(dutyPrivilegePresentation);
        ControllerLinkBuilder link = linkTo(methodOn(getClass()).getDuties());
        resource.add(link.withRel(&quot;all&quot;));
        return resource;
    }

    private Resource&lt;DutyPresentation&gt; getDutyPresentationResource2(DutyPresentation dutyPrivilegePresentation)
    {
        Resource&lt;DutyPresentation&gt; resource = new Resource&lt;&gt;(dutyPrivilegePresentation);
        ControllerLinkBuilder link = linkTo(methodOn(getClass()).getDuties2());
        resource.add(link.withRel(&quot;all&quot;));
        return resource;
    }


    private DutyPresentation getDutyPresentation(Duty duty)
    {
        DutyPresentation dutyPresentation = new DutyPresentation(duty);
        dutyPresentation.add(linkTo(methodOn(getClass()).getDuties(duty.getID())).withSelfRel());
        return dutyPresentation;
    }


    private DutyPresentation getDutyPresentationWithPrivileges(Duty duty)
    {
        DutyPresentation dutyPresentation = getDutyPresentation(duty);
        dutyPresentation.setPrivileges(getDutyPrivileges(duty.getID()));
        return dutyPresentation;
    }


    private List&lt;Privilege&gt; getDutyPrivileges(long dutyId)
    {
        List&lt;Privilege&gt; privileges = new ArrayList&lt;&gt;();

        List&lt;DutyPrivilegePair&gt; dutyPrivilegePairs = dutyPrivilegeMapRepository.findByDutyId(dutyId);
        for(DutyPrivilegePair dutyPrivilegePair : dutyPrivilegePairs)
        {
            long privilegeId = dutyPrivilegePair.getPrivilege().getID();
            Optional&lt;Privilege&gt; privilegeOptional = privilegeRepository.findById(privilegeId);
            if(!privilegeOptional.isPresent())
            {
                throw new NotFoundException(&quot;Privilege ID not found: id=&quot; + privilegeId);
            }
            privileges.add(privilegeOptional.get());
        }
        return privileges;
    }


    private void addRuleLinksToDutyPresentationResource(long dutyId, Resource&lt;DutyPresentation&gt; dutyPresentationResource)
    {
        List&lt;DutyRulePair&gt; dutyRulePairList = dutyRuleMapRepository.findByDutyId(dutyId);
        for(DutyRulePair dutyRulePair : dutyRulePairList)
        {
            Rule rule = dutyRulePair.getRule();
            dutyPresentationResource.add(createRuleLink(rule));
        }
    }

    //  Helper Methods
    private Link createRuleLink(Rule rule)
    {
        return linkTo(methodOn(RuleController.class).getRules(rule.getID())).withRel(&quot;rule&quot;).withTitle(rule.getRuleName());
    }

    private Link createAllPrivilegesLink(Duty duty)
    {
        return linkTo(methodOn(DutyPrivilegeController.class).getPrivilegesForDuty(duty.getID())).withRel(&quot;all-privileges&quot;);
    }

    private Link createSelfLink(long dutyId)
    {
        return linkTo(methodOn(getClass()).getDuties(dutyId)).withRel(&quot;self&quot;);
    }

    private Link createSelfLink2(long dutyId)
    {
        return linkTo(methodOn(getClass()).getDuties2(dutyId)).withRel(&quot;self&quot;);
    }

    private void throwNotFoundException(long dutyId)
    {
        throw new NotFoundException(&quot;duty-&quot; + dutyId);
    }

}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Transactional
@RestController
@RepositoryRestController
public class DutyPrivilegeController
{
    @Autowired
    private DutyPrivilegeMapRepository dutyPrivilegeMapRepository;
    @Autowired
    private DutyController dutyController;
    @Autowired
    private PrivilegeController privilegeController;

    //  -------------------------------------------
    //  ------------ Duties With Privileges ------------
    //  -------------------------------------------
    @GetMapping(&quot;/duties/privileges&quot;)
    public ResponseEntity&lt;Resources&lt;Resource&lt;DutyPresentation&gt;&gt;&gt; getDutiesPrivileges()
    {
        List&lt;Resource&lt;DutyPresentation&gt;&gt; resourceResult = new ArrayList&lt;&gt;();

        ResponseEntity&lt;Resources&lt;DutyPresentation&gt;&gt; dutyPresentationResources = dutyController.getDutyPresentationResourceInternal();
        Map&lt;Long, List&lt;DutyPresentation&gt;&gt; dutyPresentationResourcesMap = dutyPresentationResources.getBody().getContent().stream()
                .collect(Collectors.groupingBy(DutyPresentation::getDutyID));

        List&lt;DutyPrivilegePair&gt; dutyPrivilegePairList = dutyPrivilegeMapRepository.findAll();
        Map&lt;Duty, List&lt;Privilege&gt;&gt; groupedDuties = dutyPrivilegePairList.stream()
                .collect(Collectors
                        .groupingBy(d -&gt; d.getDuty(), Collectors.mapping(DutyPrivilegePair::getPrivilege, Collectors.toList())));

        for(Map.Entry&lt;Duty, List&lt;Privilege&gt;&gt; e : groupedDuties.entrySet())
        {
            Duty duty = e.getKey();
            List&lt;DutyPresentation&gt; dutyPresentations = dutyPresentationResourcesMap.get(duty.getID());
            if(!dutyPresentations.isEmpty())
            {
                DutyPresentation dutyPresentation = dutyPresentations.get(0);
                Resource&lt;DutyPresentation&gt; dutyResource = new Resource&lt;&gt;(dutyPresentation, createDutyLink(duty));
                dutyResource.add(createPrivilegesForDutyLink(duty.getID()));
                for(Privilege privilege : e.getValue())
                {
                    dutyResource.add(createPrivilegeLink(privilege));
                }
                resourceResult.add(dutyResource);
            }
        }

        Resources&lt;Resource&lt;DutyPresentation&gt;&gt; resources = new Resources&lt;&gt;(resourceResult, linkTo(methodOn(getClass()).getDutiesPrivileges()).withSelfRel());
        return ResponseEntity.ok(resources);
    }


    @GetMapping(&quot;/duties/{id}/privileges&quot;)
    public  ResponseEntity&lt;Resource&lt;DutyPresentation&gt;&gt;  getPrivilegesForDuty(@PathVariable(&quot;id&quot;) long id)
    {
        List&lt;DutyPrivilegePair&gt; dutyPrivilegePairList = dutyPrivilegeMapRepository.findByDutyId(id);

        if(dutyPrivilegePairList.isEmpty())
        {
            throw new NotFoundException(&quot;dutyId-&quot; + id);
        }

        Duty duty = dutyPrivilegePairList.get(0).getDuty();

        ResponseEntity&lt;Resource&lt;DutyPresentation&gt;&gt; dutyPresentationResource = dutyController.getDuties(duty.getID());
        DutyPresentation dutyPresentation = dutyPresentationResource.getBody().getContent();

        Resource&lt;DutyPresentation&gt; dutyResource = new Resource&lt;&gt;(dutyPresentation, createDutyLink(duty));

        List&lt;Privilege&gt; privileges = dutyPrivilegePairList.stream().map(e -&gt; e.getPrivilege()).collect(Collectors.toList());

        for(Privilege privilege : privileges)
        {
            dutyResource.add(createPrivilegeLink(privilege));
        }
        dutyResource.add(linkTo(methodOn(getClass()).getPrivilegesForDuty(id)).withSelfRel());
        return ResponseEntity.ok(dutyResource);
    }


    //  -------------------------------------------
    //  ------------ Privileges With Duties ------------
    //  -------------------------------------------
    @GetMapping(&quot;/privileges/duties&quot;)
    public ResponseEntity&lt;Resources&lt;Resource&lt;PrivilegePresentation&gt;&gt;&gt; getPrivilegesDuties()
    {
        List&lt;Resource&lt;PrivilegePresentation&gt;&gt; resourceResult = new ArrayList&lt;&gt;();

        ResponseEntity&lt;Resources&lt;PrivilegePresentation&gt;&gt; privilegePresentationResources = privilegeController.getPrivileges();
        Map&lt;Long, List&lt;PrivilegePresentation&gt;&gt; privilegePresentationResourcesMap = privilegePresentationResources.getBody().getContent().stream()
                .collect(Collectors.groupingBy(PrivilegePresentation::getID));

        List&lt;DutyPrivilegePair&gt; dutyPrivilegePairList = dutyPrivilegeMapRepository.findAll();
        Map&lt;Privilege, List&lt;Duty&gt;&gt; groupedPrivileges = dutyPrivilegePairList.stream()
                .collect(Collectors
                        .groupingBy(d -&gt; d.getPrivilege(), Collectors.mapping(DutyPrivilegePair::getDuty, Collectors.toList())));

        for(Map.Entry&lt;Privilege, List&lt;Duty&gt;&gt; e : groupedPrivileges.entrySet())
        {
            Privilege privilege = e.getKey();
            List&lt;PrivilegePresentation&gt; privilegePresentations = privilegePresentationResourcesMap.get(privilege.getID());
            if(!privilegePresentations.isEmpty())
            {
                PrivilegePresentation privilegePresentation = privilegePresentations.get(0);
                Resource&lt;PrivilegePresentation&gt; privilegeResource = new Resource&lt;&gt;(privilegePresentation, createPrivilegeLink(privilege));
                privilegeResource.add(createDutiesForPrivilegeLink(privilege.getID()));
                for(Duty duty : e.getValue())
                {
                    privilegeResource.add(createDutyLink(duty));
                }
                resourceResult.add(privilegeResource);
            }
        }

        Resources&lt;Resource&lt;PrivilegePresentation&gt;&gt; resources = new Resources&lt;&gt;(resourceResult, linkTo(methodOn(getClass()).getPrivilegesDuties()).withSelfRel());
        return ResponseEntity.ok(resources);
    }



    @GetMapping(&quot;/privileges/{id}/duties&quot;)
    public  ResponseEntity&lt;Resource&lt;PrivilegePresentation&gt;&gt;  getDutiesForPrivilege(@PathVariable(&quot;id&quot;) long id)
    {
        List&lt;DutyPrivilegePair&gt; dutyPrivilegePairList = dutyPrivilegeMapRepository.findByPrivilegeId(id);

        if(dutyPrivilegePairList.isEmpty())
        {
            throw new NotFoundException(&quot;privilegeId-&quot; + id);
        }

        Privilege privilege = dutyPrivilegePairList.get(0).getPrivilege();

        ResponseEntity&lt;Resource&lt;PrivilegePresentation&gt;&gt; privilegePresentationResource = privilegeController.getPrivilegesById(privilege.getID());
        PrivilegePresentation privilegePresentation = privilegePresentationResource.getBody().getContent();

        Resource&lt;PrivilegePresentation&gt; privilegeResource = new Resource&lt;&gt;(privilegePresentation, createPrivilegeLink(privilege));

        List&lt;Duty&gt; duties = dutyPrivilegePairList.stream().map(e -&gt; e.getDuty()).collect(Collectors.toList());

        for(Duty duty : duties)
        {
            privilegeResource.add(createDutyLink(duty));
        }
        privilegeResource.add(linkTo(methodOn(getClass()).getDutiesForPrivilege(id)).withSelfRel());
        return ResponseEntity.ok(privilegeResource);
    }


    //  Helper methods
    private Link createDutyLink(Duty duty)
    {
        return linkTo(methodOn(DutyController.class).getDuties(duty.getID())).withRel(&quot;duty&quot;).withTitle(duty.getDutyName());
    }

    private Link createPrivilegeLink(Privilege privilege)
    {
        return linkTo(methodOn(PrivilegeController.class).getPrivilegesById(privilege.getID())).withRel(&quot;privilege&quot;).withTitle(privilege.getPrivilegeName());
    }

    private Link createPrivilegesForDutyLink(long dutyId)
    {
        return linkTo(methodOn(getClass()).getPrivilegesForDuty(dutyId)).withSelfRel();
    }

    private Link createDutiesForPrivilegeLink(long privilegeId)
    {
        return linkTo(methodOn(getClass()).getDutiesForPrivilege(privilegeId)).withSelfRel();
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Transactional
@RestController
@RepositoryRestController
public class DutyRuleController
{
    @Autowired
    private DutyRuleMapRepository dutyRuleMapRepository;
    @Autowired
    private RuleRepository ruleRepository;
    @Autowired
    private DutyRepository dutyRepository;
    @Autowired
    private DutyController dutyController;
    @Autowired
    private RuleController ruleController;


    //  -------------------------------------------
    //  ------------ Duties With Rules ------------
    //  -------------------------------------------
    @GetMapping(&quot;/duties/rules&quot;)
    public ResponseEntity&lt;Resources&lt;Resource&lt;DutyPresentation&gt;&gt;&gt; getDutiesRules()
    {
        List&lt;Resource&lt;DutyPresentation&gt;&gt; resourceResult = new ArrayList&lt;&gt;();

        ResponseEntity&lt;Resources&lt;DutyPresentation&gt;&gt; dutyPresentationResources = dutyController.getDutyPresentationResourceInternal();
        Map&lt;Long, List&lt;DutyPresentation&gt;&gt; dutyPresentationResourcesMap = dutyPresentationResources.getBody().getContent().stream()
                .collect(Collectors.groupingBy(DutyPresentation::getDutyID));

        List&lt;DutyRulePair&gt; dutyRulePairList = dutyRuleMapRepository.findAll();
        Map&lt;Duty, List&lt;Rule&gt;&gt; groupedDuties = dutyRulePairList.stream()
                .collect(Collectors
                        .groupingBy(d -&gt; d.getDuty(), Collectors.mapping(DutyRulePair::getRule, Collectors.toList())));

        for(Map.Entry&lt;Duty, List&lt;Rule&gt;&gt; e : groupedDuties.entrySet())
        {
            Duty duty = e.getKey();
            List&lt;DutyPresentation&gt; dutyPresentations = dutyPresentationResourcesMap.get(duty.getID());
            if(!dutyPresentations.isEmpty())
            {
                DutyPresentation dutyPresentation = dutyPresentations.get(0);
                Resource&lt;DutyPresentation&gt; dutyResource = new Resource&lt;&gt;(dutyPresentation, createDutyLink(duty));
                dutyResource.add(createRulesForDutyLink(duty.getID()));
                for(Rule rule : e.getValue())
                {
                    dutyResource.add(createRuleLink(rule));
                }
                resourceResult.add(dutyResource);
            }
        }

        Resources&lt;Resource&lt;DutyPresentation&gt;&gt; resources = new Resources&lt;&gt;(resourceResult, linkTo(methodOn(getClass()).getDutiesRules()).withSelfRel());
        return ResponseEntity.ok(resources);
    }


    @GetMapping(&quot;/duties/{id}/rules&quot;)
    public  ResponseEntity&lt;Resource&lt;DutyPresentation&gt;&gt;  getRulesForDuty(@PathVariable(&quot;id&quot;) long id)
    {
        List&lt;DutyRulePair&gt; dutyRulePairList = dutyRuleMapRepository.findByDutyId(id);

        if(dutyRulePairList.isEmpty())
        {
            throw new NotFoundException(&quot;dutyId-&quot; + id);
        }

        Duty duty = dutyRulePairList.get(0).getDuty();

        ResponseEntity&lt;Resource&lt;DutyPresentation&gt;&gt; dutyPresentationResource = dutyController.getDuties(duty.getID());
        DutyPresentation dutyPrivilegePresentation = dutyPresentationResource.getBody().getContent();

        Resource&lt;DutyPresentation&gt; dutyResource = new Resource&lt;&gt;(dutyPrivilegePresentation, createDutyLink(duty));

        List&lt;Rule&gt; rules = dutyRulePairList.stream().map(e -&gt; e.getRule()).collect(Collectors.toList());

        for(Rule rule : rules)
        {
            dutyResource.add(createRuleLink(rule));
        }
        dutyResource.add(linkTo(methodOn(getClass()).getRulesForDuty(id)).withSelfRel());
        return ResponseEntity.ok(dutyResource);
    }

    @PostMapping(&quot;/duties/{dutyId}/rules/{ruleId}&quot;)
    public ResponseEntity&lt;?&gt; addRuleToDuty(@PathVariable(&quot;dutyId&quot;) int dutyId, @PathVariable(&quot;ruleId&quot;) int ruleId)
    {
        //  Check if the association was previously deleted
        List&lt;DutyRulePair&gt; dutyRulePairList = dutyRuleMapRepository.findHistoryByRuleDutyId(ruleId, dutyId);
        if(!dutyRulePairList.isEmpty())
        {
            Optional&lt;DutyRulePair&gt; dutyRulePairOptional = dutyRulePairList.stream()
                    .sorted((m1, m2) -&gt; Long.compare(m2.getOutUtc().toInstant().toEpochMilli(), m1.getOutUtc().toInstant().toEpochMilli()))
                    .findFirst();

            if(dutyRulePairOptional.isPresent())
            {
                DutyRulePair dutyRulePairHistorical = dutyRulePairOptional.get();

                DutyRulePair dutyRulePair = new DutyRulePair(dutyRulePairHistorical.getDuty(), dutyRulePairHistorical.getRule());

                dutyRuleMapRepository.save(dutyRulePair);

                URI location = ServletUriComponentsBuilder
                        .fromCurrentRequest()
                        .buildAndExpand(dutyRulePair.getDuty().getID(), dutyRulePair.getRule().getID())
                        .toUri();
                return ResponseEntity.created(location).build();
            }
            return ResponseEntity.unprocessableEntity().build();
        }
        else
        {
            Optional&lt;Rule&gt; ruleOptional = ruleRepository.findById(ruleId);
            if (!ruleOptional.isPresent())
            {
                throw new NotFoundException(&quot;rule-&quot; + ruleId);
            }
            Optional&lt;Duty&gt; dutyOptional = dutyRepository.findById(dutyId);
            if (!dutyOptional.isPresent())
            {
                throw new NotFoundException(&quot;duty-&quot; + dutyId);
            }

            Duty duty = dutyOptional.get();
            Rule rule = ruleOptional.get();

            List&lt;Rule&gt; rules = duty.getDutyRulePairs().stream().map(e -&gt; e.getRule()).collect(Collectors.toList());
            if (!rules.contains(rule))
            {
                DutyRulePair dutyRulePair = new DutyRulePair(duty, rule);
                duty.addDutyRuleMap(dutyRulePair);

                dutyRuleMapRepository.save(dutyRulePair);

                URI location = ServletUriComponentsBuilder
                        .fromCurrentRequest()
                        .buildAndExpand(duty.getID(), rule.getID())
                        .toUri();
                return ResponseEntity.created(location).build();
            }
            return ResponseEntity.unprocessableEntity().build();
        }
    }

    @DeleteMapping(&quot;/duties/{dutyId}/rules/{ruleId}&quot;)
    public ResponseEntity&lt;?&gt; deleteRuleFromDuty(@PathVariable(&quot;dutyId&quot;) int dutyId, @PathVariable(&quot;ruleId&quot;) int ruleId)
    {
        Optional&lt;DutyRulePair&gt; dutyRulePairOptional = dutyRuleMapRepository.findByRuleDutyId(ruleId, dutyId);
        if(!dutyRulePairOptional.isPresent())
        {
            throw new NotFoundException(&quot;ruleId-&quot; + ruleId + &quot;, dutyId-&quot; + dutyId);
        }

        Optional&lt;Rule&gt; ruleOptional = ruleRepository.findById(ruleId);
        Optional&lt;Duty&gt; dutyOptional = dutyRepository.findById(dutyId);

        if(!ruleOptional.isPresent())
        {
            throw new NotFoundException(&quot;ruleId-&quot; + ruleId);
        }
        if(!dutyOptional.isPresent())
        {
            throw new NotFoundException(&quot;dutyId-&quot; + dutyId);
        }

        Duty duty = dutyOptional.get();
        DutyRulePair dutyRulePair = dutyRulePairOptional.get();
        duty.removeDutyRuleMap(dutyRulePair);

        dutyRulePair.setOutUtc(ZonedDateTime.now());
        dutyRuleMapRepository.save(dutyRulePair);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand(dutyRulePair).toUri();

        return ResponseEntity.created(location).build();
    }

    //  -------------------------------------------
    //  ------------ Rules With Duties ------------
    //  -------------------------------------------
     @GetMapping(&quot;/rules/duties&quot;)
    public ResponseEntity&lt;Resources&lt;Resource&lt;RulePresentation&gt;&gt;&gt; getRulesDuties()
    {
        List&lt;Resource&lt;RulePresentation&gt;&gt; resourceResult = new ArrayList&lt;&gt;();

        ResponseEntity&lt;Resources&lt;RulePresentation&gt;&gt; rulePresentationResources = ruleController.getRulePresentationResourceInternal();

        Map&lt;Long, List&lt;RulePresentation&gt;&gt; rulePresentationResourcesMap = rulePresentationResources.getBody().getContent().stream()
                .collect(Collectors.groupingBy(RulePresentation::getID));

        List&lt;DutyRulePair&gt; dutyRulePairList = dutyRuleMapRepository.findAll();
        Map&lt;Rule, List&lt;Duty&gt;&gt; groupedRules = dutyRulePairList.stream()
                .collect(Collectors
                        .groupingBy(d -&gt; d.getRule(), Collectors.mapping(DutyRulePair::getDuty, Collectors.toList())));

        for(Map.Entry&lt;Rule, List&lt;Duty&gt;&gt; e : groupedRules.entrySet())
        {
            Rule rule = e.getKey();
            List&lt;RulePresentation&gt; rulePresentations = rulePresentationResourcesMap.get(rule.getID());
            if(!rulePresentations.isEmpty())
            {
                RulePresentation rulePresentation = rulePresentations.get(0);
                Resource&lt;RulePresentation&gt; ruleResource = new Resource&lt;&gt;(rulePresentation, createRuleLink(rule));
                ruleResource.add(createDutiesForRuleLink(rule.getID()));
                for(Duty duty : e.getValue())
                {
                    ruleResource.add(createDutyLink(duty));
                }
                resourceResult.add(ruleResource);           }
        }

        Resources&lt;Resource&lt;RulePresentation&gt;&gt; resources = new Resources&lt;&gt;(resourceResult, linkTo(methodOn(getClass()).getRulesDuties()).withSelfRel());
        return ResponseEntity.ok(resources);
    }


    @GetMapping(&quot;/rules/{id}/duties&quot;)
    public  ResponseEntity&lt;Resource&lt;RulePresentation&gt;&gt;  getDutiesForRule(@PathVariable(&quot;id&quot;) long id)
    {
        List&lt;DutyRulePair&gt; dutyRulePairList = dutyRuleMapRepository.findByRuleId(id);

        if(dutyRulePairList.isEmpty())
        {
            throw new NotFoundException(&quot;ruleId-&quot; + id);
        }

        Rule rule = dutyRulePairList.get(0).getRule();

        ResponseEntity&lt;Resource&lt;RulePresentation&gt;&gt; rulePresentationResource = ruleController.getRules(rule.getID());
        RulePresentation rulePresentation = rulePresentationResource.getBody().getContent();

        Resource&lt;RulePresentation&gt; ruleResource = new Resource&lt;&gt;(rulePresentation, createRuleLink(rule));

        List&lt;Duty&gt; duties = dutyRulePairList.stream().map(e -&gt; e.getDuty()).collect(Collectors.toList());

        for(Duty duty : duties)
        {
            ruleResource.add(createDutyLink(duty));
        }
        ruleResource.add(linkTo(methodOn(getClass()).getDutiesForRule(id)).withSelfRel());
        return ResponseEntity.ok(ruleResource);
    }


    @PostMapping(&quot;/rules/{ruleId}/duties/{dutyId}&quot;)
    public ResponseEntity&lt;?&gt; addDutyToRule(@PathVariable(&quot;ruleId&quot;) int ruleId, @PathVariable(&quot;dutyId&quot;) long dutyId)
    {
        //  Check if the association was previously deleted
        List&lt;DutyRulePair&gt; dutyRulePairList = dutyRuleMapRepository.findHistoryByRuleDutyId(ruleId, dutyId);
        if(!dutyRulePairList.isEmpty())
        {
            Optional&lt;DutyRulePair&gt; dutyRulePairOptional = dutyRulePairList.stream()
                    .sorted((m1, m2) -&gt; Long.compare(m2.getOutUtc().toInstant().toEpochMilli(),m1.getOutUtc().toInstant().toEpochMilli()))
                    .findFirst();

            if(dutyRulePairOptional.isPresent())
            {
                DutyRulePair dutyRulePairHistorical = dutyRulePairOptional.get();

                DutyRulePair dutyRulePair = new DutyRulePair(dutyRulePairHistorical.getDuty(), dutyRulePairHistorical.getRule());

                dutyRuleMapRepository.save(dutyRulePair);

                URI location = ServletUriComponentsBuilder
                        .fromCurrentRequest()
                        .buildAndExpand(dutyRulePair.getRule().getID(), dutyRulePair.getDuty().getID())
                        .toUri();
                return ResponseEntity.created(location).build();
            }
            return ResponseEntity.unprocessableEntity().build();
        }
        else
        {
            Optional&lt;Rule&gt; ruleOptional = ruleRepository.findById(ruleId);
            if(!ruleOptional.isPresent())
            {
                throw new NotFoundException(&quot;rule-&quot; + ruleId);
            }
            Optional&lt;Duty&gt; dutyOptional = dutyRepository.findById(dutyId);
            if(!dutyOptional.isPresent())
            {
                throw new NotFoundException(&quot;duty-&quot; + dutyId);
            }

            Duty duty = dutyOptional.get();
            Rule rule = ruleOptional.get();

            List&lt;Duty&gt; duties = rule.getDutyRulePairs().stream().map(e -&gt; e.getDuty()).collect(Collectors.toList());
            if(!duties.contains(duty))
            {
                DutyRulePair dutyRulePair = new DutyRulePair(duty, rule);
                rule.addDutyRuleMap(dutyRulePair);

                dutyRuleMapRepository.save(dutyRulePair);

                URI location = ServletUriComponentsBuilder
                        .fromCurrentRequest()
                        .buildAndExpand(rule.getID(), duty.getID())
                        .toUri();
                return ResponseEntity.created(location).build();
            }

            return ResponseEntity.unprocessableEntity().build();
        }
    }

    @DeleteMapping(&quot;/rules/{ruleId}/duties/{dutyId}&quot;)
    public ResponseEntity&lt;?&gt; deleteDutyFromRule(@PathVariable(&quot;ruleId&quot;) int ruleId, @PathVariable(&quot;dutyId&quot;) int dutyId)
    {
        Optional&lt;DutyRulePair&gt; dutyRulePairOptional = dutyRuleMapRepository.findByRuleDutyId(ruleId, dutyId);
        if(!dutyRulePairOptional.isPresent())
        {
            throw new NotFoundException(&quot;ruleId-&quot; + ruleId + &quot;, dutyId-&quot; + dutyId);
        }

        Optional&lt;Rule&gt; ruleOptional = ruleRepository.findById(ruleId);
        Optional&lt;Duty&gt; dutyOptional = dutyRepository.findById(dutyId);

        if(!ruleOptional.isPresent())
        {
            throw new NotFoundException(&quot;ruleId-&quot; + ruleId);
        }
        if(!dutyOptional.isPresent())
        {
            throw new NotFoundException(&quot;dutyId-&quot; + dutyId);
        }

        Rule rule = ruleOptional.get();
        DutyRulePair dutyRulePair = dutyRulePairOptional.get();
        rule.removeDutyRuleMap(dutyRulePair);

        dutyRulePair.setOutUtc(ZonedDateTime.now());
        dutyRuleMapRepository.save(dutyRulePair);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand().toUri();

        return ResponseEntity.created(location).build();
    }
    //  Helper methods
    private Link createDutyLink(Duty duty)
    {
        return linkTo(methodOn(DutyController.class).getDuties(duty.getID())).withRel(&quot;duty&quot;).withTitle(duty.getDutyName());
    }

    private Link createRuleLink(Rule rule)
    {
        return linkTo(methodOn(RuleController.class).getRules(rule.getID())).withRel(&quot;rule&quot;).withTitle(rule.getRuleName());
    }

    private Link createRulesForDutyLink(long dutyId)
    {
        return linkTo(methodOn(getClass()).getRulesForDuty(dutyId)).withSelfRel();
    }

    private Link createDutiesForRuleLink(long ruleId)
    {
        return linkTo(methodOn(getClass()).getDutiesForRule(ruleId)).withSelfRel();
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Transactional
@RestController
@RepositoryRestController
public class PrivilegeController
{
    @Autowired
    private PrivilegeRepository privilegeRepository;

    @GetMapping(&quot;/privileges&quot;)
    public ResponseEntity&lt;Resources&lt;PrivilegePresentation&gt;&gt; getPrivileges()
    {
        List&lt;PrivilegePresentation&gt; privilegePresentations = new ArrayList&lt;&gt;();

        List&lt;Privilege&gt; privileges = privilegeRepository.findAll();
        for(Privilege privilege : privileges)
        {
            PrivilegePresentation privilegePresentation = getPrivilegePresentation(privilege.getID());
            privilegePresentations.add(privilegePresentation);
        }

        Resources&lt;PrivilegePresentation&gt; resources = new Resources&lt;&gt;(privilegePresentations);
        resources.add(linkTo(methodOn(getClass()).getPrivileges()).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    @GetMapping(&quot;/privileges/{id}&quot;)
    public ResponseEntity&lt;Resource&lt;PrivilegePresentation&gt;&gt; getPrivilegesById(@PathVariable(&quot;id&quot;) long id)
    {
        PrivilegePresentation privilegePresentation = getPrivilegePresentation(id);
        return ResponseEntity.ok(getPrivilegePresentationResource(privilegePresentation));
    }



    //  Note internal visibility
    PrivilegePresentation getPrivilegePresentation(long privilegeId)
    {
        Optional&lt;Privilege&gt; privilegeOptional = privilegeRepository.findById(privilegeId);
        if(!privilegeOptional.isPresent())
        {
            throw new NotFoundException(&quot;privilege-id&quot; + privilegeId);
        }

        Privilege privilege = privilegeOptional.get();
        PrivilegePresentation privilegePresentation = new PrivilegePresentation(privilege);

        return privilegePresentation;
    }

    private Resource&lt;PrivilegePresentation&gt; getPrivilegePresentationResource(PrivilegePresentation privilegePresentation)
    {
        Resource&lt;PrivilegePresentation&gt; resource = new Resource&lt;&gt;(privilegePresentation);
        ControllerLinkBuilder link = linkTo(methodOn(getClass()).getPrivileges());
        resource.add(link.withRel(&quot;all&quot;));
        return resource;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Transactional
@RestController
@RepositoryRestController
public class RuleController
{
    @Autowired
    private RuleRepository ruleRepository;
    @Autowired
    private DutyRuleMapRepository dutyRuleMapRepository;

    @GetMapping(&quot;/rules&quot;)
    public ResponseEntity&lt;Resources&lt;Resource&lt;RulePresentation&gt;&gt;&gt; getRules()
    {
        List&lt;Resource&lt;RulePresentation&gt;&gt; resourceResult = new ArrayList&lt;&gt;();

        List&lt;Rule&gt; rules = ruleRepository.findAll();
        for(Rule rule : rules)
        {
            RulePresentation rulePresentation = getRulePresentation(rule.getID());
            Resource&lt;RulePresentation&gt; rulePresentationResource = new Resource&lt;&gt;(rulePresentation, createSelfLink(rule.getID()));

            addLinksToRulePresentationResource(rule.getID(), rulePresentationResource);

            resourceResult.add(rulePresentationResource);
        }
        Resources&lt;Resource&lt;RulePresentation&gt;&gt; resources = new Resources&lt;&gt;(resourceResult);
        resources.add(linkTo(methodOn(getClass()).getRules()).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    // Note package visibility
    ResponseEntity&lt;Resources&lt;RulePresentation&gt;&gt; getRulePresentationResourceInternal()
    {
        List&lt;RulePresentation&gt; rulePresentations = new ArrayList&lt;&gt;();

        List&lt;Rule&gt; rules = ruleRepository.findAll();
        for(Rule rule : rules)
        {
            RulePresentation rulePresentation = getRulePresentation(rule.getID());
            rulePresentations.add(rulePresentation);
        }
        Resources&lt;RulePresentation&gt; resources = new Resources&lt;&gt;(rulePresentations);
        resources.add(linkTo(methodOn(getClass()).getRules()).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    @GetMapping(&quot;/rules/{id}&quot;)
    public ResponseEntity&lt;Resource&lt;RulePresentation&gt;&gt; getRules(@PathVariable(&quot;id&quot;) long id)
    {
        RulePresentation rulePresentation = getRulePresentation(id);
        Resource&lt;RulePresentation&gt; rulePresentationResource = getRulePresentationResource(rulePresentation);

        addLinksToRulePresentationResource(id, rulePresentationResource);

        return ResponseEntity.ok(rulePresentationResource);
    }

    private RulePresentation getRulePresentation(long ruleId)
    {
        Optional&lt;Rule&gt; ruleOptional = ruleRepository.findById(ruleId);
        if (!ruleOptional.isPresent())
        {
            throw new NotFoundException(&quot;rule-id&quot; + ruleId);
        }
        Rule rule = ruleOptional.get();
        RulePresentation rulePresentation = new RulePresentation(rule);
        rulePresentation.add(linkTo(methodOn(getClass()).getRules(ruleId)).withSelfRel());
        return rulePresentation;
    }

    private Resource&lt;RulePresentation&gt; getRulePresentationResource(RulePresentation rulePresentation)
    {
        Resource&lt;RulePresentation&gt; resource = new Resource&lt;&gt;(rulePresentation);
        ControllerLinkBuilder link = linkTo(methodOn(getClass()).getRules());
        resource.add(link.withRel(&quot;all&quot;));
        return resource;
    }

    private void addLinksToRulePresentationResource(long ruleId, Resource&lt;RulePresentation&gt; rulePresentationResource)
    {
        List&lt;DutyRulePair&gt; dutyRulePairList = dutyRuleMapRepository.findByRuleId(ruleId);
        for(DutyRulePair dutyRulePair : dutyRulePairList)
        {
            Duty duty = dutyRulePair.getDuty();
            rulePresentationResource.add(createDutyLink(duty));
        }
    }


    //  Helper Methods
    private Link createDutyLink(Duty duty)
    {
        return linkTo(methodOn(DutyController.class).getDuties(duty.getID())).withRel(&quot;duty&quot;).withTitle(duty.getDutyName());
    }

    private Link createSelfLink(long ruleId)
    {
        return linkTo(methodOn(getClass()).getRules(ruleId)).withRel(&quot;self&quot;);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Transactional
@RestController
@RepositoryRestController
public class UserController
{
    @Autowired
    private UserRepository userRepository;
    @Autowired
    private UserPrivilegeMapRepository userPrivilegeMapRepository;
    @Autowired
    private PrivilegeRepository privilegeRepository;

    @GetMapping(&quot;/users&quot;)
    public ResponseEntity&lt;Resources&lt;UserPrivilegesPresentation&gt;&gt; getUsers()
    {
        List&lt;UserPrivilegesPresentation&gt; userPrivilegesPresentations = new ArrayList&lt;&gt;();

        List&lt;User&gt; users = userRepository.findAll();
        for(User user : users)
        {
            UserPrivilegesPresentation userPrivilegesPresentation = getUserPresentation(user.getID());
            userPrivilegesPresentations.add(userPrivilegesPresentation);
        }

        Resources&lt;UserPrivilegesPresentation&gt; resources = new Resources&lt;&gt;(userPrivilegesPresentations);
        resources.add(linkTo(methodOn(getClass()).getUsers()).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    @GetMapping(&quot;/users/{id}&quot;)
    public ResponseEntity&lt;Resource&lt;UserPrivilegesPresentation&gt;&gt; getUsers(@PathVariable(&quot;id&quot;) long id)
    {
        UserPrivilegesPresentation userPrivilegesPresentation = getUserPresentation(id);
        return ResponseEntity.ok(getUserPresentationResource(userPrivilegesPresentation));
    }

    private UserPrivilegesPresentation getUserPresentation(long userId)
    {
        Optional&lt;User&gt; userOptional = userRepository.findById(userId);
        if(!userOptional.isPresent())
        {
            throw new NotFoundException(&quot;user-id&quot; + userId);
        }

        User user = userOptional.get();
        UserPrivilegesPresentation userPrivilegesPresentation = new UserPrivilegesPresentation(user, getUserPrivileges(user.getID()));
        userPrivilegesPresentation.add(linkTo(methodOn(getClass()).getUsers(userId)).withSelfRel());

        return userPrivilegesPresentation;
    }

    private List&lt;Privilege&gt; getUserPrivileges(long userId)
    {
        List&lt;Privilege&gt; privileges = new ArrayList&lt;&gt;();

        List&lt;UserPrivilegePair&gt; userPrivilegePairs = userPrivilegeMapRepository.findByUserId(userId);
        for(UserPrivilegePair userPrivilegePair : userPrivilegePairs)
        {
            long privilegeId = userPrivilegePair.getPrivilege().getID();
            Optional&lt;Privilege&gt; privilegeOptional = privilegeRepository.findById(privilegeId);
            if(!privilegeOptional.isPresent())
            {
                throw new NotFoundException(&quot;Privilege ID not found: id=&quot; + privilegeId);
            }
            privileges.add(privilegeOptional.get());
        }
        return privileges;
    }

    private Resource&lt;UserPrivilegesPresentation&gt; getUserPresentationResource(UserPrivilegesPresentation userPrivilegesPresentation)
    {
        Resource&lt;UserPrivilegesPresentation&gt; resource = new Resource&lt;&gt;(userPrivilegesPresentation);
        ControllerLinkBuilder link = linkTo(methodOn(getClass()).getUsers());
        resource.add(link.withRel(&quot;all&quot;));
        return resource;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Transactional
@RestController
@RepositoryRestController
public class UserPrivilegeController
{
    @Autowired
    private UserPrivilegeMapRepository userPrivilegeMapRepository;
    @Autowired
    private UserController userController;
    @Autowired
    private PrivilegeController privilegeController;
    @Autowired
    private UserRepository userRepository;
    @Autowired
    private DutyPrivilegeMapRepository dutyPrivilegeMapRepository;
    @Autowired
    private DutyRuleMapRepository dutyRuleMapRepository;
    //  -------------------------------------------
    //  ---------- Users With Privileges ----------
    //  -------------------------------------------
    @GetMapping(&quot;/users/privileges&quot;)
    public ResponseEntity&lt;Resources&lt;Resource&lt;UserPrivilegesPresentation&gt;&gt;&gt; getUsersPrivileges()
    {
        List&lt;Resource&lt;UserPrivilegesPresentation&gt;&gt; resourceResult = new ArrayList&lt;&gt;();

        ResponseEntity&lt;Resources&lt;UserPrivilegesPresentation&gt;&gt; userPresentationResources = userController.getUsers();
        Map&lt;Long, List&lt;UserPrivilegesPresentation&gt;&gt; userPresentationResourcesMap = userPresentationResources.getBody().getContent().stream()
                .collect(Collectors.groupingBy(UserPrivilegesPresentation::getID));

        List&lt;UserPrivilegePair&gt; userPrivilegePairList = userPrivilegeMapRepository.findAll();
        Map&lt;User, List&lt;Privilege&gt;&gt; groupedUsers = userPrivilegePairList.stream()
                .collect(Collectors
                        .groupingBy(u -&gt; u.getUser(), Collectors.mapping(UserPrivilegePair::getPrivilege, Collectors.toList())));

        for(Map.Entry&lt;User, List&lt;Privilege&gt;&gt; e : groupedUsers.entrySet())
        {
            User user = e.getKey();
            List&lt;UserPrivilegesPresentation&gt; userPrivilegesPresentations = userPresentationResourcesMap.get(user.getID());
            if(!userPrivilegesPresentations.isEmpty())
            {
                UserPrivilegesPresentation userPrivilegesPresentation = userPrivilegesPresentations.get(0);
                Resource&lt;UserPrivilegesPresentation&gt; userResource = new Resource&lt;&gt;(userPrivilegesPresentation, createUserLink(user));
                userResource.add(createPrivilegesForUserLink(user.getID()));
                for(Privilege privilege : e.getValue())
                {
                    userResource.add(createPrivilegeLink(privilege));
                }
                resourceResult.add(userResource);
            }
        }

        Resources&lt;Resource&lt;UserPrivilegesPresentation&gt;&gt; resources = new Resources&lt;&gt;(resourceResult, linkTo(methodOn(getClass()).getUsersPrivileges()).withSelfRel());
        return ResponseEntity.ok(resources);
    }


    @GetMapping(&quot;/users/{id}/privileges&quot;)
    public ResponseEntity&lt;Resource&lt;UserPrivilegesPresentation&gt;&gt;  getPrivilegesForUser(@PathVariable(&quot;id&quot;) long id)
    {
        List&lt;UserPrivilegePair&gt; userPrivilegePairList = userPrivilegeMapRepository.findByUserId(id);

        if(userPrivilegePairList.isEmpty())
        {
            throw new NotFoundException(&quot;userId-&quot; + id);
        }

        User user = userPrivilegePairList.get(0).getUser();

        ResponseEntity&lt;Resource&lt;UserPrivilegesPresentation&gt;&gt; userPresentationResource = userController.getUsers(user.getID());
        UserPrivilegesPresentation userPrivilegesPresentation = userPresentationResource.getBody().getContent();

        Resource&lt;UserPrivilegesPresentation&gt; userResource = new Resource&lt;&gt;(userPrivilegesPresentation, createUserLink(user));

        List&lt;Privilege&gt; privileges = userPrivilegePairList.stream().map(UserPrivilegePair::getPrivilege).collect(Collectors.toList());

        for(Privilege privilege : privileges)
        {
            userResource.add(createPrivilegeLink(privilege));
        }
        userResource.add(linkTo(methodOn(getClass()).getPrivilegesForUser(id)).withSelfRel());
        return ResponseEntity.ok(userResource);
    }





        @GetMapping(&quot;/users/duties&quot;)
    public ResponseEntity&lt;Resources&lt;Resource&lt;UserDutiesPresentation&gt;&gt;&gt; getUsersDuties()
    {
        Map&lt;User,Set&lt;Duty&gt;&gt; usersDutiesMap = new HashMap&lt;&gt;();
        //  Find privileges for each User
        Map&lt;User,List&lt;Privilege&gt;&gt; usersPrivilegesMap = userPrivilegeMapRepository.findAll().stream()
                .collect(Collectors.groupingBy(UserPrivilegePair::getUser, Collectors.mapping(UserPrivilegePair::getPrivilege, Collectors.toList())));

        for(Map.Entry&lt;User,List&lt;Privilege&gt;&gt; e : usersPrivilegesMap.entrySet())
        {
            for(Privilege privilege : e.getValue())
            {
                List&lt;DutyPrivilegePair&gt; dutyPrivilegePairs = dutyPrivilegeMapRepository.findByPrivilegeId(privilege.getID());
                Set&lt;Duty&gt; dutiesSet = dutyPrivilegePairs.stream().map(DutyPrivilegePair::getDuty).collect(Collectors.toSet());

                usersDutiesMap.computeIfAbsent(e.getKey(), a -&gt; new HashSet&lt;&gt;()).addAll(dutiesSet);
            }
        }

        List&lt;Resource&lt;UserDutiesPresentation&gt;&gt; resourceResult = new ArrayList&lt;&gt;();

        for(Map.Entry&lt;User, Set&lt;Duty&gt;&gt; e : usersDutiesMap.entrySet())
        {
            User user = e.getKey();
            UserDutiesPresentation userDutiesPresentation = new UserDutiesPresentation(user, e.getValue());
            Resource&lt;UserDutiesPresentation&gt; resource = new Resource&lt;&gt;(userDutiesPresentation, createUserLink(user));
            resource.add(createDutiesForUserLink(user.getID()));
            for(Duty duty : e.getValue())
            {
                resource.add(createDutyLink(duty));
            }
            resourceResult.add(resource);
        }

        Resources&lt;Resource&lt;UserDutiesPresentation&gt;&gt; resources = new Resources&lt;&gt;(resourceResult, linkTo(methodOn(getClass()).getUsersDuties()).withSelfRel());

        return ResponseEntity.ok(resources);
    }

    @GetMapping(&quot;/users/{id}/duties&quot;)
    public ResponseEntity&lt;Resource&lt;UserDutiesPresentation&gt;&gt; getDutiesForUser(@PathVariable(&quot;id&quot;) long id)
    {
        List&lt;UserPrivilegePair&gt; userPrivilegePairList = userPrivilegeMapRepository.findByUserId(id);

        if(userPrivilegePairList.isEmpty())
        {
            throw new NotFoundException(&quot;userId-&quot; + id);
        }

        User user = userPrivilegePairList.get(0).getUser();

        List&lt;Privilege&gt; privileges = userPrivilegePairList.stream().map(UserPrivilegePair::getPrivilege).collect(Collectors.toList());
        Set&lt;Duty&gt; allDuties = getDutiesForPrivileges(privileges);

        UserDutiesPresentation userDutiesPresentation = new UserDutiesPresentation(user, allDuties);
        Resource&lt;UserDutiesPresentation&gt; resource = new Resource&lt;&gt;(userDutiesPresentation, createUserLink(user));
        resource.add(createDutiesForUserLink(user.getID()));

        for(Duty duty : allDuties)
        {
            resource.add(createDutyLink(duty));
        }

        return ResponseEntity.ok(resource);
    }




    //  -------------------------------------------
    //  ---------- Privileges With Users ----------
    //  -------------------------------------------
    @GetMapping(&quot;/privileges/users&quot;)
    public ResponseEntity&lt;Resources&lt;Resource&lt;PrivilegePresentation&gt;&gt;&gt; getPrivilegesUsers()
    {
        List&lt;Resource&lt;PrivilegePresentation&gt;&gt; resourceResult = new ArrayList&lt;&gt;();

        ResponseEntity&lt;Resources&lt;PrivilegePresentation&gt;&gt; privilegePresentationResources = privilegeController.getPrivileges();
        Map&lt;Long, List&lt;PrivilegePresentation&gt;&gt; privilegePresentationResourcesMap = privilegePresentationResources.getBody().getContent().stream()
                .collect(Collectors.groupingBy(PrivilegePresentation::getID));

        List&lt;UserPrivilegePair&gt; userPrivilegePairList = userPrivilegeMapRepository.findAll();
        Map&lt;Privilege, List&lt;User&gt;&gt; groupedPrivileges = userPrivilegePairList.stream()
                .collect(Collectors
                        .groupingBy(d -&gt; d.getPrivilege(), Collectors.mapping(UserPrivilegePair::getUser, Collectors.toList())));

        for(Map.Entry&lt;Privilege, List&lt;User&gt;&gt; e : groupedPrivileges.entrySet())
        {
            Privilege privilege = e.getKey();
            List&lt;PrivilegePresentation&gt; privilegePresentations = privilegePresentationResourcesMap.get(privilege.getID());
            if(!privilegePresentations.isEmpty())
            {
                PrivilegePresentation privilegePresentation = privilegePresentations.get(0);
                Resource&lt;PrivilegePresentation&gt; privilegeResource = new Resource&lt;&gt;(privilegePresentation, createPrivilegeLink(privilege));
                privilegeResource.add(createUsersForPrivilegeLink(privilege.getID()));
                for(User user : e.getValue())
                {
                    privilegeResource.add(createUserLink(user));
                }
                resourceResult.add(privilegeResource);
            }
        }

        Resources&lt;Resource&lt;PrivilegePresentation&gt;&gt; resources = new Resources&lt;&gt;(resourceResult, linkTo(methodOn(getClass()).getPrivilegesUsers()).withSelfRel());
        return ResponseEntity.ok(resources);
    }



    @GetMapping(&quot;/privileges/{id}/users&quot;)
    public  ResponseEntity&lt;Resource&lt;PrivilegePresentation&gt;&gt;  getUsersForPrivilege(@PathVariable(&quot;id&quot;) long id)
    {
        List&lt;UserPrivilegePair&gt; userPrivilegePairList = userPrivilegeMapRepository.findByPrivilegeId(id);

        if(userPrivilegePairList.isEmpty())
        {
            throw new NotFoundException(&quot;privilegeId-&quot; + id);
        }

        Privilege privilege = userPrivilegePairList.get(0).getPrivilege();

        ResponseEntity&lt;Resource&lt;PrivilegePresentation&gt;&gt; privilegePresentationResource = privilegeController.getPrivilegesById(privilege.getID());
        PrivilegePresentation privilegePresentation = privilegePresentationResource.getBody().getContent();

        Resource&lt;PrivilegePresentation&gt; privilegeResource = new Resource&lt;&gt;(privilegePresentation, createPrivilegeLink(privilege));

        List&lt;User&gt; users = userPrivilegePairList.stream().map(e -&gt; e.getUser()).collect(Collectors.toList());

        for(User user : users)
        {
            privilegeResource.add(createUserLink(user));
        }
        privilegeResource.add(linkTo(methodOn(getClass()).getUsersForPrivilege(id)).withSelfRel());
        return ResponseEntity.ok(privilegeResource);
    }

    private Set&lt;Duty&gt; getDutiesForPrivileges(List&lt;Privilege&gt; privileges)
    {
        //  Note: same function defined in ClearanceController
        Set&lt;Duty&gt; allDuties = new HashSet&lt;&gt;();
        for(Privilege privilege : privileges)
        {
            List&lt;DutyPrivilegePair&gt; dutyPrivilegePairs = dutyPrivilegeMapRepository.findByPrivilegeId(privilege.getID());
            Set&lt;Duty&gt; dutiesSet = dutyPrivilegePairs.stream().map(DutyPrivilegePair::getDuty).collect(Collectors.toSet());
            allDuties.addAll(dutiesSet);
        }
        return allDuties;
    }

    //  Helper methods
    private Link createUserLink(User user)
    {
        return linkTo(methodOn(UserController.class).getUsers(user.getID())).withRel(&quot;user&quot;).withTitle(user.getUserName());
    }

    private Link createPrivilegeLink(Privilege privilege)
    {
        return linkTo(methodOn(PrivilegeController.class).getPrivilegesById(privilege.getID())).withRel(&quot;privilege&quot;).withTitle(privilege.getPrivilegeName());
    }

    private Link createDutyLink(Duty duty)
    {
        return linkTo(methodOn(DutyController.class).getDuties(duty.getID())).withRel(&quot;duty&quot;).withTitle(duty.getDutyName());
    }

    private Link createPrivilegesForUserLink(long userId)
    {
        return linkTo(methodOn(getClass()).getPrivilegesForUser(userId)).withSelfRel();
    }

    private Link createDutiesForUserLink(long userId)
    {
        return linkTo(methodOn(getClass()).getDutiesForUser(userId)).withSelfRel();
    }

    private Link createUsersForPrivilegeLink(long privilegeId)
    {
        return linkTo(methodOn(getClass()).getUsersForPrivilege(privilegeId)).withSelfRel();
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h2 id="SoDImplementation-ExternalControllers">External Controllers</h2><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">Transactional
@RestController
@RepositoryRestController
public class CampController
{
    //  https://prod.services.camp.site.gs.com:8086/api/people/entitlements/800245357
    //  localhost:8081/camp/kerberos/gunern/privileges
    //  localhost:8081/camp/guid/800245357/privileges

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Autowired
    private GSSSOToken gsssoToken;
    @Autowired
    private PeopleSearchController peopleSearchController;

    @Value(&quot;${camp-entitlements.url}&quot;)
    private String campEntitlementsUrl;

    private HttpHeaders headers;

    private RestTemplate restTemplate = new RestTemplate();


    @GetMapping(&quot;/camp/guid/{guid}/privileges&quot;)
    public ResponseEntity&lt;List&lt;String&gt;&gt; getCampPrivilegesByGuid(@PathVariable(&quot;guid&quot;) String guid) throws JSONException
    {
        List&lt;String&gt; response = getCampPrivileges(guid);
        return ResponseEntity.ok(response);
    }


    @GetMapping(&quot;/camp/kerberos/{kerberos}/privileges&quot;)
    public ResponseEntity&lt;List&lt;String&gt;&gt; getCampPrivilegesByKerberos(@PathVariable(&quot;kerberos&quot;) String kerberos) throws JSONException
    {
        ResponseEntity&lt;Map&lt;String,String&gt;&gt; peopleControllerResponse = peopleSearchController.findByKerberos(kerberos);

        String guid = peopleControllerResponse.getBody().get(&quot;gsguid&quot;);

        List&lt;String&gt; response = getCampPrivileges(guid);
        return ResponseEntity.ok(response);
    }

    private List&lt;String&gt; getCampPrivileges(String guid) throws JSONException
    {
        ResponseEntity&lt;String&gt; campResponse;
        String url = String.format(campEntitlementsUrl, guid);
        try
        {
            campResponse = restTemplate.exchange(url,
                    HttpMethod.GET,
                    new HttpEntity&lt;String&gt;(getHttpHeaders()),
                    String.class);
        }
        catch(Exception e)
        {
            throw new InternalServerErrorException(&quot;CAMP service internal error&quot;);
        }
        finally
        {
            logger.info(&quot;External CAMP GET request: {}&quot;, url);
        }

        List&lt;String&gt; response = new ArrayList&lt;&gt;();
        if(campResponse != null &amp;&amp; campResponse.getStatusCode() == HttpStatus.OK)
        {
            JSONArray content = new JSONArray(campResponse.getBody());
            if(content.length() == 0)
            {
                throw new NotFoundException(&quot;Guid: &quot; + guid);
            }

            for(int i = 0; i &lt; content.length(); ++i)
            {
                JSONObject jsonItem = (JSONObject)content.get(i);
                Object privilegeId = jsonItem.get(&quot;privilegeId&quot;);
                if(privilegeId != null &amp;&amp; privilegeId instanceof String)
                {
                    response.add((String) privilegeId);
                }
            }
        }

        return response;
    }


    private HttpHeaders getHttpHeaders()
    {
        if(headers == null)
        {
            headers = new HttpHeaders();
            String cookie = gsssoToken.getCookie();
            logger.info(&quot;Cookie: {}&quot;, cookie);
            headers.add(&quot;Cookie&quot;, cookie);
        }
        return headers;
    }

}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RestController
@RepositoryRestController
public class PeopleSearchController
{
    private Logger logger = LoggerFactory.getLogger(getClass());

    @Value(&quot;${peoplesearchByKerberos.url}&quot;)
    private String peopleSearchByKerberosUrl;

    @Value(&quot;${peoplesearchByGuid.url}&quot;)
    private String peopleSearchByGuidUrl;

    private RestTemplate restTemplate = new RestTemplate();

    @GetMapping(&quot;/peoplesearch/kerberos/{kerberos}&quot;)
    public ResponseEntity&lt;Map&lt;String,String&gt;&gt; findByKerberos(@PathVariable(&quot;kerberos&quot;) String kerberos) throws JSONException
    {
        String url = String.format(peopleSearchByKerberosUrl, kerberos);
        ResponseEntity&lt;String&gt; response;

        try
        {
            response = restTemplate.getForEntity(url, String.class);
        }
        finally
        {
            logger.info(&quot;External PeopleSearch GET Request: {}&quot;, url);
        }

        Map&lt;String,String&gt; resultMap = getResultMap(response, kerberos);

        return ResponseEntity.ok(resultMap);
    }

    @GetMapping(&quot;/peoplesearch/guid/{guid}&quot;)
    public ResponseEntity&lt;Map&lt;String,String&gt;&gt; findByGuid(@PathVariable(&quot;guid&quot;) String guid) throws JSONException
    {
        String url = String.format(peopleSearchByKerberosUrl, guid);

        ResponseEntity&lt;String&gt; response;

        try
        {
            response = restTemplate.getForEntity(url, String.class);
        }
        finally
        {
            logger.info(&quot;External PeopleSearch GET Request: {}&quot;, url);
        }

        Map&lt;String,String&gt; resultMap = getResultMap(response, guid);

        return ResponseEntity.ok(resultMap);
    }

    public String kerberosFromGuid(String guid) throws JSONException
    {
        Map&lt;String,String&gt; result = getResultMapForGuid(guid);
        return result.get(&quot;gskerberosid&quot;);
    }

    public String guidFromKerberos(String kerberos) throws JSONException
    {
        Map&lt;String,String&gt; result = getResultMapForKerberos(kerberos);
        return result.get(&quot;gsguid&quot;);
    }

    private Map&lt;String,String&gt; getResultMapForGuid(String guid) throws JSONException
    {
        ResponseEntity&lt;String&gt; response = restTemplate.getForEntity(String.format(peopleSearchByGuidUrl, guid), String.class);
        return getResultMap(response, guid);
    }

    private Map&lt;String,String&gt; getResultMapForKerberos(String kerberos) throws JSONException
    {
        ResponseEntity&lt;String&gt; response = restTemplate.getForEntity(String.format(peopleSearchByKerberosUrl, kerberos), String.class);
        return getResultMap(response, kerberos);
    }

    private Map&lt;String,String&gt; getResultMap(ResponseEntity&lt;String&gt; response, String searchByValue) throws JSONException
    {
        Map&lt;String,String&gt; resultMap = new HashMap&lt;&gt;();

        JSONObject jsonObject = new JSONObject(response.getBody());
        JSONArray content = (JSONArray) jsonObject.get(&quot;people&quot;);

        if(content.length() == 0)
        {
            throw new NotFoundException(&quot;PeopleSearch Not Found, Search by: &quot; + searchByValue);
        }

        JSONArray names = ((JSONObject) content.get(0)).names();
        for(int i = 0; i &lt; names.length(); ++i)
        {
            String name = (String)names.get(i);
            String value = ((JSONObject)content.get(0)).getString(name);
            if(StringUtils.isNotBlank(value))
            {
                resultMap.put(name, value);
            }
        }

        return resultMap;
    }

}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Transactional
@RestController
@RepositoryRestController
public class RmsComController
{
    private Logger logger = LoggerFactory.getLogger(getClass());

    private RestTemplate restTemplate = new RestTemplate();

    @Autowired
    private PeopleSearchController peopleSearchController;

    @Autowired
    private RmsController rmsController;

    private HttpHeaders headers;

    @Value(&quot;${kerberos.asset.type.id}&quot;)
    private String kerberosAssetTypeId;
    @Value(&quot;${rmsnode.asset.type.id}&quot;)
    private String rmsNodeAssetTypeId;
    @Autowired
    private GSSSOToken gsssoToken;
    @Autowired
    private RuleRepository ruleRepository;
    @Autowired
    private DutyPrivilegeMapRepository dutyPrivilegeMapRepository;
    @Autowired
    private DutyRuleMapRepository dutyRuleMapRepository;


    @Value(&quot;${comSetOverride.url}&quot;)
    private String comSetOverrideUrl;
    @Value(&quot;${comSetBulkOverride.url}&quot;)
    private String comSetBulkOverrideUrl;
    @Value(&quot;${comGetRmsNodeOverride.url}&quot;)
    private String comGetRmsNodeOverrideUrl;
    @Value(&quot;${comGetKerberosOverride.url}&quot;)
    private String comGetKerberosOverrideUrl;
    @Value(&quot;${comDeleteOverride.url}&quot;)
    private String comDeleteOverrideUrl;
    @Value(&quot;${control.url}&quot;)
    private String controlUrl;
    @Value(&quot;${comGetControlIdUrl}&quot;)
    private String comGetControlUrl;

    @PostMapping(&quot;/com/rmsnode/{approverKerberos}/{value}&quot;)
    public ResponseEntity&lt;?&gt; setComRmsNodeBulkOverride(@RequestBody ComRmsNodeOverrideInput comRmsNodeOverrideInput,
                                                   @PathVariable(&quot;approverKerberos&quot;) String approverKerberos,
                                                   @PathVariable(&quot;value&quot;) String value) throws JSONException
    {
        List&lt;String&gt; users = comRmsNodeOverrideInput.getRmsNodes();
        return createComBulkOverride(users, rmsNodeAssetTypeId, &quot;RmsNode&quot;, approverKerberos, value);
    }

    @PostMapping(&quot;/com/kerberos/{approverKerberos}/{value}&quot;)
    public ResponseEntity&lt;?&gt; setComKerberosBulkOverride(@RequestBody ComKerberosOverrideInput comKerberosOverrideInput,
                                                       @PathVariable(&quot;approverKerberos&quot;) String approverKerberos,
                                                       @PathVariable(&quot;value&quot;) String value) throws JSONException
    {
        List&lt;String&gt; users = comKerberosOverrideInput.getUsers();
        return createComBulkOverride(users, kerberosAssetTypeId, &quot;Kerberos&quot;, approverKerberos, value);
    }


    //  Use setComRmsNodeBulkOverride in preference of this function
    @PostMapping(&quot;/com/rmsnode/{approverKerberos}/{requesterKerberos}/{value}&quot;)
    public ResponseEntity&lt;?&gt; setComRmsNodeOverride(@RequestBody ComRmsNodeOverrideInput comRmsNodeOverrideInput,
                                                   @PathVariable(&quot;approverKerberos&quot;) String approverKerberos,
                                                   @PathVariable(&quot;requesterKerberos&quot;) String requesterKerberos,
                                                   @PathVariable(&quot;value&quot;) String value) throws JSONException
    {
        List&lt;String&gt; users = comRmsNodeOverrideInput.getRmsNodes();
        return createComSaveOverride(users, rmsNodeAssetTypeId, &quot;RmsNode&quot;, approverKerberos, requesterKerberos, value);
    }

    //  Use setComKerberosBulkOverride in preference of this function
    @PostMapping(&quot;/com/kerberos/{approverKerberos}/{requesterKerberos}/{value}&quot;)
    public ResponseEntity&lt;?&gt; setComKerberosOverride(@RequestBody ComKerberosOverrideInput comKerberosOverrideInput,
                                                    @PathVariable(&quot;approverKerberos&quot;) String approverKerberos,
                                                    @PathVariable(&quot;requesterKerberos&quot;) String requesterKerberos,
                                                    @PathVariable(&quot;value&quot;) String value) throws JSONException
    {
        List&lt;String&gt; users = comKerberosOverrideInput.getUsers();
        return createComSaveOverride(users, kerberosAssetTypeId, &quot;Kerberos&quot;, approverKerberos, requesterKerberos, value);
    }

    private ResponseEntity&lt;?&gt; createComSaveOverride(List&lt;String&gt; users, String assetTypeId, String assetTypeName, String approverKerberos, String requesterKerberos, String override) throws JSONException
    {
        List&lt;Integer&gt; controlIds = getControlIdFromOverrideValue(override);

        String approverFullName = getFullNameForKerberos(approverKerberos);
        String requesterFullName = getFullNameForKerberos(requesterKerberos);

        List&lt;Map&lt;String,Object&gt;&gt; assetScopes = new ArrayList&lt;&gt;();
        for(String user : users)
        {
            final String fullName;
            if(assetTypeId.equals(kerberosAssetTypeId))
            {
                fullName = getFullNameForKerberos(user);
            }
            else
            {
                fullName = &quot;Tech Risk Engineering&quot;;
            }

            Map&lt;String,Object&gt; assetScopeMap = new HashMap&lt;String,Object&gt;() {{
                put(&quot;assetId&quot;, user);
                put(&quot;assetTypeId&quot;, assetTypeId);
                put(&quot;assetName&quot;, fullName);
                put(&quot;assetTypeName&quot;, assetTypeId);
            }};
            assetScopes.add(assetScopeMap);
        }

        URI location = null;
        for(int controlId : controlIds)
        {
            List&lt;Map&lt;String,Object&gt;&gt; exemptionOwners = new ArrayList&lt;&gt;();
            List&lt;String&gt; controlOwners = getExemptionOwners(controlId);
            for(String controlOwner : controlOwners)
            {
                Map&lt;String,Object&gt; exemptionOwnersMap = new HashMap&lt;String,Object&gt;() {{
                    put(&quot;kerberos&quot;, controlOwner);
                    put(&quot;reason&quot;, &quot;Added by Requestor&quot;);
                    put(&quot;lastUpdatedBy&quot;, controlOwner);
                    put(&quot;lastModifiedBy&quot;, controlOwner);
                }};
                exemptionOwners.add(exemptionOwnersMap);
            }

            Map&lt;String, Object&gt; bodyMap = new HashMap&lt;&gt;();

            bodyMap.put(&quot;control&quot;, controlId);
            bodyMap.put(&quot;controlName&quot;, &quot;SoD &quot; + assetTypeName + &quot; Override&quot;);
            bodyMap.put(&quot;assetTypeId&quot;, assetTypeId);
            bodyMap.put(&quot;assetTypeName&quot;, assetTypeName);
            bodyMap.put(&quot;assetScopes&quot;, assetScopes);
            bodyMap.put(&quot;approvalMD&quot;, approverKerberos);
            bodyMap.put(&quot;approvalMDName&quot;, approverFullName);
            bodyMap.put(&quot;requestor&quot;, requesterKerberos);
            bodyMap.put(&quot;requestorName&quot;, requesterFullName);
            bodyMap.put(&quot;automaticExemption&quot;, 0);
            bodyMap.put(&quot;expiryDate&quot;, Instant.now().plus(365, ChronoUnit.DAYS).toString());
            bodyMap.put(&quot;treatment&quot;, &quot;UNABLE_TO_ADOPT_CONTROL&quot;);
            bodyMap.put(&quot;patchScope&quot;, override);
            bodyMap.put(&quot;exemptionDescription&quot;, &quot;SoD &quot; + assetTypeName + &quot; Override&quot;);
            bodyMap.put(&quot;nonAdoptionExplanation&quot;, &quot;SoD &quot; + assetTypeName + &quot; Override&quot;);
            bodyMap.put(&quot;updateOrSave&quot;, &quot;save&quot;);
            bodyMap.put(&quot;exemptionOwners&quot;, exemptionOwners);

            HttpEntity&lt;Map&lt;String, Object&gt;&gt; httpEntity = new HttpEntity&lt;&gt;(bodyMap, getHttpHeaders());
            ResponseEntity&lt;String&gt; comResponse;

            try
            {
                comResponse = restTemplate.exchange(comSetOverrideUrl, HttpMethod.POST, httpEntity, String.class);
            }
            catch(Exception e)
            {
                throw new InternalServerErrorException(&quot;COM Save POST request failed&quot;);
            }

            if(comResponse != null &amp;&amp; comResponse.getStatusCode() == HttpStatus.OK)
            {
                location = ServletUriComponentsBuilder
                        .fromCurrentRequest()
                        .buildAndExpand().toUri();
            }
        }

        return ResponseEntity.created(location).build();
    }

    private ResponseEntity&lt;?&gt; createComBulkOverride(List&lt;String&gt; users, String assetTypeId, String assetTypeName, String approverKerberos, String override) throws JSONException
    {
        //  http://localhost:8081/com/kerberos/vassia/PRIVILEGE_OVERRIDE|16,17:19
        List&lt;Integer&gt; controlIds = getControlIdFromOverrideValue(override);

        String approverFullName = getFullNameForKerberos(approverKerberos);

        List&lt;Map&lt;String,Object&gt;&gt; assetScopes = new ArrayList&lt;&gt;();
        for(String user : users)
        {
            final String fullName;
            if(assetTypeId.equals(kerberosAssetTypeId))
            {
                fullName = getFullNameForKerberos(user);
            }
            else
            {
                fullName = &quot;Tech Risk Engineering&quot;;
            }

            Map&lt;String,Object&gt; assetScopeMap = new HashMap&lt;String,Object&gt;() {{
                put(&quot;assetId&quot;, user);
                put(&quot;assetName&quot;, fullName);
                put(&quot;assetTypeName&quot;, assetTypeId);
                put(&quot;divisionName&quot;, &quot;&quot;);
                put(&quot;businessUnitName&quot;, &quot;&quot;);
            }};
            assetScopes.add(assetScopeMap);
        }

        URI location = null;
        for(int controlId : controlIds)
        {
            List&lt;Map&lt;String,Object&gt;&gt; exemptionOwners = new ArrayList&lt;&gt;();

            List&lt;String&gt; controlOwners = getExemptionOwners(controlId);
            for(String controlOwner : controlOwners)
            {
                Map&lt;String,Object&gt; exemptionOwnersMap = new HashMap&lt;String,Object&gt;() {{
                    put(&quot;kerberos&quot;, controlOwner);
                    put(&quot;reason&quot;, &quot;Added by Requestor&quot;);
                    put(&quot;lastUpdatedBy&quot;, controlOwner);
                    put(&quot;lastModifiedBy&quot;, controlOwner);
                }};
                exemptionOwners.add(exemptionOwnersMap);
            }

            Map&lt;String, Object&gt; bodyMap = new HashMap&lt;&gt;();

            bodyMap.put(&quot;parentExemptionId&quot;, 0);
            bodyMap.put(&quot;control&quot;, controlId);
            bodyMap.put(&quot;controlName&quot;, &quot;SoD &quot; + assetTypeName + &quot; Override&quot;);
            bodyMap.put(&quot;assetTypeId&quot;, assetTypeId);
            bodyMap.put(&quot;assetTypeName&quot;, assetTypeName);
            bodyMap.put(&quot;metricName&quot;, &quot;&quot;);
            bodyMap.put(&quot;assetScopes&quot;, assetScopes);
            bodyMap.put(&quot;approvalMD&quot;, approverKerberos);
            bodyMap.put(&quot;approvalMDName&quot;, approverFullName);
            bodyMap.put(&quot;compensatingControls&quot;, new ArrayList&lt;&gt;());
            bodyMap.put(&quot;risks&quot;, new ArrayList&lt;&gt;());
            bodyMap.put(&quot;autoCloseStatus&quot;, &quot;&quot;);
            bodyMap.put(&quot;requestor&quot;, &quot;&quot;);
            bodyMap.put(&quot;requestorName&quot;, &quot;&quot;);
            bodyMap.put(&quot;requestSource&quot;, &quot;&quot;);
            bodyMap.put(&quot;requestDate&quot;, Instant.now().toString());
            bodyMap.put(&quot;expiryDate&quot;, Instant.now().plus(365, ChronoUnit.DAYS).toString());
            bodyMap.put(&quot;treatment&quot;, &quot;UNABLE_TO_ADOPT_CONTROL&quot;);
            bodyMap.put(&quot;patchScope&quot;, override);
            bodyMap.put(&quot;exemptionDescription&quot;, &quot;SoD &quot; + assetTypeName + &quot; Override&quot;);
            bodyMap.put(&quot;state&quot;, &quot;APPROVED&quot;);
            bodyMap.put(&quot;exemptionProcessState&quot;, &quot;ACTIVE&quot;);
            bodyMap.put(&quot;exemptionOwners&quot;, exemptionOwners);
            bodyMap.put(&quot;exemptionComments&quot;, new ArrayList&lt;&gt;());
            bodyMap.put(&quot;exemptionClosure&quot;, new ArrayList&lt;&gt;());


            //  Uncomment below for logging purposes
//            ObjectMapper objectMapper = new ObjectMapper();
//            String json;
//            try
//            {
//                json = objectMapper.writeValueAsString(bodyMap);
//                logger.info(&quot;json = {}&quot; + json);
//            }
//            catch (JsonProcessingException e)
//            {
//                e.printStackTrace();
//            }

            List&lt;Map&lt;String, Object&gt;&gt; requestBody = new ArrayList&lt;&gt;();
            requestBody.add(bodyMap);

            HttpEntity&lt;List&lt;Map&lt;String, Object&gt;&gt;&gt; httpEntity = new HttpEntity&lt;&gt;(requestBody, getHttpHeaders());
            ResponseEntity&lt;String&gt; comResponse;

            try
            {
                comResponse = restTemplate.exchange(comSetBulkOverrideUrl, HttpMethod.POST, httpEntity, String.class);
            }
            catch(Exception e)
            {
                throw new InternalServerErrorException(&quot;COM Bulk POST request failed&quot;);
            }

            if(comResponse != null &amp;&amp; comResponse.getStatusCode() == HttpStatus.OK)
            {
                //  Uncomment to see response
                //JSONObject jsonObject = new JSONObject(comResponse.getBody());
                location = ServletUriComponentsBuilder
                        .fromCurrentRequest()
                        .buildAndExpand().toUri();
            }

        }

        return ResponseEntity.created(location).build();
    }


    @GetMapping(&quot;/com/all&quot;)
    public ResponseEntity&lt;List&lt;Map&lt;String, Object&gt;&gt;&gt; getComAllOverrides() throws JSONException
    {
        List&lt;Integer&gt; controlIDs = ruleRepository.findAllControlIDs();

        List&lt;Map&lt;String, Object&gt;&gt; response = new ArrayList&lt;&gt;();

        for(int controlId : controlIDs)
        {
            String url = String.format(comGetControlUrl, controlId);

            ResponseEntity&lt;String&gt; comResponse = null;

            try
            {
                comResponse = restTemplate.exchange(url,
                        HttpMethod.GET,
                        new HttpEntity&lt;&gt;(null, getHttpHeaders()),
                        String.class);
            }
            catch (Exception e)
            {
                logger.info(&quot;No overrides for controlId &#39;{}&#39;&quot;, controlId);
            }
            finally
            {
                logger.info(&quot;External COM GET Request: {}&quot;, url);
            }

            if (comResponse != null &amp;&amp; comResponse.getStatusCode() == HttpStatus.OK)
            {
                JSONArray jsonArray = new JSONArray(comResponse.getBody());
                for (int i = 0; i &lt; jsonArray.length(); ++i)
                {
                    JSONObject jsonObject = (JSONObject) jsonArray.get(i);

                    Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();

                    map.put(&quot;override&quot;, jsonObject.get(&quot;patchScope&quot;));
                    map.put(&quot;expiryDate&quot;, jsonObject.get(&quot;expiryDate&quot;));
                    map.put(&quot;state&quot;, jsonObject.get(&quot;state&quot;));
                    map.put(&quot;id&quot;, String.valueOf(jsonObject.get(&quot;id&quot;)));
                    map.put(&quot;controlId&quot;, String.valueOf(jsonObject.get(&quot;control&quot;)));
                    map.put(&quot;requestDate&quot;, jsonObject.get(&quot;requestDate&quot;));
                    map.put(&quot;expiryDate&quot;, jsonObject.get(&quot;expiryDate&quot;));
                    map.put(&quot;assetTypeName&quot;, jsonObject.get(&quot;assetTypeName&quot;));

                    JSONArray assetScopesJsonArray = (JSONArray)jsonObject.get(&quot;assetScopes&quot;);
                    List&lt;String&gt; assetIds = new ArrayList&lt;&gt;();
                    for(int j = 0; j &lt; assetScopesJsonArray.length(); ++j)
                    {
                        JSONObject jsonSubObject = (JSONObject) assetScopesJsonArray.get(j);
                        assetIds.add((String)jsonSubObject.get(&quot;assetId&quot;));
                    }

                    map.put(&quot;assetScopes&quot;, assetIds);

                    response.add(map);
                }
            }
        }

        return ResponseEntity.ok(response);
    }



        @GetMapping(&quot;/com/{kerberos}&quot;)
    public ResponseEntity&lt;Map&lt;String,List&lt;Map&lt;String,String&gt;&gt;&gt;&gt; getComOverrides(@PathVariable(&quot;kerberos&quot;) String kerberos) throws JSONException
    {
        List&lt;String&gt; input = new ArrayList&lt;&gt;();
        input.add(kerberos);

        HttpEntity&lt;List&lt;String&gt;&gt; httpEntity = new HttpEntity&lt;&gt;(input, getHttpHeaders());
        ResponseEntity&lt;String&gt; comResponse = null;
        try
        {
            comResponse = restTemplate.exchange(comGetKerberosOverrideUrl, HttpMethod.POST, httpEntity, String.class);
        }
        catch(Exception e)
        {
            logger.info(&quot;No overrides for Kerberos &#39;{}&#39;&quot;, kerberos);
        }
        finally
        {
            logger.info(&quot;External COM POST Request: {}, json body: [\&quot;{}\&quot;]&quot;, comGetKerberosOverrideUrl, kerberos);
        }

        Map&lt;String,List&lt;Map&lt;String,String&gt;&gt;&gt; response = new HashMap&lt;&gt;();
        if(comResponse != null &amp;&amp; comResponse.getStatusCode() == HttpStatus.OK)
        {
            List&lt;Map&lt;String, String&gt;&gt; data = new ArrayList&lt;&gt;();

            JSONArray jsonArray = new JSONArray(comResponse.getBody());
            for (int i = 0; i &lt; jsonArray.length(); ++i)
            {
                JSONObject jsonObject = (JSONObject) jsonArray.get(i);

                Map&lt;String, String&gt; map = new HashMap&lt;&gt;();
                map.put(&quot;override&quot;, (String) jsonObject.get(&quot;patchScope&quot;));
                map.put(&quot;expiryDate&quot;, (String) jsonObject.get(&quot;expiryDate&quot;));
                map.put(&quot;state&quot;, (String) jsonObject.get(&quot;state&quot;));
                map.put(&quot;id&quot;, String.valueOf(jsonObject.get(&quot;id&quot;)));
                map.put(&quot;control id&quot;, String.valueOf(jsonObject.get(&quot;control&quot;)));

                data.add(map);
            }


            if (!data.isEmpty())
            {
                response.put(&quot;kerberos overrides&quot;, data);
            }
        }

        ResponseEntity&lt;LinkedHashMap&lt;String, Map&lt;String,String&gt;&gt;&gt; rmsHierarchyResponse = rmsController.getRmsHierarchyByKerberos(kerberos);
        LinkedHashMap&lt;String, Map&lt;String,String&gt;&gt; rmsHierarchyMap = rmsHierarchyResponse.getBody();

        for(Map.Entry&lt;String, Map&lt;String,String&gt;&gt; e : rmsHierarchyMap.entrySet())
        {
            String code = e.getKey();
            List&lt;Map&lt;String,String&gt;&gt; rmsNodeOverrides = getComRmsNodeOverridesForRmsNodeCode(code);
            if(!rmsNodeOverrides.isEmpty())
            {
                Map&lt;String,String&gt; value = e.getValue();
                String name = value.get(&quot;name&quot;);
                String type = value.get(&quot;nodeType&quot;);

                response.put(String.format(&quot;%s (%s-%s) override&quot;, type, name, code), rmsNodeOverrides);
            }
        }

        return ResponseEntity.ok(response);
    }


    @DeleteMapping(&quot;/com/{id}&quot;)
    public ResponseEntity&lt;?&gt; deleteComOverride(@PathVariable(&quot;id&quot;) int id) throws JSONException
    {
        HttpEntity&lt;Map&lt;String, Object&gt;&gt; httpEntity = new HttpEntity&lt;&gt;(null, getHttpHeaders());
        ResponseEntity&lt;String&gt; comResponse;
        try
        {
            comResponse = restTemplate.exchange(String.format(comDeleteOverrideUrl, id), HttpMethod.DELETE, httpEntity, String.class);
        }
        catch(Exception e)
        {
            throw new NotFoundException(&quot;No overrides for id: &quot; + id);
        }

        return ResponseEntity.ok(comResponse);
    }

    List&lt;Map&lt;String,String&gt;&gt; getComRmsNodeOverridesForRmsNodeCode(String code) throws JSONException
    {
        List&lt;String&gt; input = new ArrayList&lt;&gt;();
        input.add(code);

        HttpEntity&lt;List&lt;String&gt;&gt; httpEntity = new HttpEntity&lt;&gt;(input, getHttpHeaders());

        ResponseEntity&lt;String&gt; comResponse = null;
        try
        {
            comResponse = restTemplate.exchange(comGetRmsNodeOverrideUrl, HttpMethod.POST, httpEntity, String.class);
        }
        catch(Exception e)
        {
            // COM throws exception when value is not found
            logger.info(&quot;Code &#39;{}&#39; not found in COM&quot;, code);
        }
        finally
        {
            logger.info(&quot;External COM POST Request: {}, body: [\&quot;{}\&quot;]&quot;, comGetRmsNodeOverrideUrl, code);
        }

        List&lt;Map&lt;String,String&gt;&gt; result = new ArrayList&lt;&gt;();
        if(comResponse != null &amp;&amp; comResponse.getStatusCode() == HttpStatus.OK)
        {
            JSONArray jsonArray = new JSONArray(comResponse.getBody());
            for(int i = 0; i &lt; jsonArray.length(); ++i)
            {
                JSONObject jsonObject = (JSONObject)jsonArray.get(i);

                Map&lt;String,String&gt; map = new HashMap&lt;&gt;();
                map.put(&quot;override&quot;, (String)jsonObject.get(&quot;patchScope&quot;));
                map.put(&quot;expiryDate&quot;, (String)jsonObject.get(&quot;expiryDate&quot;));
                map.put(&quot;state&quot;, (String)jsonObject.get(&quot;state&quot;));
                map.put(&quot;id&quot;, String.valueOf(jsonObject.get(&quot;id&quot;)));

                result.add(map);
            }
        }

        return result;
    }

    public List&lt;String&gt; getExemptionOwners(int controlId)
    {
        String url = String.format(controlUrl, controlId);
        ResponseEntity&lt;?&gt; responseEntity;
        try
        {
            responseEntity = restTemplate.exchange(url,
                    HttpMethod.GET,
                    new HttpEntity&lt;String&gt;(getHttpHeaders()),
                    Map.class);
        }
        catch(Exception e)
        {
            throw new NotFoundException(&quot;ControlId: &quot; + controlId);
        }
        finally
        {
            logger.info(&quot;External Control360 GET request: {}&quot;, url);
        }

        List&lt;String&gt; response = new ArrayList&lt;&gt;();
        if(responseEntity != null &amp;&amp; responseEntity.getStatusCode() == HttpStatus.OK)
        {
            ResponseEntity&lt;Map&lt;String,Object&gt;&gt; rmsResponse = (ResponseEntity&lt;Map&lt;String,Object&gt;&gt;)responseEntity;
            Map&lt;String,Object&gt; valueMap = rmsResponse.getBody();
            List&lt;LinkedHashMap&lt;String,Object&gt;&gt; dataMapList = (ArrayList&lt;LinkedHashMap&lt;String, Object&gt;&gt;) valueMap.get(&quot;data&quot;);
            LinkedHashMap&lt;String,Object&gt; dataMap = dataMapList.get(0);
            List&lt;LinkedHashMap&lt;String,Object&gt;&gt; tagsList = (List&lt;LinkedHashMap&lt;String,Object&gt;&gt;)dataMap.get(&quot;tags&quot;);

            for(LinkedHashMap&lt;String,Object&gt; entry : tagsList)
            {
                if(entry.get(&quot;tagType&quot;).equals(&quot;ControlAssessorIndividual&quot;))
                {
                    String tag = (String)entry.get(&quot;tag&quot;);
                    if(StringUtils.hasText(tag))
                    {
                        response.add(tag);
                    }
                }
            }
        }

        return response;
    }

    private String getFullNameForKerberos(String kerberos) throws JSONException
    {
        ResponseEntity&lt;Map&lt;String,String&gt;&gt; userMapResponse = peopleSearchController.findByKerberos(kerberos);
        if(userMapResponse.getStatusCode() != HttpStatus.OK)
        {
            throw new NotFoundException(&quot;user-&quot; + kerberos);
        }

        return userMapResponse.getBody().get(&quot;cn&quot;);
    }

    private List&lt;Integer&gt; getControlIdFromOverrideValue(String overrideSpec)
    {
        String[] overrideParts = overrideSpec.split(&quot;@&quot;);
        if(overrideParts.length == 2)
        {
            if(overrideParts[0].equals(&quot;RULE_OVERRIDE&quot;))
            {
                Optional&lt;Rule&gt; ruleOptional = ruleRepository.findById(Integer.valueOf(overrideParts[1]));
                if(ruleOptional.isPresent())
                {
                    return Arrays.asList(ruleOptional.get().getControlId());
                }
            }
            else if(overrideParts[0].equals(&quot;PRIVILEGE_OVERRIDE&quot;))
            {
                String[] privilegeOverrideParts = overrideParts[1].split(&quot;:&quot;);
                if (privilegeOverrideParts.length == 2)
                {
                    String leftPrivileges = privilegeOverrideParts[0];
                    String rightPrivileges = privilegeOverrideParts[1];
                    if (StringUtils.hasText(leftPrivileges) &amp;&amp; StringUtils.hasText(rightPrivileges))
                    {
                        //  Format: ~1~2~:~3~4~  Skip first element
                        List&lt;Long&gt; leftPrivilegesIdList = Arrays.stream(leftPrivileges.split(&quot;~&quot;)).skip(1L).map(Long::valueOf).collect(Collectors.toList());
                        List&lt;Long&gt; rightPrivilegesIdList = Arrays.stream(rightPrivileges.split(&quot;~&quot;)).skip(1L).map(Long::valueOf).collect(Collectors.toList());

                        List&lt;DutyPrivilegePair&gt; leftDutyPrivilegePairs = dutyPrivilegeMapRepository.findByPrivilegeIdList(leftPrivilegesIdList);
                        List&lt;DutyPrivilegePair&gt; rightDutyPrivilegePairs = dutyPrivilegeMapRepository.findByPrivilegeIdList(rightPrivilegesIdList);

                        if(!leftDutyPrivilegePairs.isEmpty() &amp;&amp; !rightDutyPrivilegePairs.isEmpty())
                        {
                            List&lt;Long&gt; leftDutyIDs = leftDutyPrivilegePairs.stream().map(DutyPrivilegePair::getDuty).map(Duty::getID).distinct().collect(Collectors.toList());
                            List&lt;Long&gt; rightDutyIDs = rightDutyPrivilegePairs.stream().map(DutyPrivilegePair::getDuty).map(Duty::getID).distinct().collect(Collectors.toList());

                            if(!leftDutyIDs.isEmpty() &amp;&amp; !rightDutyIDs.isEmpty())
                            {
                                List&lt;DutyRulePair&gt; leftDutyRulePairs = dutyRuleMapRepository.findByDutyIdList(leftDutyIDs);
                                List&lt;DutyRulePair&gt; rightDutyRulePairs = dutyRuleMapRepository.findByDutyIdList(rightDutyIDs);

                                if(!leftDutyRulePairs.isEmpty() &amp;&amp; !rightDutyRulePairs.isEmpty())
                                {
                                    List&lt;Rule&gt; leftRules = leftDutyRulePairs.stream().map(DutyRulePair::getRule).collect(Collectors.toList());
                                    List&lt;Rule&gt; rightRules = rightDutyRulePairs.stream().map(DutyRulePair::getRule).collect(Collectors.toList());

                                    if(!leftRules.isEmpty() &amp;&amp; !rightRules.isEmpty())
                                    {
                                        List&lt;Rule&gt; intersectionRule = new ArrayList&lt;&gt;(leftRules);
                                        intersectionRule.retainAll(rightRules);

                                        if(!intersectionRule.isEmpty())
                                        {
                                            return intersectionRule.stream().map(Rule::getControlId).distinct().collect(Collectors.toList());
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
        throw new OverrideSpecificationException(overrideSpec);
    }

    private HttpHeaders getHttpHeaders()
    {
        if(headers == null)
        {
            headers = new HttpHeaders();
            headers.add(&quot;Cookie&quot;, gsssoToken.getCookie());
        }
        return headers;
    }

}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RestController
@RepositoryRestController
public class RmsController
{
    //  localhost:8081/rms/hierarchy/guid/800245357
    //  http://localhost:8081/rms/hierarchy/kerberos/gunern

    private Logger logger = LoggerFactory.getLogger(getClass());

    private RestTemplate restTemplate = new RestTemplate();
    @Autowired
    private GSSSOToken gsssoToken;

    @Value(&quot;${rmsOrgMemberships.url}&quot;)
    private String rmsOrgMembershipsUrl;

    @Value(&quot;${rmsTeamMembers.url}&quot;)
    private String rmsTeamMembersUrl;

    @Value(&quot;${rmsHierarchy.url}&quot;)
    private String rmsHierarchyUrl;

    @Autowired
    private PeopleSearchController peopleSearchController;

    private HttpHeaders headers;


    @GetMapping(&quot;/rms/hierarchy/guid/{guid}&quot;)
    public ResponseEntity&lt;LinkedHashMap&lt;String, Map&lt;String,String&gt;&gt;&gt; getRmsHierarchyByGuid(@PathVariable(&quot;guid&quot;) String guid)
    {
        ResponseEntity&lt;?&gt; responseEntity;

        String url = String.format(rmsOrgMembershipsUrl, guid);
        try
        {
            responseEntity = restTemplate.exchange(url,
                    HttpMethod.GET,
                    new HttpEntity&lt;String&gt;(getHttpHeaders()),
                    Map.class);
        }
        catch(Exception e)
        {
            throw new NotFoundException(&quot;Guid: &quot; + guid);
        }
        finally
        {
            logger.info(&quot;External RMS GET Request: {}&quot;, url);
        }

        LinkedHashMap&lt;String, Map&lt;String,String&gt;&gt; result = new LinkedHashMap&lt;&gt;();
        if(responseEntity != null &amp;&amp; responseEntity.getStatusCode() == HttpStatus.OK)
        {
            ResponseEntity&lt;Map&lt;String,Object&gt;&gt; rmsResponse = (ResponseEntity&lt;Map&lt;String,Object&gt;&gt;)responseEntity;
            Map&lt;String,Object&gt; valueMap = rmsResponse.getBody();
            List&lt;LinkedHashMap&lt;String,Object&gt;&gt; dataMapList = (ArrayList&lt;LinkedHashMap&lt;String, Object&gt;&gt;) valueMap.get(&quot;data&quot;);
            Map&lt;String,Object&gt; dataMap = dataMapList.get(0);
            Map&lt;String,Map&lt;String,String&gt;&gt; linksMap = (Map&lt;String,Map&lt;String,String&gt;&gt;)dataMap.get(&quot;links&quot;);
            Map&lt;String,String&gt; parentNodeLinkMap = linksMap.get(&quot;parent-node&quot;);
            String parentLink = parentNodeLinkMap.get(&quot;href&quot;);

            while(true)
            {
                responseEntity = restTemplate.exchange(parentLink,
                        HttpMethod.GET,
                        new HttpEntity&lt;String&gt;(getHttpHeaders()),
                        Map.class);
                rmsResponse = (ResponseEntity&lt;Map&lt;String,Object&gt;&gt;)responseEntity;
                valueMap = rmsResponse.getBody();
                dataMap = (LinkedHashMap&lt;String, Object&gt;) valueMap.get(&quot;data&quot;);
                linksMap = (Map&lt;String,Map&lt;String,String&gt;&gt;)dataMap.get(&quot;links&quot;);
                parentNodeLinkMap = linksMap.get(&quot;parent-node&quot;);
                parentLink = parentNodeLinkMap.get(&quot;href&quot;);

                Object parentNodeCode = dataMap.get(&quot;parentNodeCode&quot;);

                if(parentNodeCode == null)
                {
                    break;
                }

                String code = (String)dataMap.get(&quot;code&quot;);
                String nodeType = (String)dataMap.get(&quot;nodeType&quot;);
                String name = (String)dataMap.get(&quot;name&quot;);

                result.put(code, new HashMap&lt;String,String&gt;() {{
                    put(&quot;nodeType&quot;, nodeType);
                    put(&quot;name&quot;, name);
                }});
            }
        }

        return ResponseEntity.ok(result);
    }

    @GetMapping(&quot;/rms/hierarchy/kerberos/{kerberos}&quot;)
    public ResponseEntity&lt;LinkedHashMap&lt;String, Map&lt;String,String&gt;&gt;&gt; getRmsHierarchyByKerberos(@PathVariable(&quot;kerberos&quot;) String kerberos) throws JSONException
    {
        ResponseEntity&lt;Map&lt;String,String&gt;&gt; peopleResponse = peopleSearchController.findByKerberos(kerberos);
        Map&lt;String,String&gt; peopleMap = peopleResponse.getBody();
        String guid = peopleMap.get(&quot;gsguid&quot;);
        return getRmsHierarchyByGuid(guid);
    }

    @GetMapping(&quot;/rms/{code}/team-members&quot;)
    public ResponseEntity&lt;List&lt;LinkedHashMap&lt;String,String&gt;&gt;&gt; getRmsTeamMembers(@PathVariable(&quot;code&quot;) String code,
                                                                                @RequestParam(defaultValue = &quot;true&quot;) boolean usePeopleSearch)
            throws UnsupportedEncodingException
    {
        code = URLDecoder.decode(code, StandardCharsets.UTF_8.name());

        ResponseEntity&lt;?&gt; responseEntity;

        try
        {
            responseEntity = restTemplate.exchange(String.format(rmsTeamMembersUrl, code),
                HttpMethod.GET,
                new HttpEntity&lt;String&gt;(getHttpHeaders()),
                Map.class);
        }
        catch (Exception e)
        {
            if(e instanceof HttpClientErrorException)
            {
                HttpClientErrorException httpClientErrorException = (HttpClientErrorException)e;
                if(httpClientErrorException.getStatusCode() == HttpStatus.FORBIDDEN)
                {
                    throw new InternalServerErrorException(&quot;RMS code must correspond to Team node type. Code: &quot; + code);
                }
            }
            throw new NotFoundException(&quot;Code: &quot; + code);
        }


        List&lt;LinkedHashMap&lt;String,String&gt;&gt; result = new ArrayList&lt;&gt;();
        if(responseEntity != null &amp;&amp; responseEntity.getStatusCode() == HttpStatus.OK)
        {
            ResponseEntity&lt;Map&lt;String,Object&gt;&gt; rmsResponse = (ResponseEntity&lt;Map&lt;String,Object&gt;&gt;)responseEntity;
            Map&lt;String,Object&gt; valueMap = rmsResponse.getBody();
            List&lt;LinkedHashMap&lt;String,String&gt;&gt; dataMapList = (ArrayList&lt;LinkedHashMap&lt;String, String&gt;&gt;) valueMap.get(&quot;data&quot;);

            for(LinkedHashMap&lt;String,String&gt; entry : dataMapList)
            {
                LinkedHashMap&lt;String,String&gt; memberMap = new LinkedHashMap&lt;&gt;();

                String kerberos = entry.get(&quot;kerberos&quot;);

                memberMap.put(&quot;name&quot;, entry.get(&quot;name&quot;));
                memberMap.put(&quot;guid&quot;, entry.get(&quot;guid&quot;));
                memberMap.put(&quot;kerberos&quot;, kerberos);
                memberMap.put(&quot;employeeNumber&quot;, entry.get(&quot;employeeNumber&quot;));
                memberMap.put(&quot;title&quot;, entry.get(&quot;title&quot;));

                if(usePeopleSearch)
                {
                    ResponseEntity&lt;Map&lt;String, String&gt;&gt; peopleResponse = null;
                    try
                    {
                        peopleResponse = peopleSearchController.findByKerberos(kerberos);
                        if (peopleResponse != null &amp;&amp; peopleResponse.getStatusCode() == HttpStatus.OK)
                        {
                            Map&lt;String, String&gt; peopleSearchMap = peopleResponse.getBody();

                            memberMap.put(&quot;phone&quot;, peopleSearchMap.get(&quot;telephonenumber&quot;));
                            memberMap.put(&quot;location&quot;, peopleSearchMap.get(&quot;l&quot;));
                            memberMap.put(&quot;department&quot;, peopleSearchMap.get(&quot;gsdeptcode&quot;));
                        }
                    }
                    catch (Exception e)
                    {
                        logger.error(&quot;PeopleSearch request failed for kerberos: {}&quot;, kerberos);
                    }
                }

                result.add(memberMap);
            }

        }
        return ResponseEntity.ok(result);
    }

    @GetMapping(&quot;/rms/{code}/hierarchy-links&quot;)
    public ResponseEntity&lt;List&lt;List&lt;String&gt;&gt;&gt; getRmsHierarchyLinks(@PathVariable(&quot;code&quot;) String code) throws UnsupportedEncodingException
    {
        //  http://localhost:8081/rms/OC.GRO.TEC.38697/hierarchy
        //  http://localhost:8081/rms/OC_GS/hierarchy
        ResponseEntity&lt;?&gt; responseEntity = restTemplate.exchange(String.format(rmsHierarchyUrl, code),
                HttpMethod.GET,
                new HttpEntity&lt;String&gt;(getHttpHeaders()),
                Map.class);

        if(responseEntity.getStatusCode() != HttpStatus.OK)
        {
            logger.error(&quot;Code: {}&quot;, code);
            throw new InternalServerErrorException(&quot;RMS request for hierarch links failed. Code: &quot; + code);
        }

        ResponseEntity&lt;Map&lt;String,Object&gt;&gt; rmsResponse = (ResponseEntity&lt;Map&lt;String,Object&gt;&gt;)responseEntity;
        Map&lt;String,Object&gt; valueMap = rmsResponse.getBody();
        LinkedHashMap&lt;String,Object&gt; dataMap = (LinkedHashMap&lt;String, Object&gt;) valueMap.get(&quot;data&quot;);


        Map&lt;String,Map&lt;String,String&gt;&gt; linksMap = (Map&lt;String,Map&lt;String,String&gt;&gt;)dataMap.get(&quot;links&quot;);
        Map&lt;String,String&gt; selfLinkMap = linksMap.get(&quot;self&quot;);
        String selfLink = selfLinkMap.get(&quot;href&quot;);

        List&lt;List&lt;String&gt;&gt; result = new ArrayList&lt;&gt;();
        result.add(Arrays.asList(selfLink));


        List&lt;String&gt; currentChildLinks = new ArrayList&lt;&gt;();

        Map&lt;String,String&gt; childLinkMap = linksMap.get(&quot;child-nodes&quot;);
        String childLink = childLinkMap.get(&quot;href&quot;);

        currentChildLinks.add(childLink);

        while(!currentChildLinks.isEmpty())
        {
            List&lt;String&gt; currentSelfLinks = new ArrayList&lt;&gt;();

            List&lt;String&gt; parentChildLinks = currentChildLinks;
            currentChildLinks = new ArrayList&lt;&gt;();

            for (String parent : parentChildLinks)
            {
                logger.info(&quot;Before encode = {}&quot;, parent);
                parent = URLEncoder.encode(parent, StandardCharsets.UTF_8.name());
                logger.info(&quot;After encode = {}&quot;, parent);
                parent = URLDecoder.decode(parent, StandardCharsets.UTF_8.name());
                logger.info(&quot;After decode 1 = {}&quot;, parent);
                parent = URLDecoder.decode(parent, StandardCharsets.UTF_8.name());
                logger.info(&quot;After decode 2 = {}&quot;, parent);

                try
                {
                    responseEntity = restTemplate.exchange(parent,
                            HttpMethod.GET,
                            new HttpEntity&lt;String&gt;(getHttpHeaders()),
                            Map.class);
                }
                catch(Exception e)
                {
                    logger.error(&quot;Error: &quot;, e);
                    continue;
                }

                if(responseEntity.getStatusCode() == HttpStatus.OK)
                {
                    rmsResponse = (ResponseEntity&lt;Map&lt;String, Object&gt;&gt;) responseEntity;
                    valueMap = rmsResponse.getBody();
                    List&lt;LinkedHashMap&lt;String, Object&gt;&gt; dataMapList = (ArrayList&lt;LinkedHashMap&lt;String, Object&gt;&gt;) valueMap.get(&quot;data&quot;);


                    for (LinkedHashMap&lt;String, Object&gt; map : dataMapList)
                    {
                        linksMap = (Map&lt;String, Map&lt;String, String&gt;&gt;) map.get(&quot;links&quot;);
                        if (linksMap != null)
                        {
                            Map&lt;String, String&gt; selfNodesMap = linksMap.get(&quot;self&quot;);
                            if(selfNodesMap != null)
                            {
                                currentSelfLinks.add(selfNodesMap.get(&quot;href&quot;));
                            }

                            String nodeType = (String)map.get(&quot;nodeType&quot;);
                            if(!nodeType.equals(&quot;Team&quot;))
                            {
                                Map&lt;String, String&gt; childNodesMap = linksMap.get(&quot;child-nodes&quot;);
                                if (childNodesMap != null)
                                {
                                    currentChildLinks.add(childNodesMap.get(&quot;href&quot;));
                                }
                            }
                        }
                    }
                }
            }
            result.add(currentSelfLinks);
        }

        return ResponseEntity.ok(result);
    }

    @GetMapping(&quot;/rms/{code}/hierarchy&quot;)
    public ResponseEntity&lt;Map&lt;String,Object&gt;&gt; getRmsHierarchy(@PathVariable(&quot;code&quot;) String code,
                                                              @RequestParam(defaultValue = &quot;true&quot;) boolean includePeople)
            throws UnsupportedEncodingException, JSONException
    {
        //  BU: http://localhost:8081/rms/OC.GRO.TEC.38697/hierarchy
        //  GROUP: http://localhost:8081/rms/OC.GRO.GMAA.74549/hierarchy
        //  http://localhost:8081/rms/OC_GS/hierarchy

        ResponseEntity&lt;?&gt; responseEntity;

        try
        {
            responseEntity = restTemplate.exchange(String.format(rmsHierarchyUrl, code),
                    HttpMethod.GET,
                    new HttpEntity&lt;String&gt;(getHttpHeaders()),
                    Map.class);

        }
        catch(Exception e)
        {
            if(e instanceof HttpClientErrorException)
            {
                HttpClientErrorException httpClientErrorException = (HttpClientErrorException)e;
                if(httpClientErrorException.getStatusCode() == HttpStatus.FORBIDDEN)
                {
                    throw new InternalServerErrorException(&quot;RMS forbid this operation. Code: &quot; + code);
                }
            }
            throw new NotFoundException(&quot;Code: &quot; + code);
        }

        Map&lt;String,Object&gt; result = new LinkedHashMap&lt;&gt;();
        if(responseEntity != null &amp;&amp; responseEntity.getStatusCode() == HttpStatus.OK)
        {
            ResponseEntity&lt;Map&lt;String,Object&gt;&gt; rmsResponse = (ResponseEntity&lt;Map&lt;String,Object&gt;&gt;)responseEntity;
            Map&lt;String,Object&gt; valueMap = rmsResponse.getBody();
            LinkedHashMap&lt;String,Object&gt; dataMap = (LinkedHashMap&lt;String, Object&gt;) valueMap.get(&quot;data&quot;);

            GraphNode parentNode = new GraphNode(dataMap);
            addChildren(parentNode, includePeople);

            //  handle case when the supplied code corresponds to a Team, i.e. no children
            if(includePeople &amp;&amp; parentNode.getChildren().isEmpty())
            {
                addTeamMembers(parentNode);
            }

            GraphNode.toMap(parentNode, result);
        }

        return ResponseEntity.ok(result);
    }

    private void addChildren(GraphNode parent, boolean includePeople) throws UnsupportedEncodingException, JSONException
    {
        String link = parent.getChildLink();
        logger.info(&quot;Before encode = {}&quot;, link);
        link = URLEncoder.encode(link, StandardCharsets.UTF_8.name());
        logger.info(&quot;After encode = {}&quot;, link);
        link = URLDecoder.decode(link, StandardCharsets.UTF_8.name());
        logger.info(&quot;After decode 1 = {}&quot;, link);
        link = URLDecoder.decode(link, StandardCharsets.UTF_8.name());
        logger.info(&quot;After decode 2 = {}&quot;, link);

        ResponseEntity&lt;?&gt; responseEntity = null;
        try
        {
            responseEntity = restTemplate.exchange(link,
                    HttpMethod.GET,
                    new HttpEntity&lt;String&gt;(getHttpHeaders()),
                    Map.class);
        }
        catch(Exception e)
        {
            logger.error(&quot;Link: {}&quot;, link);
        }

        if(responseEntity != null &amp;&amp; responseEntity.getStatusCode() == HttpStatus.OK)
        {
            ResponseEntity&lt;Map&lt;String,Object&gt;&gt; rmsResponse = (ResponseEntity&lt;Map&lt;String, Object&gt;&gt;) responseEntity;
            Map&lt;String,Object&gt; valueMap = rmsResponse.getBody();
            List&lt;LinkedHashMap&lt;String, Object&gt;&gt; dataMapList = (ArrayList&lt;LinkedHashMap&lt;String, Object&gt;&gt;) valueMap.get(&quot;data&quot;);


            List&lt;GraphNode&gt; childNodes = new ArrayList&lt;&gt;();
            for (LinkedHashMap&lt;String, Object&gt; map : dataMapList)
            {
                GraphNode childNode = new GraphNode(map);
                childNodes.add(childNode);
                if(!childNode.getNodeType().equals(&quot;Team&quot;))
                {
                    addChildren(childNode, includePeople);
                }
                else
                {
                    if(includePeople)
                    {
                        addTeamMembers(childNode);
                    }
                }
            }

            parent.addChildren(childNodes);
        }
    }

    private void addTeamMembers(GraphNode node) throws UnsupportedEncodingException
    {
        String code = node.getCode();
        if (code.indexOf(&#39;/&#39;) == -1 &amp;&amp; code.indexOf(&#39;#&#39;) == -1)
        {
            code = URLEncoder.encode(code, StandardCharsets.UTF_8.name());
            ResponseEntity&lt;List&lt;LinkedHashMap&lt;String, String&gt;&gt;&gt; teamMembersResponse = getRmsTeamMembers(code, true);

            if (teamMembersResponse.getStatusCode() == HttpStatus.OK)
            {
                List&lt;LinkedHashMap&lt;String, String&gt;&gt; teamMembers = teamMembersResponse.getBody();
                if (!teamMembers.isEmpty())
                {
                    node.addTeamMembers(teamMembers);
                }
            }
        }
    }

    private HttpHeaders getHttpHeaders()
    {
        if(headers == null)
        {
            headers = new HttpHeaders();
            headers.add(&quot;Cookie&quot;, gsssoToken.getCookie());
        }
        return headers;
    }

    private static class GraphNode
    {
        String name;
        String nodeType;
        String code;
        String childLink;
        List&lt;GraphNode&gt; children = new ArrayList&lt;&gt;();
        List&lt;LinkedHashMap&lt;String,String&gt;&gt; teamMembers;

        GraphNode(LinkedHashMap&lt;String,Object&gt; map)
        {
            name = (String)map.get(&quot;name&quot;);
            nodeType = (String)map.get(&quot;nodeType&quot;);
            code = (String)map.get(&quot;code&quot;);

            Map&lt;String,Map&lt;String,String&gt;&gt; linksMap = (Map&lt;String,Map&lt;String,String&gt;&gt;)map.get(&quot;links&quot;);
            Map&lt;String,String&gt; childLinkMap = linksMap.get(&quot;child-nodes&quot;);
            childLink = childLinkMap.get(&quot;href&quot;);
        }

        String getChildLink()
        {
            return childLink;
        }

        String getNodeType()
        {
            return nodeType;
        }

        String getCode()
        {
            return code;
        }

        void addChildren(List&lt;GraphNode&gt; children)
        {
            this.children.addAll(children);
        }

        List&lt;GraphNode&gt; getChildren()
        {
            return this.children;
        }

        void addTeamMembers(List&lt;LinkedHashMap&lt;String,String&gt;&gt; teamMembers)
        {
            this.teamMembers = teamMembers;
        }

        List&lt;LinkedHashMap&lt;String,String&gt;&gt; getTeamMembers()
        {
            return teamMembers;
        }

        static void toMap(GraphNode node, Map&lt;String,Object&gt; result)
        {
            result.put(&quot;name&quot;, node.name);
            result.put(&quot;nodeType&quot;, node.nodeType);
            result.put(&quot;code&quot;, node.code);

            List&lt;LinkedHashMap&lt;String,String&gt;&gt; team = node.getTeamMembers();
            if(team != null)
            {
                result.put(&quot;team&quot;, team);
            }

            List&lt;Map&lt;String,Object&gt;&gt; childList = new ArrayList&lt;&gt;();
            for(GraphNode childNode : node.children)
            {
                Map&lt;String,Object&gt; map = new LinkedHashMap&lt;&gt;();
                toMap(childNode, map);
                childList.add(map);
            }

            if(!childList.isEmpty())
            {
                result.put(&quot;children&quot;, childList);
            }
        }
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="SoDImplementation-Entity">Entity</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@EntityListeners(AuditingEntityListener.class)
public class AuditTrail extends BaseEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    @Column(name=&quot;ID&quot;, updatable = false, nullable = false)
    private long ID;
    private long assignableId;
    private String privilegeId;
    private String requestedUser;
    private String assignableName;
    @Column(length=10000)
    private String rejectReason;
    @Column(length=10000)
    private String reason;
    private String rules;
    @Column(length=10000)
    private String exception;
    private String system;
    private String clear;
    private String explanation;

    public AuditTrail()
    {
    }

    public long getID()
    {
        return ID;
    }

    public void setID(long ID)
    {
        this.ID = ID;
    }

    public long getAssignableId()
    {
        return assignableId;
    }

    public void setAssignableId(long assignableId)
    {
        this.assignableId = assignableId;
    }

    public String getPrivilegeId()
    {
        return privilegeId;
    }

    public void setPrivilegeId(String privilegeId)
    {
        this.privilegeId = privilegeId;
    }

    public String getRequestedUser()
    {
        return requestedUser;
    }

    public void setRequestedUser(String kerberos)
    {
        this.requestedUser = kerberos;
    }

    public String getAssignableName()
    {
        return assignableName;
    }

    public void setAssignableName(String assignableName)
    {
        this.assignableName = assignableName;
    }

    public String getRejectReason()
    {
        return rejectReason;
    }

    public void setRejectReason(String rejectReason)
    {
        this.rejectReason = rejectReason;
    }

    public String getRules()
    {
        return rules;
    }

    public void setRules(String rules)
    {
        this.rules = rules;
    }

    public String getException()
    {
        return exception;
    }

    public void setException(String exception)
    {
        this.exception = exception;
    }

    public String getSystem()
    {
        return system;
    }

    public void setSystem(String system)
    {
        this.system = system;
    }

    public String isClear()
    {
        return clear;
    }

    public void setClear(String clear)
    {
        this.clear = clear;
    }

    public String getExplanation()
    {
        return explanation;
    }

    public void setExplanation(String explanation)
    {
        this.explanation = explanation;
    }

    public String getReason()
    {
        return reason;
    }

    public void setReason(String reason)
    {
        this.reason = reason;
    }

    @Override
    public String toString()
    {
        return &quot;AuditTrail{&quot; +
                &quot;ID=&quot; + ID +
                &quot;, assignableId=&quot; + assignableId +
                &quot;, privilegeId=&#39;&quot; + privilegeId + &#39;\&#39;&#39; +
                &quot;, requestedUser=&#39;&quot; + requestedUser + &#39;\&#39;&#39; +
                &quot;, assignableName=&#39;&quot; + assignableName + &#39;\&#39;&#39; +
                &quot;, rejectReason=&#39;&quot; + rejectReason + &#39;\&#39;&#39; +
                &quot;, reason=&#39;&quot; + reason + &#39;\&#39;&#39; +
                &quot;, rules=&#39;&quot; + rules + &#39;\&#39;&#39; +
                &quot;, exception=&#39;&quot; + exception + &#39;\&#39;&#39; +
                &quot;, system=&#39;&quot; + system + &#39;\&#39;&#39; +
                &quot;, clear=&quot; + clear +
                &quot;, explanation=&#39;&quot; + explanation + &#39;\&#39;&#39; +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
public class BaseEntity extends ResourceSupport
{

    public static ZonedDateTime DATE_INFINITY = ZonedDateTime.parse(&quot;9999-12-31T00:00:00Z&quot;);

    @Column(name = &quot;in_utc&quot;, nullable = false, updatable = false)
    @CreatedDate
    //@JsonIgnore
    @CreationTimestamp
    @Temporal(TemporalType.TIMESTAMP)
    private Date inUtc;

    @Column(name = &quot;out_utc&quot;)
    private ZonedDateTime outUtc = DATE_INFINITY;

    @CreatedBy
    //@JsonIgnore
    @Column(name = &quot;created_by&quot;)
    private String createdBy;

    @LastModifiedBy
    //@JsonIgnore
    @Column(name = &quot;last_modified_by&quot;)
    private String lastModifiedBy;


    public Date getInUtc()
    {
        return inUtc;
    }

    public void setInUtc(Date inUtc)
    {
        this.inUtc = inUtc;
    }

    public ZonedDateTime getOutUtc()
    {
        return outUtc;
    }

    public void setOutUtc(ZonedDateTime outUtc)
    {
        this.outUtc = outUtc;
    }

    public String getCreatedBy()
    {
        return createdBy;
    }

    public void setCreatedBy(String createdBy)
    {
        this.createdBy = createdBy;
    }

    public String getLastModifiedBy()
    {
        return lastModifiedBy;
    }

    public void setLastModifiedBy(String lastModifiedBy)
    {
        this.lastModifiedBy = lastModifiedBy;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@EntityListeners(AuditingEntityListener.class)
@Table(name = &quot;DUTY&quot;,
        uniqueConstraints={
                @UniqueConstraint(columnNames = {&quot;auditId&quot;, &quot;out_utc&quot;})
        })
public class Duty extends BaseEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    @Column(name=&quot;ID&quot;, updatable = false, nullable = false)
    private long ID;
    private String auditId = UUID.randomUUID().toString();
    private String dutyName;

    @OneToMany(mappedBy = &quot;duty&quot;)
    private List&lt;DutyRulePair&gt; dutyRulePairs = new ArrayList&lt;&gt;();

    @OneToMany(mappedBy = &quot;duty&quot;)
    private List&lt;DutyPrivilegePair&gt; dutyPrivilegePair = new ArrayList&lt;&gt;();

    //  Copy constructor to create Audit Trail
    public Duty(Duty other)
    {
        super();
        this.auditId = other.auditId;
        this.dutyName = other.dutyName;
        this.setOutUtc(ZonedDateTime.now());
    }

    public Duty()
    {
        super();
    }


    public long getID()
    {
        return ID;
    }

    public void setID(long ID)
    {
        this.ID = ID;
    }

    public String getAuditId()
    {
        return auditId;
    }

    public void setAuditId(String auditId)
    {
        this.auditId = auditId;
    }

    public String getDutyName()
    {
        return dutyName;
    }

    public void setDutyName(String dutyName)
    {
        this.dutyName = dutyName;
    }

    public List&lt;DutyRulePair&gt; getDutyRulePairs()
    {
        return dutyRulePairs;
    }

    public void setDutyRulePairs(List&lt;DutyRulePair&gt; dutyRulePairs)
    {
        this.dutyRulePairs = dutyRulePairs;
    }

    public void addDutyRuleMap(DutyRulePair dutyRulePair)
    {
        this.dutyRulePairs.add(dutyRulePair);
    }

    public void removeDutyRuleMap(DutyRulePair dutyRulePair)
    {
        this.dutyRulePairs.remove(dutyRulePair);
    }

    public List&lt;DutyPrivilegePair&gt; getDutyPrivilegePair()
    {
        return dutyPrivilegePair;
    }

    public void setDutyPrivilegePair(List&lt;DutyPrivilegePair&gt; dutyPrivilegePair)
    {
        this.dutyPrivilegePair = dutyPrivilegePair;
    }

    public void addDutyPrivilegeMap(DutyPrivilegePair dutyPrivilegePair)
    {
        this.dutyPrivilegePair.add(dutyPrivilegePair);
    }

    public void removeDutyPrivilegeMap(DutyPrivilegePair dutyPrivilegePair)
    {
        this.dutyPrivilegePair.remove(dutyPrivilegePair);
    }

    @Override
    public String toString()
    {
        return &quot;Duty{&quot; +
                &quot;ID=&quot; + ID +
                &quot;, biTemporalId=&#39;&quot; + auditId + &#39;\&#39;&#39; +
                &quot;, dutyName=&#39;&quot; + dutyName + &#39;\&#39;&#39; +
                &#39;}&#39;;
    }

    @Override
    public boolean equals(Object o)
    {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        if (!super.equals(o)) return false;
        Duty duty = (Duty) o;
        return ID == duty.ID &amp;&amp;
                Objects.equals(auditId, duty.auditId) &amp;&amp;
                Objects.equals(dutyName, duty.dutyName);
    }

    @Override
    public int hashCode()
    {
        return Objects.hash(super.hashCode(), ID, auditId, dutyName);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@EntityListeners(AuditingEntityListener.class)
@Table(name = &quot;DUTY_PRIVILEGE_MAP&quot;,
        uniqueConstraints={
        @UniqueConstraint(columnNames = {&quot;auditId&quot;, &quot;out_utc&quot;})
})
public class DutyPrivilegePair extends BaseEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    @Column(name=&quot;ID&quot;, updatable = false, nullable = false)
    private long ID;
    private String auditId = UUID.randomUUID().toString();
    @ManyToOne
    @JoinColumn(name = &quot;duty_id&quot;)
    private Duty duty;
    @ManyToOne
    @JoinColumn(name = &quot;privilege_id&quot;)
    private Privilege privilege;

    public long getID()
    {
        return ID;
    }

    public void setID(long ID)
    {
        this.ID = ID;
    }

    public String getAuditId()
    {
        return auditId;
    }

    public void setAuditId(String auditId)
    {
        this.auditId = auditId;
    }

    public Duty getDuty()
    {
        return duty;
    }

    public void setDuty(Duty duty)
    {
        this.duty = duty;
    }

    public Privilege getPrivilege()
    {
        return privilege;
    }

    public void setPrivilege(Privilege privilege)
    {
        this.privilege = privilege;
    }


    @Override
    public boolean equals(Object o)
    {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        if (!super.equals(o)) return false;
        DutyPrivilegePair that = (DutyPrivilegePair) o;
        return ID == that.ID &amp;&amp;
               duty.equals(that.duty) &amp;&amp;
               privilege.equals(that.privilege);
    }

    @Override
    public int hashCode()
    {
        return Objects.hash(super.hashCode(), ID, auditId, duty, privilege);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@Table(name = &quot;DUTY_RULE_MAP&quot;,
        uniqueConstraints={
                @UniqueConstraint(columnNames = {&quot;auditId&quot;, &quot;out_utc&quot;})
        })
public class DutyRulePair extends BaseEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    @Column(name=&quot;ID&quot;, updatable = false, nullable = false)
    private long ID;
    private String auditId = UUID.randomUUID().toString();
    @ManyToOne
    @JoinColumn(name = &quot;duty_id&quot;)
    private Duty duty;
    @ManyToOne
    @JoinColumn(name = &quot;rule_id&quot;)
    private Rule rule;

    public DutyRulePair(Duty duty, Rule rule)
    {
        this.duty = duty;
        this.rule = rule;
    }

    protected DutyRulePair()
    {}


    public long getID()
    {
        return ID;
    }

    public void setID(long ID)
    {
        this.ID = ID;
    }

    public String getAuditId()
    {
        return auditId;
    }

    public void setAuditId(String auditId)
    {
        this.auditId = auditId;
    }

    public Duty getDuty()
    {
        return duty;
    }

    public void setDuty(Duty duty)
    {
        this.duty = duty;
    }

    public Rule getRule()
    {
        return rule;
    }

    public void setRule(Rule rule)
    {
        this.rule = rule;
    }

    @Override
    public boolean equals(Object o)
    {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        if (!super.equals(o)) return false;
        DutyRulePair that = (DutyRulePair) o;
        return duty.equals(that.duty) &amp;&amp;
               rule.equals(that.rule);
    }

    @Override
    public int hashCode()
    {
        return Objects.hash(super.hashCode(), duty, rule);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@EntityListeners(AuditingEntityListener.class)
@Table(name = &quot;PRIVILEGE&quot;,
        uniqueConstraints={
                @UniqueConstraint(columnNames = {&quot;auditId&quot;, &quot;out_utc&quot;})
        })
public class Privilege extends BaseEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    @Column(name=&quot;ID&quot;, updatable = false, nullable = false)
    private long ID;
    private String auditId = UUID.randomUUID().toString();
    private String privilegeId;
    private String privilegeName;
    @OneToMany(mappedBy = &quot;privilege&quot;)
    private List&lt;DutyPrivilegePair&gt; dutyPrivilegePairs = new ArrayList&lt;&gt;();

    public long getID()
    {
        return ID;
    }

    public void setID(long ID)
    {
        this.ID = ID;
    }

    public String getAuditId()
    {
        return auditId;
    }

    public void setAuditId(String auditId)
    {
        this.auditId = auditId;
    }

    public String getPrivilegeId()
    {
        return privilegeId;
    }

    public void setPrivilegeId(String privilegeId)
    {
        this.privilegeId = privilegeId;
    }

    public String getPrivilegeName()
    {
        return privilegeName;
    }

    public void setPrivilegeName(String privilegeName)
    {
        this.privilegeName = privilegeName;
    }

    public List&lt;DutyPrivilegePair&gt; getDutyPrivilegePairs()
    {
        return dutyPrivilegePairs;
    }

    public void setDutyPrivilegePairs(List&lt;DutyPrivilegePair&gt; dutyPrivilegePairs)
    {
        this.dutyPrivilegePairs = dutyPrivilegePairs;
    }

    public void addDutyPrivilegeMap(DutyPrivilegePair dutyPrivilegePair)
    {
        this.dutyPrivilegePairs.add(dutyPrivilegePair);
    }

    public void removeDutyPrivilegeMap(DutyPrivilegePair dutyPrivilegePair)
    {
        this.dutyPrivilegePairs.remove(dutyPrivilegePair);
    }


    @Override
    public boolean equals(Object o)
    {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        if (!super.equals(o)) return false;
        Privilege privilege = (Privilege) o;
        return ID == privilege.ID &amp;&amp;
                Objects.equals(auditId, privilege.auditId) &amp;&amp;
                Objects.equals(privilegeName, privilege.privilegeName);
    }

    @Override
    public int hashCode()
    {

        return Objects.hash(super.hashCode(), ID, auditId, privilegeName);
    }

    @Override
    public String toString()
    {
        return &quot;Privilege{&quot; +
                &quot;ID=&quot; + ID +
                &quot;, biTemporalId=&#39;&quot; + auditId + &#39;\&#39;&#39; +
                &quot;, privilegeName=&#39;&quot; + privilegeName + &#39;\&#39;&#39; +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@EntityListeners(AuditingEntityListener.class)
@Table(name = &quot;RULE&quot;,
        uniqueConstraints={
                @UniqueConstraint(columnNames = {&quot;auditId&quot;, &quot;out_utc&quot;})
        })
public class Rule extends BaseEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    @Column(name=&quot;ID&quot;, updatable = false, nullable = false)
    private long ID;
    private String auditId = UUID.randomUUID().toString();
    private String ruleName;
    private String ruleType;
    private int controlId;

    @OneToMany(mappedBy = &quot;rule&quot;)
    private List&lt;DutyRulePair&gt; dutyRulePairs = new ArrayList&lt;&gt;();

    public long getID()
    {
        return ID;
    }

    public void setID(long ID)
    {
        this.ID = ID;
    }

    public String getAuditId()
    {
        return auditId;
    }

    public void setAuditId(String auditId)
    {
        this.auditId = auditId;
    }

    public String getRuleName()
    {
        return ruleName;
    }

    public void setRuleName(String ruleName)
    {
        this.ruleName = ruleName;
    }

    public String getRuleType()
    {
        return ruleType;
    }

    public void setRuleType(String ruleType)
    {
        this.ruleType = ruleType;
    }

    public int getControlId()
    {
        return controlId;
    }

    public void setControlId(int controlId)
    {
        this.controlId = controlId;
    }

    public List&lt;DutyRulePair&gt; getDutyRulePairs()
    {
        return dutyRulePairs;
    }

    public void setDutyRulePairs(List&lt;DutyRulePair&gt; dutyRulePairs)
    {
        this.dutyRulePairs = dutyRulePairs;
    }

    public void addDutyRuleMap(DutyRulePair dutyRulePair)
    {
        this.dutyRulePairs.add(dutyRulePair);
    }

    public void removeDutyRuleMap(DutyRulePair dutyRulePair)
    {
        this.dutyRulePairs.remove(dutyRulePair);
    }

    @Override
    public String toString()
    {
        return &quot;Rule{&quot; +
                &quot;ID=&quot; + ID +
                &quot;, auditId=&#39;&quot; + auditId + &#39;\&#39;&#39; +
                &quot;, ruleName=&#39;&quot; + ruleName + &#39;\&#39;&#39; +
                &quot;, ruleType=&#39;&quot; + ruleType + &#39;\&#39;&#39; +
                &quot;, controlId=&quot; + controlId +
                &#39;}&#39;;
    }

    @Override
    public boolean equals(Object o)
    {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        if (!super.equals(o)) return false;
        Rule rule = (Rule) o;
        return ID == rule.ID &amp;&amp;
                controlId == rule.controlId &amp;&amp;
                Objects.equals(auditId, rule.auditId) &amp;&amp;
                Objects.equals(ruleName, rule.ruleName) &amp;&amp;
                Objects.equals(ruleType, rule.ruleType) &amp;&amp;
                Objects.equals(dutyRulePairs, rule.dutyRulePairs);
    }

    @Override
    public int hashCode()
    {
        return Objects.hash(super.hashCode(), ID, auditId, ruleName, ruleType, controlId, dutyRulePairs);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@EntityListeners(AuditingEntityListener.class)
@Table(name = &quot;USER&quot;,
        uniqueConstraints={
                @UniqueConstraint(columnNames = {&quot;auditId&quot;, &quot;out_utc&quot;})
        })
public class User extends BaseEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    @Column(name=&quot;ID&quot;, updatable = false, nullable = false)
    private long ID;
    private String auditId = UUID.randomUUID().toString();
    private String userName;
    @OneToMany(mappedBy = &quot;user&quot;)
    private List&lt;UserPrivilegePair&gt; userPrivilegePairs = new ArrayList&lt;&gt;();
    @Transient
    private List&lt;Integer&gt; privilegeIds = new ArrayList&lt;&gt;();

    public long getID()
    {
        return ID;
    }

    public void setID(long ID)
    {
        this.ID = ID;
    }

    public String getAuditId()
    {
        return auditId;
    }

    public void setAuditId(String auditId)
    {
        this.auditId = auditId;
    }

    public String getUserName()
    {
        return userName;
    }

    public void setUserName(String userName)
    {
        this.userName = userName;
    }

    public List&lt;Integer&gt; getPrivilegeIds()
    {
        return privilegeIds;
    }

    public void setPrivilegeIds(List&lt;Integer&gt; privilegeIds)
    {
        this.privilegeIds = privilegeIds;
    }

    @Override
    public boolean equals(Object o)
    {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        if (!super.equals(o)) return false;
        User user = (User) o;
        return ID == user.ID &amp;&amp;
                Objects.equals(auditId, user.auditId) &amp;&amp;
                Objects.equals(userName, user.userName);
    }

    @Override
    public int hashCode()
    {
        return Objects.hash(super.hashCode(), ID, auditId, userName);
    }

    @Override
    public String toString()
    {
        return &quot;User{&quot; +
                &quot;ID=&quot; + ID +
                &quot;, biTemporalId=&#39;&quot; + auditId + &#39;\&#39;&#39; +
                &quot;, name=&#39;&quot; + userName + &#39;\&#39;&#39; +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@EntityListeners(AuditingEntityListener.class)
@Table(name = &quot;USER_PRIVILEGE_MAP&quot;,
        uniqueConstraints={
                @UniqueConstraint(columnNames = {&quot;auditId&quot;, &quot;out_utc&quot;})
        })
public class UserPrivilegePair extends BaseEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    @Column(name=&quot;ID&quot;, updatable = false, nullable = false)
    private long ID;
    private String auditId = UUID.randomUUID().toString();
    @ManyToOne
    @JoinColumn(name = &quot;user_id&quot;)
    private User user;
    @ManyToOne
    @JoinColumn(name = &quot;privilege_id&quot;)
    private Privilege privilege;

    public UserPrivilegePair(User user, Privilege privilege)
    {
        this.user = user;
        this.privilege = privilege;
    }

    protected UserPrivilegePair()
    {}

    public long getID()
    {
        return ID;
    }

    public void setID(long ID)
    {
        this.ID = ID;
    }

    public String getAuditId()
    {
        return auditId;
    }

    public void setAuditId(String auditId)
    {
        this.auditId = auditId;
    }

    public User getUser()
    {
        return user;
    }

    public void setUser(User user)
    {
        this.user = user;
    }

    public Privilege getPrivilege()
    {
        return privilege;
    }

    public void setPrivilege(Privilege privilege)
    {
        this.privilege = privilege;
    }

    @Override
    public boolean equals(Object o)
    {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        if (!super.equals(o)) return false;
        UserPrivilegePair that = (UserPrivilegePair) o;
        return ID == that.ID &amp;&amp;
                Objects.equals(auditId, that.auditId) &amp;&amp;
                Objects.equals(user, that.user) &amp;&amp;
                Objects.equals(privilege, that.privilege);
    }

    @Override
    public int hashCode()
    {
        return Objects.hash(super.hashCode(), ID, auditId, user, privilege);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="SoDImplementation-Exception">Exception</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@ControllerAdvice
@RestController
public class CustomizedResponseEntityExceptionHandler extends ResponseEntityExceptionHandler
{

    @ExceptionHandler(Exception.class)
    public final ResponseEntity&lt;Object&gt; handleAllExceptions(Exception ex, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), ex.getMessage(), request.getDescription(false));
        return new ResponseEntity(exceptionResponse, HttpStatus.INTERNAL_SERVER_ERROR);
    }


    @ExceptionHandler(NotFoundException.class)
    public final ResponseEntity&lt;Object&gt; handleReaderNotFoundException(NotFoundException ex, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), ex.getMessage(),
                request.getDescription(false));
        return new ResponseEntity(exceptionResponse, HttpStatus.NOT_FOUND);
    }

    @ExceptionHandler(RuleViolationException.class)
    public final ResponseEntity&lt;Object&gt; handleRuleViolationException(RuleViolationException ex, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), ex.getMessage(),
                request.getDescription(false));
        return new ResponseEntity(exceptionResponse, HttpStatus.FAILED_DEPENDENCY);
    }

    @ExceptionHandler(OverrideSpecificationException.class)
    public final ResponseEntity&lt;Object&gt; handleOverrideSpecificationException(OverrideSpecificationException ex, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), ex.getMessage(),
                request.getDescription(false));
        return new ResponseEntity(exceptionResponse, HttpStatus.BAD_REQUEST);
    }

    @Override
    protected ResponseEntity&lt;Object&gt; handleMethodArgumentNotValid(MethodArgumentNotValidException ex,
                                                                  HttpHeaders headers, HttpStatus status, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), &quot;Validation Failed&quot;,
                ex.getBindingResult().toString());
        return new ResponseEntity(exceptionResponse, HttpStatus.BAD_REQUEST);
    }
}


</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class ExceptionResponse
{
    private ZonedDateTime timestamp;
    private String message;
    private String details;

    public ExceptionResponse(ZonedDateTime timestamp, String message, String details) {
        this.timestamp = timestamp;
        this.message = message;
        this.details = details;
    }

    public ZonedDateTime getTimestamp() {
        return timestamp;
    }

    public String getMessage() {
        return message;
    }

    public String getDetails() {
        return details;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@ResponseStatus(HttpStatus.NOT_MODIFIED)
public class ExistsException  extends RuntimeException
{
    public ExistsException(String message)
    {
        super(message);
    }

}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)
public class InternalServerErrorException extends RuntimeException
{
    public InternalServerErrorException(String message)
    {
        super(message);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@ResponseStatus(HttpStatus.NOT_FOUND)
public class NotFoundException extends RuntimeException
{
    public NotFoundException(String message)
    {
        super(message);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@ResponseStatus(HttpStatus.BAD_REQUEST)
public class OverrideSpecificationException extends RuntimeException
{
    public OverrideSpecificationException(String message)
    {
        super(message);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@ResponseStatus(HttpStatus.FAILED_DEPENDENCY)
public class RuleViolationException extends RuntimeException
{
    public RuleViolationException(String message)
    {
        super(message);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="SoDImplementation-External">External</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class ComKerberosOverrideInput
{
    private List&lt;String&gt; users;

    public List&lt;String&gt; getUsers()
    {
        return users;
    }

    public void setUsers(List&lt;String&gt; users)
    {
        this.users = users;
    }

    @Override
    public String toString()
    {
        return &quot;ComKerberosOverrideInput{&quot; +
                &quot;users=&quot; + users +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class ComRmsNodeOverrideInput
{
    private List&lt;String&gt; rmsNodes;

    public List&lt;String&gt; getRmsNodes()
    {
        return rmsNodes;
    }

    public void setRmsNodes(List&lt;String&gt; rmsNodes)
    {
        this.rmsNodes = rmsNodes;
    }

    @Override
    public String toString()
    {
        return &quot;ComRmsNodeOverrideInput{&quot; +
                &quot;rmsNodes=&quot; + rmsNodes +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="SoDImplementation-Presentation">Presentation</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@JsonFilter(&quot;clearanceResponse&quot;)
public class ClearanceViolationPresentation extends ResourceSupport
{
    private List&lt;String&gt; violation = new ArrayList&lt;&gt;();
    private List&lt;String&gt; overrides = new ArrayList&lt;&gt;();
    private String userName;
    private Privilege requestedPrivilege;
    private List&lt;Duty&gt; dutiesForRequestedPrivilege;
    private Set&lt;Rule&gt; rules;
    private Map&lt;Duty, List&lt;Privilege&gt;&gt; dutyPrivilegeMap;
    private List&lt;Link&gt; links = new ArrayList&lt;&gt;();
    private List&lt;String&gt; tmdResponse = new ArrayList&lt;&gt;();


    public ClearanceViolationPresentation(String userName,
                                          Privilege requestedPrivilege,
                                          List&lt;Duty&gt; dutiesForRequestedPrivilege,
                                          Set&lt;Rule&gt; rules,
                                          Map&lt;Duty, List&lt;Privilege&gt;&gt; dutyPrivilegeMap) throws JSONException
    {
        this.userName = userName;
        this.requestedPrivilege = requestedPrivilege;
        this.dutiesForRequestedPrivilege = dutiesForRequestedPrivilege;
        this.rules = rules;
        this.dutyPrivilegeMap = dutyPrivilegeMap;

        formatViolation();
    }

    private void formatViolation() throws JSONException
    {
        String requestedPrivilegeDuties = dutiesForRequestedPrivilege.stream().map(Duty::getDutyName).collect(Collectors.joining(&quot;, &quot;));

        violation.add(String.format(&quot;Assignment of privilege &#39;%s&#39; [ID=%d, privilegeId=&#39;%s&#39;, Duties: &#39;%s&#39;] to user &#39;%s&#39; constitutes violation of rule(s) &#39;%s&#39;.&quot;,
                requestedPrivilege.getPrivilegeName(), requestedPrivilege.getID(), requestedPrivilege.getPrivilegeId(), requestedPrivilegeDuties,
                userName, rules.stream().map(Rule::getRuleName).collect(Collectors.joining(&quot;, &quot;))));


        for(Map.Entry&lt;Duty, List&lt;Privilege&gt;&gt; entry : dutyPrivilegeMap.entrySet())
        {
            if(entry.getValue().size() &gt; 0)
            {
                String privileges = entry.getValue().stream().map(Privilege::getPrivilegeName).collect(Collectors.joining(&quot;,&quot;));
                violation.add(String.format(&quot;User &#39;%s&#39; has following privileges that belong to Duty &#39;%s&#39;: %s&quot;,
                        userName, entry.getKey().getDutyName(), privileges));
            }
        }

        Set&lt;String&gt; privilegeOverrides = new HashSet&lt;&gt;();
        for(Rule rule : rules)
        {
            List&lt;Duty&gt; duties = rule.getDutyRulePairs().stream().map(DutyRulePair::getDuty).collect(Collectors.toList());
            for(Duty duty : duties)
            {
                if(!dutiesForRequestedPrivilege.contains(duty))
                {
                    List&lt;Privilege&gt; privileges = dutyPrivilegeMap.get(duty);
                    if(privileges != null)
                    {
                        String privilegeString = &quot;~&quot; + privileges.stream().map(Privilege::getID).map(String::valueOf).collect(Collectors.joining(&quot;~&quot;)) + &quot;~&quot;;
                        privilegeOverrides.add(privilegeString);
                    }
                }
            }
        }

        overrides.add(&quot;Request following SoD Privilege overrides:&quot;);
        for(String privilegeIds : privilegeOverrides)
        {
            overrides.add(String.format(&quot;PRIVILEGE_OVERRIDE@%s:~%d~&quot;, privilegeIds, requestedPrivilege.getID()));
        }
        overrides.add(&quot;Or following SoD Rule overrides:&quot;);
        for(Rule rule : rules)
        {
            overrides.add(String.format(&quot;RULE_OVERRIDE@%d&quot;, rule.getID()));
        }

        addLinks();

        tmdResponse.add(&quot;&lt;em&gt;Segregation Of Duties Violation&lt;/em&gt; :: User already has privileges covered by SOD rules that prevent this order from being submitted.&quot;);
        String allDutiesForRequestedPrivilege = dutiesForRequestedPrivilege.stream().map(Duty::getDutyName).collect(Collectors.joining(&quot;,&quot;));
        for(Rule rule : rules)
        {
            List&lt;DutyRulePair&gt; dutyRulePairList = rule.getDutyRulePairs();
            List&lt;Duty&gt; opposingDuties = dutyRulePairList.stream().map(DutyRulePair::getDuty).filter(d -&gt; !dutiesForRequestedPrivilege.contains(d)).collect(Collectors.toList());
            String allOpposingDuties = opposingDuties.stream().map(Duty::getDutyName).collect(Collectors.joining(&quot;,&quot;));

            tmdResponse.add(String.format(&quot;Rule in violation: %s.&quot;, rule.getRuleName()));
            tmdResponse.add(String.format(&quot;The requested privilege is duty classified as %s but &lt;b&gt;%s&lt;/b&gt; already has at least one privilege in conflict duty %s.&quot;,
                    allDutiesForRequestedPrivilege, userName, allOpposingDuties));
            tmdResponse.add(&quot;&lt;a href=\&quot;https://confluence.apg.services.gs.com/display/TECHRISK/SoD+TMD+Integration\&quot; &gt;Click here &lt;/a&gt; for more details.&quot;);
        }
    }

    private void addLinks() throws JSONException
    {
        for(Rule rule : rules)
        {
            links.add(linkTo(methodOn(RuleController.class).getRules(rule.getID())).withRel(&quot;rule&quot;).withTitle(rule.getRuleName()));
        }
        for(Duty duty : dutyPrivilegeMap.keySet())
        {
            links.add(linkTo(methodOn(DutyController.class).getDuties(duty.getID())).withRel(&quot;duty&quot;).withTitle(duty.getDutyName()));
        }

        links.add(linkTo(methodOn(PrivilegeController.class).getPrivilegesById(requestedPrivilege.getID())).withRel(&quot;requested-privilege&quot;).withTitle(requestedPrivilege.getPrivilegeName()));
        links.add(linkTo(methodOn(RmsComController.class).getComOverrides(userName)).withRel(&quot;kerberos-hierarchy&quot;));
    }

    public List&lt;String&gt; getViolation()
    {
        return violation;
    }

    public void setViolation(List&lt;String&gt; violation)
    {
        this.violation = violation;
    }

    public List&lt;String&gt; getOverrides()
    {
        return overrides;
    }

    public void setOverrides(List&lt;String&gt; overrides)
    {
        this.overrides = overrides;
    }

    @JsonIgnore
    public String getUserName()
    {
        return userName;
    }

    @JsonIgnore
    public Privilege getRequestedPrivilege()
    {
        return requestedPrivilege;
    }

    @JsonIgnore
    public Set&lt;Rule&gt; getRules()
    {
        return rules;
    }

    @JsonIgnore
    public List&lt;Duty&gt; getDutiesForRequestedPrivilege()
    {
        return dutiesForRequestedPrivilege;
    }

    @JsonIgnore
    public List&lt;Link&gt; getLinks()
    {
        return links;
    }

    @JsonIgnore
    public String getRejectReason()
    {
        String violationsString = violation.stream().collect(Collectors.joining(&quot;\n&quot;));
        String overridesString = overrides.stream().collect(Collectors.joining(&quot;\n&quot;));
        return violationsString + &quot;\n&quot; + overridesString;
    }

    public List&lt;String&gt; getTmdResponse()
    {
        return tmdResponse;
    }

    public void setTmdResponse(List&lt;String&gt; tmdResponse)
    {
        this.tmdResponse = tmdResponse;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class DutyPresentation extends ResourceSupport
{
    @JsonProperty
    private long dutyID;
    private String dutyName;
    private List&lt;Privilege&gt; privileges = new ArrayList&lt;&gt;();

    public DutyPresentation(Duty duty)
    {
        this.dutyID = duty.getID();
        this.dutyName = duty.getDutyName();
    }

    public DutyPresentation(Duty duty, List&lt;Privilege&gt; privileges)
    {
        this(duty);
        this.privileges = privileges;
    }

    protected DutyPresentation()
    {
    }


    public long getDutyID()
    {
        return dutyID;
    }

    public void setDutyID(long dutyID)
    {
        this.dutyID = dutyID;
    }

    public String getDutyName()
    {
        return dutyName;
    }

    public void setDutyName(String dutyName)
    {
        this.dutyName = dutyName;
    }

    public String getPrivileges()
    {
        if(!privileges.isEmpty())
        {
            return privileges.stream().map(Privilege::getPrivilegeName).collect(Collectors.joining(&quot;,&quot;));
        }
        return null;
    }

    public String getPrivilegeIDs()
    {
        if(!privileges.isEmpty())
        {
            return privileges.stream().map(Privilege::getID).map(String::valueOf).collect(Collectors.joining(&quot;,&quot;));
        }
        return null;
    }


    public void setPrivileges(List&lt;Privilege&gt; privileges)
    {
        this.privileges = privileges;
    }

    @Override
    public String toString()
    {
        return &quot;DutyPresentation{&quot; +
                &quot;ID=&quot; + dutyID +
                &quot;, dutyName=&#39;&quot; + dutyName + &#39;\&#39;&#39; +
                &quot;, privileges=&quot; + privileges +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class PrivilegePresentation
{
    private long ID;
    private String privilegeName;

    public PrivilegePresentation(Privilege privilege)
    {
        this.privilegeName = privilege.getPrivilegeName();
        this.ID = privilege.getID();
    }

    protected PrivilegePresentation()
    {
    }

    public long getID()
    {
        return ID;
    }

    public void setID(long ID)
    {
        this.ID = ID;
    }

    public String getPrivilegeName()
    {
        return privilegeName;
    }

    public void setPrivilegeName(String privilegeName)
    {
        this.privilegeName = privilegeName;
    }

    @Override
    public String toString()
    {
        return &quot;PrivilegePresentation{&quot; +
                &quot;privilegeName=&#39;&quot; + privilegeName + &#39;\&#39;&#39; +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class RulePresentation extends ResourceSupport
{
    @JsonProperty
    private long ID;
    private String ruleName;
    private String ruleType;
    private int controlId;


    public RulePresentation(Rule rule)
    {
        this.ID = rule.getID();
        this.ruleName = rule.getRuleName();
        this.ruleType = rule.getRuleType();
        this.controlId = rule.getControlId();
    }


    protected RulePresentation()
    {}

    public long getID()
    {
        return ID;
    }

    public void setID(int ID)
    {
        this.ID = ID;
    }

    public String getRuleName()
    {
        return ruleName;
    }

    public void setRuleName(String ruleName)
    {
        this.ruleName = ruleName;
    }

    public String getRuleType()
    {
        return ruleType;
    }

    public void setRuleType(String ruleType)
    {
        this.ruleType = ruleType;
    }

    public int getControlId()
    {
        return controlId;
    }

    public void setControlId(int controlId)
    {
        this.controlId = controlId;
    }

    @Override
    public String toString()
    {
        return &quot;RulePresentation{&quot; +
                &quot;ID=&quot; + ID +
                &quot;, ruleName=&#39;&quot; + ruleName + &#39;\&#39;&#39; +
                &quot;, ruleType=&#39;&quot; + ruleType + &#39;\&#39;&#39; +
                &quot;, controlId=&quot; + controlId +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class RuleViolationPresentation extends ResourceSupport
{
    private String status = &quot;Fail&quot;;
    private List&lt;String&gt; violation = new ArrayList&lt;&gt;();
    private String userName;
    private Rule rule;
    private Map&lt;Duty, List&lt;Privilege&gt;&gt; dutyPrivilegeMap;

    public RuleViolationPresentation(String userName, Rule rule, Map&lt;Duty, List&lt;Privilege&gt;&gt; dutyPrivilegeMap)
    {
        this.userName = userName;
        this.rule = rule;
        this.dutyPrivilegeMap = dutyPrivilegeMap;

        formatViolation();
    }

    private void formatViolation()
    {
        violation.add(String.format(&quot;Privileges assigned to user &#39;%s&#39; violates segregation rule &#39;%s&#39;.&quot;, userName, rule.getRuleName()));

        for(Map.Entry&lt;Duty, List&lt;Privilege&gt;&gt; e : dutyPrivilegeMap.entrySet())
        {
            Duty duty = e.getKey();

            List&lt;Rule&gt; rulesForDuty = duty.getDutyRulePairs().stream().map(DutyRulePair::getRule).collect(Collectors.toList());
            if(rulesForDuty.contains(rule))
            {
                List&lt;Privilege&gt; privileges = e.getValue();
                violation.add(String.format(&quot;User &#39;%s&#39; has following privileges that belong to Duty &#39;%s&#39;: %s&quot;,
                        userName, duty.getDutyName(), privileges.stream().map(Privilege::getPrivilegeName).map(String::valueOf).collect(Collectors.joining(&quot;,&quot;))));
            }
        }
   }


    protected RuleViolationPresentation()
    {}

    public List&lt;String&gt; getViolation()
    {
        return violation;
    }

    public void setViolation(List&lt;String&gt; violation)
    {
        this.violation = violation;
    }

    public String getStatus()
    {
        return status;
    }

    public void setStatus(String status)
    {
        this.status = status;
    }

    @JsonIgnore
    public String getUserName()
    {
        return userName;
    }

    @JsonIgnore
    public Rule getRule()
    {
        return rule;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class UserDutiesPresentation
{
    @JsonProperty
    private long userID;
    private String userName;
    private Set&lt;Duty&gt; duties;

    public UserDutiesPresentation(User user, Set&lt;Duty&gt; duties)
    {
        this.userID = user.getID();
        this.userName = user.getUserName();
        this.duties = duties;
    }

    public UserDutiesPresentation(String kerberos, Set&lt;Duty&gt; duties)
    {
        this.userID = 0;
        this.userName = kerberos;
        this.duties = duties;
    }


    protected UserDutiesPresentation()
    {
    }

    public long getUserID()
    {
        return userID;
    }

    public void setUserID(long userID)
    {
        this.userID = userID;
    }

    public String getUserName()
    {
        return userName;
    }

    public void setUserName(String userName)
    {
        this.userName = userName;
    }

    public String getDuties()
    {
        return duties.stream().map(Duty::getDutyName).collect(Collectors.joining(&quot;,&quot;));
    }

    public String getDutyIDs()
    {
        return duties.stream().map(Duty::getID).map(String::valueOf).collect(Collectors.joining(&quot;,&quot;));
    }

    @Override
    public String toString()
    {
        return &quot;UserDutiesPresentation{&quot; +
                &quot;userName=&#39;&quot; + userName + &#39;\&#39;&#39; +
                &quot;, duties=&quot; + duties +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class UserPrivilegesPresentation extends ResourceSupport
{
    @JsonProperty
    private long ID;
    private String userName;
    private List&lt;Privilege&gt; privileges;

    public UserPrivilegesPresentation(User user, List&lt;Privilege&gt; privileges)
    {
        this.ID = user.getID();
        this.userName = user.getUserName();
        this.privileges = privileges;
    }

    protected UserPrivilegesPresentation()
    {
    }

    public long getID()
    {
        return ID;
    }

    public void setID(long ID)
    {
        this.ID = ID;
    }

    public String getUserName()
    {
        return userName;
    }

    public void setUserName(String userName)
    {
        this.userName = userName;
    }

    public String getPrivileges()
    {
        return privileges.stream().map(Privilege::getPrivilegeName).collect(Collectors.joining(&quot;,&quot;));
    }

    public String getPrivilegeIDs()
    {
        return privileges.stream().map(Privilege::getID).map(String::valueOf).collect(Collectors.joining(&quot;,&quot;));
    }

    @Override
    public String toString()
    {
        return &quot;UserPrivilegesPresentation{&quot; +
                &quot;userName=&#39;&quot; + userName + &#39;\&#39;&#39; +
                 &quot;, privileges=&quot; + privileges +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="SoDImplementation-Repositories">Repositories</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public interface AuditTrailRepository extends JpaRepository&lt;AuditTrail, Integer&gt;
{
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public interface DutyPrivilegeMapRepository extends JpaRepository&lt;DutyPrivilegePair, Integer&gt;
{
    @Query(&quot;select m from DutyPrivilegePair m where DUTY_ID = :id and m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyPrivilegePair&gt; findByDutyId(@Param(&quot;id&quot;) long id);

    @Query(&quot;select m from DutyPrivilegePair m where PRIVILEGE_ID = :id and m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyPrivilegePair&gt; findByPrivilegeId(@Param(&quot;id&quot;) long id);

    @Query(&quot;select m from DutyPrivilegePair m where PRIVILEGE_ID IN :privilegeIdList and m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyPrivilegePair&gt; findByPrivilegeIdList(@Param(&quot;privilegeIdList&quot;) List&lt;Long&gt; privilegeIdList);

    @Query(&quot;select m from DutyPrivilegePair m where m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyPrivilegePair&gt; findAll();
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public interface DutyRepository extends JpaRepository&lt;Duty, Integer&gt;
{
    @Query(&quot;select d from Duty d where d.ID = :id and d.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    Optional&lt;Duty&gt; findById(@Param(&quot;id&quot;) long id);

    @Query(&quot;select d from Duty d where d.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;Duty&gt; findAll();
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public interface DutyRuleMapRepository extends JpaRepository&lt;DutyRulePair, Integer&gt;
{
    @Query(&quot;select m from DutyRulePair m where DUTY_ID = :id and m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyRulePair&gt; findByDutyId(@Param(&quot;id&quot;) long id);

    @Query(&quot;select m from DutyRulePair m where RULE_ID = :id and m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyRulePair&gt; findByRuleId(@Param(&quot;id&quot;) long id);

    @Query(&quot;select m from DutyRulePair m where DUTY_ID IN :dutyIdList and m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyRulePair&gt; findByDutyIdList(@Param(&quot;dutyIdList&quot;) List&lt;Long&gt; dutyIdList);

    @Query(&quot;select m from DutyRulePair m where DUTY_ID = :id and m.outUtc &lt; TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyRulePair&gt; findByAuditDutyId(@Param(&quot;id&quot;) long id);

    @Query(&quot;select m from DutyRulePair m where RULE_ID = :id and m.outUtc &lt; TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyRulePair&gt; findByAuditRuleId(@Param(&quot;id&quot;) long id);

    @Query(&quot;select m from DutyRulePair m where RULE_ID = :ruleId and DUTY_ID = :dutyId and m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    Optional&lt;DutyRulePair&gt; findByRuleDutyId(@Param(&quot;ruleId&quot;) long ruleId, @Param(&quot;dutyId&quot;) long dutyId);

    @Query(&quot;select m from DutyRulePair m where RULE_ID = :ruleId and DUTY_ID = :dutyId and m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyRulePair&gt; findHistoryByRuleDutyId(@Param(&quot;ruleId&quot;) long ruleId, @Param(&quot;dutyId&quot;) long dutyId);

    @Query(&quot;select m from DutyRulePair m where m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;DutyRulePair&gt; findAll();

    @Query(&quot;select m from DutyRulePair m&quot;)
    List&lt;DutyRulePair&gt; findAllWithAudit();
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public interface PrivilegeRepository extends JpaRepository&lt;Privilege, Integer&gt;
{
    @Query(&quot;select p from Privilege p where p.ID = :id and p.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    Optional&lt;Privilege&gt; findById(@Param(&quot;id&quot;) long id);

    @Query(&quot;select p from Privilege p where p.privilegeId = :id and p.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    Optional&lt;Privilege&gt; findByPrivilegeId(@Param(&quot;id&quot;) String id);

    @Query(&quot;select p from Privilege p where p.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;Privilege&gt; findAll();

    @Query(&quot;select p from Privilege p where ID IN :idList and p.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;Privilege&gt; findByIdList(@Param(&quot;idList&quot;) List&lt;Long&gt; idList);

    @Query(&quot;select p from Privilege p where PRIVILEGE_ID IN :privilegeIdList and p.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;Privilege&gt; findByPrivilegeIdList(@Param(&quot;privilegeIdList&quot;) List&lt;String&gt; privilegeIdList);
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public interface RuleRepository extends JpaRepository&lt;Rule, Integer&gt;
{
    @Query(&quot;select r from Rule r where r.ID = :id and r.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    Optional&lt;Rule&gt; findById(@Param(&quot;id&quot;) long id);

    @Query(&quot;select r from Rule r where r.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;Rule&gt; findAll();

    @Query(&quot;select DISTINCT (r.controlId) from Rule r where r.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;Integer&gt; findAllControlIDs();
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public interface UserPrivilegeMapRepository extends JpaRepository&lt;UserPrivilegePair, Integer&gt;
{
    @Query(&quot;select m from UserPrivilegePair m where USER_ID = :id and m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;UserPrivilegePair&gt; findByUserId(@Param(&quot;id&quot;) long id);

    @Query(&quot;select m from UserPrivilegePair m where PRIVILEGE_ID = :id and m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;UserPrivilegePair&gt; findByPrivilegeId(@Param(&quot;id&quot;) long id);

    @Query(&quot;select m from UserPrivilegePair m where m.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;UserPrivilegePair&gt; findAll();
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public interface UserRepository extends JpaRepository&lt;User, Integer&gt;
{
    @Query(&quot;select u from User u where u.ID = :id and u.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    Optional&lt;User&gt; findById(@Param(&quot;id&quot;) long id);

    @Query(&quot;select u from User u where u.outUtc = TO_DATE(&#39;9999-12-31&#39;, &#39;YYYY-MM-DD&#39;)&quot;)
    List&lt;User&gt; findAll();
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="SoDImplementation-Application">Application</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class SodOverridesApplication
{
   public static void main(String[] args)
   {
      TimeZone.setDefault(TimeZone.getTimeZone(&quot;UTC&quot;));
      SpringApplication.run(SodOverridesApplication.class, args);
   }
}</pre>
</div></div></td></tr></tbody></table></div><h1 id="SoDImplementation-Resources">Resources</h1><h2 id="SoDImplementation-application.properties">application.properties</h2><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">spring.jpa.show-sql=true
spring.h2.console.enabled=true
spring.datasource.url=jdbc:h2:mem:db

spring.profiles.include=external


spring.data.rest.defaultMediaType=application/json
spring.jackson.default-property-inclusion=NON_NULL

spring.jpa.properties.hibernate.jdbc.time_zone=UTC

management.endpoints.web.exposure.include=*
info.app.name=@project.name@
info.app.description=@project.description@
info.app.version=@project.version@
info.app.encoding=@project.build.sourceEncoding@
info.app.java.version=@java.version@

kerberos.asset.type.id=233
rmsnode.asset.type.id=431


# Enable following 4 lines to generate DDL statements (dialect may not be required)
#spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.DB2Dialect
#spring.jpa.properties.javax.persistence.schema-generation.create-source=metadata
#spring.jpa.properties.javax.persistence.schema-generation.scripts.action=create
#spring.jpa.properties.javax.persistence.schema-generation.scripts.create-target=create.sql

#logging.level.org.springframework=debug</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-application-db2.properties"><br/>application-db2.properties</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence"># running with this configuration may not work since Entity objects don&#39;t contain all fields and table names
# Specifically, rule and duty tables have fields named &quot;name&quot;, while this POC uses fields &quot;ruleName&quot; and &quot;dutyName&quot;
# of Privileges entity does not correspond to assignable
spring.profiles.include=ssl


spring.jpa.properties.hibernate.default_schema=SOD
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.DB2Dialect

datasource.url=jdbc:db2://nyg13qi8-vip.ny.fw.gs.com:56834/ntrkdi02
datasource.driver-class-name=com.ibm.db2.jcc.DB2Driver</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-application-external.properties"><br/>application-external.properties</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">peoplesearchByGuid.url=http://peoplesearch.web.gs.com:6119/GSPeopleSearch/GSPeopleSearch?gsguid=%s&amp;StrictSearch=true&amp;lang=json
peoplesearchByKerberos.url=http://peoplesearch.web.gs.com:6119/GSPeopleSearch/GSPeopleSearch?kerberos=%s&amp;StrictSearch=true&amp;lang=json


camp-entitlements.url=https://prod.services.camp.site.gs.com:8086/api/people/entitlements/%s

comGetKerberosOverride.url=https://autint0.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceuat-v1/exemption/finder/exemptionsFromAssetIds/${kerberos.asset.type.id}?activeOnly=false
comGetDepartmentOverride.url=https://autint0.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceuat-v1/exemption/finder/exemptionsFromAssetIds/${department.asset.type.id}?activeOnly=false
comGetRmsNodeOverride.url=https://autint0.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceuat-v1/exemption/finder/exemptionsFromAssetIds/${rmsnode.asset.type.id}?activeOnly=false
comGetControlIdUrl=https://autint0.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceuat-v1/exemption/finder/exemptionsFromControlId/%d?activeOnly=false

comSetOverride.url=https://autint0.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceuat-v1/exemption/save?isAutomaticExemption=false
comSetBulkOverride.url=https://autint0.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceuat-v1/exemption/exemptionbulkupload?isAutomaticExemption=false

comDeleteOverride.url=https://autint0.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceuat-v1/api/controlExemption/%d

rmsOrgMemberships.url=http://rms.web.gs.com:80/services/rest/api/v1/members/%s/orgmemberships

rmsHierarchy.url=http://rms.web.gs.com/services/rest/api/v1/nodes/CUSTOM_ORG/%s

rmsTeamMembers.url=http://rms.web.gs.com/services/rest/api/v1/nodes/CUSTOM_ORG/%s/orgmembers

control.url=https://prod.ext.rccatalog.site.gs.com:7443/rcc/api/ext/controlNode?id=%d

datasource.system.account.credref=a1c1bb4924d84c319a0142085fbbf840</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-application-gunern.properties"><br/>application-gunern.properties</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">spring.profiles.include=h2
spring.jpa.properties.hibernate.hbm2ddl.import_files=data-gunern.sql</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-application-h2.properties"><br/>application-h2.properties</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">spring.profiles.include=ssl</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-application-katzj.properties">application-katzj.properties<br/></h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">spring.profiles.include=h2
spring.jpa.properties.hibernate.hbm2ddl.import_files=data-katzj.sql</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-application-multiduty.properties"><br/>application-multiduty.properties</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">spring.profiles.include=h2
spring.jpa.properties.hibernate.hbm2ddl.import_files=data-multiduty.sql</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-application-prod.properties"><br/>application-prod.properties</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">kerberos.asset.type.id=135
com.approval.state=APPROVED

comGetKerberosOverride.url=https://prod.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceprod-v1/exemption/finder/exemptionsFromAssetIds/${kerberos.asset.type.id}?activeOnly=false
comGetDepartmentOverride.url=https://prod.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceprod-v1/exemption/finder/exemptionsFromAssetIds/${department.asset.type.id}?activeOnly=false
comGetRmsNodeOverride.url=https://prod.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceprod-v1/exemption/finder/exemptionsFromAssetIds/${rmsnode.asset.type.id}?activeOnly=false
comGetControlIdUrl=https://prod.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceprod-v1/exemption/finder/exemptionsFromControlId/%d?activeOnly=false

comSetOverride.url=https://autint0.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceprod-v1/exemption/save?isAutomaticExemption=false
comSetBulkOverride.url=https://prod.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceprod-v1/exemption/exemptionbulkupload?isAutomaticExemption=false
comDeleteOverride.url=https://prod.servicecloud.url.gs.com:9301/services/Risk-Measurement-Analytics/ControlExemptionManagerService/cemserviceprod-v1/api/controlExemption/%d</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-application-ssl.properties"><br/>application-ssl.properties</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">server.http.port=8081
server.port=8443
server.ssl.key-store-type=JKS
server.ssl.key-store=classpath:sod-test.jks
server.ssl.system.account.name=sod_build_test
server.ssl.system.account.credref=9264f331180146bdb758b34369a76f95</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-data-gunern.sql"><br/>data-gunern.sql</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">-- PRIVILEGES - Assigned
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, &#39;99999999-0000-9999-0000-000000000001&#39;, &#39;PA-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, &#39;99999999-0000-9999-0000-000000000002&#39;, &#39;PA-2&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, &#39;99999999-0000-9999-0000-000000000003&#39;, &#39;PA-3&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, &#39;99999999-0000-9999-0000-000000000004&#39;, &#39;PB-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(5, &#39;0005&#39;, &#39;99999999-0000-9999-0000-000000000005&#39;, &#39;PB-2&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(6, &#39;0006&#39;, &#39;99999999-0000-9999-0000-000000000006&#39;, &#39;PB-3&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(7, &#39;0007&#39;, &#39;99999999-0000-9999-0000-000000000007&#39;, &#39;PC-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(8, &#39;0008&#39;, &#39;99999999-0000-9999-0000-000000000008&#39;, &#39;PC-2&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(9, &#39;0009&#39;, &#39;99999999-0000-9999-0000-000000000009&#39;, &#39;PX-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(10, &#39;0010&#39;, &#39;99999999-0000-9999-0000-000000000010&#39;, &#39;PX-2&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(11, &#39;0011&#39;, &#39;99999999-0000-9999-0000-000000000011&#39;, &#39;PX-3&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(12, &#39;0012&#39;, &#39;99999999-0000-9999-0000-000000000012&#39;, &#39;PX-4&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(13, &#39;0013&#39;, &#39;99999999-0000-9999-0000-000000000013&#39;, &#39;PY-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(14, &#39;0014&#39;, &#39;99999999-0000-9999-0000-000000000014&#39;, &#39;PY-2&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(15, &#39;0015&#39;, &#39;99999999-0000-9999-0000-000000000015&#39;, &#39;PY-3&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
-- PRIVILEGES - with some privilegeIDs for gunern
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(16, &#39;0016&#39;, &#39;0ae42c11-422d-3715-bc94-c9f78997593d&#39;, &#39;PA-4&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(17, &#39;0017&#39;, &#39;6a4905df-96bd-3af8-80e1-d055148f30cc&#39;, &#39;PA-5&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(18, &#39;0018&#39;, &#39;99999999-0000-9999-0000-000000000018&#39;, &#39;PA-6&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(19, &#39;0019&#39;, &#39;99999999-0000-9999-0000-000000000019&#39;, &#39;PB-4&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(20, &#39;0020&#39;, &#39;99999999-0000-9999-0000-000000000020&#39;, &#39;PB-5&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(21, &#39;0021&#39;, &#39;99999999-0000-9999-0000-000000000021&#39;, &#39;PB-6&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(22, &#39;0022&#39;, &#39;79b5dd4a-34e4-3fc2-a615-7205a22015d1&#39;, &#39;PC-3&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(23, &#39;0023&#39;, &#39;b2614499-16b2-366b-a173-b8b28a9970fe&#39;, &#39;PC-4&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(24, &#39;0024&#39;, &#39;9bb85160-f4ba-384e-9c97-740b25bc7067&#39;, &#39;PC-5&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(25, &#39;0025&#39;, &#39;99999999-0000-9999-0000-000000000025&#39;, &#39;PC-6&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(26, &#39;0026&#39;, &#39;4ce2f981-7788-3df3-9671-6e541cc4d553&#39;, &#39;PX-5&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(27, &#39;0027&#39;, &#39;d4cf7c87-cb1d-36ea-94ad-67eeb3e6ad6d&#39;, &#39;PX-6&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(28, &#39;0028&#39;, &#39;99999999-0000-9999-0000-000000000028&#39;, &#39;PY-4&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(29, &#39;0029&#39;, &#39;99999999-0000-9999-0000-000000000029&#39;, &#39;PY-5&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(30, &#39;0030&#39;, &#39;99999999-0000-9999-0000-000000000030&#39;, &#39;PY-6&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
-- PRIVILEGES - Multi-Duty
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(31, &#39;0031&#39;, &#39;99999999-0000-9999-0000-000000000031&#39;, &#39;PAX-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(32, &#39;0032&#39;, &#39;99999999-0000-9999-0000-000000000032&#39;, &#39;PBY-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(33, &#39;0033&#39;, &#39;99999999-0000-9999-0000-000000000033&#39;, &#39;PAB-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)




-- DUTIES
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, &#39;Duty-A&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, &#39;Duty-B&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, &#39;Duty-C&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, &#39;Duty-X&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(5, &#39;0005&#39;, &#39;Duty-Y&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(6, &#39;0006&#39;, &#39;Duty-Z&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

-- RULES
INSERT INTO RULE(ID, AUDIT_ID, RULE_NAME, RULE_TYPE, CONTROL_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, &#39;Rule-AB&#39;, &#39;Segregation&#39;, 2097, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO RULE(ID, AUDIT_ID, RULE_NAME, RULE_TYPE, CONTROL_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, &#39;Rule-XY&#39;, &#39;Segregation&#39;, 2097, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO RULE(ID, AUDIT_ID, RULE_NAME, RULE_TYPE, CONTROL_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, &#39;Rule-Test&#39;, &#39;Segregation&#39;, 2097, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

-- DUTY_RULE_MAP
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, 1, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, 2, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, 4, 2, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, 5, 2, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

--  DUTY_PRIVILEGE_MAP
--  Duty-A
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, 1, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, 1, 2, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, 1, 3, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, 1, 31, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(5, &#39;0005&#39;, 1, 16, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(6, &#39;0006&#39;, 1, 17, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(7, &#39;0007&#39;, 1, 18, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  Duty-B
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(8, &#39;0008&#39;, 2, 4, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(9, &#39;0009&#39;, 2, 5, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(10, &#39;0010&#39;, 2, 6, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(11, &#39;0011&#39;, 2, 19, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(12, &#39;0012&#39;, 2, 20, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(13, &#39;0013&#39;, 2, 21, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(14, &#39;0014&#39;, 2, 32, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  Duty-C
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(15, &#39;0015&#39;, 3, 7, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(16, &#39;0016&#39;, 3, 8, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(17, &#39;0017&#39;, 3, 22, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(18, &#39;0018&#39;, 3, 23, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(19, &#39;0019&#39;, 3, 24, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(20, &#39;0020&#39;, 3, 25, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  Duty-X
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(21, &#39;0021&#39;, 4, 9, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(22, &#39;0022&#39;, 4, 10, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(23, &#39;0023&#39;, 4, 11, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(24, &#39;0024&#39;, 4, 12, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(25, &#39;0025&#39;, 4, 31, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(26, &#39;0026&#39;, 4, 26, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(27, &#39;0027&#39;, 4, 27, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  Duty-Y
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(28, &#39;0028&#39;, 5, 13, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(29, &#39;0029&#39;, 5, 14, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(30, &#39;0030&#39;, 5, 15, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(31, &#39;0031&#39;, 5, 28, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(32, &#39;0032&#39;, 5, 29, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(33, &#39;0033&#39;, 5, 30, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(34, &#39;0034&#39;, 5, 32, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  MultiDuty Privilege
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(35, &#39;0035&#39;, 1, 33, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(36, &#39;0036&#39;, 2, 33, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

-- USERS
INSERT INTO USER(ID, AUDIT_ID, USER_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, &#39;A&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER(ID, AUDIT_ID, USER_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, &#39;B&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER(ID, AUDIT_ID, USER_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, &#39;C&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER(ID, AUDIT_ID, USER_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, &#39;X&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER(ID, AUDIT_ID, USER_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(5, &#39;0005&#39;, &#39;Y&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER(ID, AUDIT_ID, USER_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(6, &#39;0006&#39;, &#39;gunern&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

-- USER_PRIVILEGE
--  A
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, 1, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, 1, 2, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, 1, 3, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  B
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, 2, 4, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(5, &#39;0005&#39;, 2, 5, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(6, &#39;0006&#39;, 2, 6, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  C
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(7, &#39;0007&#39;, 3, 7, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(8, &#39;0008&#39;, 3, 8, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  X
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(9, &#39;0009&#39;, 4, 9, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(10, &#39;0010&#39;, 4, 10, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(11, &#39;0011&#39;, 4, 11, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(12, &#39;0012&#39;, 4, 12, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(13, &#39;0013&#39;, 4, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  Y
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(14, &#39;0014&#39;, 5, 13, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(15, &#39;0015&#39;, 5, 14, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO USER_PRIVILEGE_MAP(ID, AUDIT_ID, USER_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(16, &#39;0016&#39;, 5, 15, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

--SEQUENCE
alter sequence HIBERNATE_SEQUENCE restart with 100</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-data-katzj.sql"><br/>data-katzj.sql</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">-- PRIVILEGES - with some privilegeIDs for katzj
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, &#39;f2ffc622-7b68-3263-953a-049acfb3a629&#39;, &#39;PA-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, &#39;69e16b4b-fbe1-3ebc-b441-4f17b2d3e198&#39;, &#39;PA-2&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, &#39;99999999-0000-9999-0000-000000000003&#39;, &#39;PA-3&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, &#39;b9e13e68-96e9-3a44-84b4-c7ec6d3b9596&#39;, &#39;PB-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(5, &#39;0005&#39;, &#39;61fc51ab-5e88-3962-b8bb-ec02a0e76b4c&#39;, &#39;PB-2&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(6, &#39;0006&#39;, &#39;99999999-0000-9999-0000-000000000006&#39;, &#39;PB-3&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(7, &#39;0007&#39;, &#39;f59a7f34-254a-3498-ad91-ba93b90e2023&#39;, &#39;PC-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(8, &#39;0008&#39;, &#39;99999999-0000-9999-0000-000000000008&#39;, &#39;PC-2&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(9, &#39;0009&#39;, &#39;99999999-0000-9999-0000-000000000009&#39;, &#39;PBC-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(10, &#39;0010&#39;, &#39;99999999-0000-9999-0000-000000000010&#39;, &#39;PAB-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)


-- DUTIES
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, &#39;Duty-A&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, &#39;Duty-B&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, &#39;Duty-C&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

-- RULES
INSERT INTO RULE(ID, AUDIT_ID, RULE_NAME, RULE_TYPE, CONTROL_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, &#39;Rule-AB&#39;, &#39;Segregation&#39;, 2097, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO RULE(ID, AUDIT_ID, RULE_NAME, RULE_TYPE, CONTROL_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, &#39;Rule-AC&#39;, &#39;Segregation&#39;, 2097, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

-- DUTY_RULE_MAP
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, 1, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, 2, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(5, &#39;0005&#39;, 1, 2, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(6, &#39;0006&#39;, 3, 2, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

--  DUTY_PRIVILEGE_MAP
--  Duty-A
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, 1, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, 1, 2, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, 1, 3, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, 1, 10, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  Duty-B
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(5, &#39;0005&#39;, 2, 4, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(6, &#39;0006&#39;, 2, 5, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(7, &#39;0007&#39;, 2, 6, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(8, &#39;0008&#39;, 2, 9, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(9, &#39;0009&#39;, 2, 10, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
--  Duty-C
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(10, &#39;0010&#39;, 3, 7, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(11, &#39;0011&#39;, 3, 8, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(12, &#39;0012&#39;, 3, 9, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)



--SEQUENCE
alter sequence HIBERNATE_SEQUENCE restart with 100</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-data-multiduty.sql"><br/>data-multiduty.sql</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, &#39;0ae42c11-422d-3715-bc94-c9f78997593d&#39;, &#39;PA-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, &#39;99999999-0000-9999-0000-000000000002&#39;, &#39;PB-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, &#39;6a4905df-96bd-3af8-80e1-d055148f30cc&#39;, &#39;PX-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, &#39;99999999-0000-9999-0000-000000000004&#39;, &#39;PY-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO PRIVILEGE(ID, AUDIT_ID, PRIVILEGE_ID, PRIVILEGE_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(5, &#39;0005&#39;, &#39;99999999-0000-9999-0000-000000000005&#39;, &#39;PBY-1&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, &#39;Duty-A&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, &#39;Duty-B&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, &#39;Duty-X&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY(ID, AUDIT_ID, DUTY_NAME, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, &#39;Duty-Y&#39;, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

INSERT INTO RULE(ID, AUDIT_ID, RULE_NAME, RULE_TYPE, CONTROL_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, &#39;Rule-AB&#39;, &#39;Segregation&#39;, 2097, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO RULE(ID, AUDIT_ID, RULE_NAME, RULE_TYPE, CONTROL_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, &#39;Rule-XY&#39;, &#39;Segregation&#39;, 2097, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, 1, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, 2, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, 3, 2, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_RULE_MAP(ID, AUDIT_ID, DUTY_ID, RULE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, 4, 2, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(1, &#39;0001&#39;, 1, 1, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(2, &#39;0002&#39;, 2, 2, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(3, &#39;0003&#39;, 3, 3, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(4, &#39;0004&#39;, 4, 4, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(5, &#39;0005&#39;, 2, 5, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)
INSERT INTO DUTY_PRIVILEGE_MAP(ID, AUDIT_ID, DUTY_ID, PRIVILEGE_ID, IN_UTC, OUT_UTC, created_by, last_modified_by) VALUES(6, &#39;0006&#39;, 4, 5, CURRENT_TIMESTAMP, &#39;9999-12-31&#39;, &#39;unknown&#39;, &#39;unknown&#39;)

--SEQUENCE
alter sequence HIBERNATE_SEQUENCE restart with 100</pre>
</div></div></td></tr></tbody></table></div><h3 id="SoDImplementation-gsauthn.sql"><br/>gsauthn.sql</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">authTypes=kerberos.securid
maxIdTokenLife=604800
useSessionTokens=true
maxSessionTokenLife=7200
sessionRefreshFrequency=halflife
autoGenerateSessionKey=true
idTokenName=GSSSO
checkClientIp=false
allowDirectConnections=true
usingGUID=false
allowTestID=false
allowRemoteUser=false
gelEnabled=false
tokenDomain=.gs.com
publicKeysFromURL=true
publicKeyFileURL=https://webid.is.gs.com/public-keys/public.key


</pre>
</div></div></td></tr></tbody></table></div><h1 id="SoDImplementation-POM.XML">POM.XML</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
   xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
   &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
   &lt;parent&gt;
      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
      &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
      &lt;version&gt;2.1.9.RELEASE&lt;/version&gt;
      &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
   &lt;/parent&gt;
   &lt;groupId&gt;com.sod.overrides&lt;/groupId&gt;
   &lt;artifactId&gt;sod-overrides&lt;/artifactId&gt;
   &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
   &lt;name&gt;sod-overrides&lt;/name&gt;
   &lt;description&gt;SoD Overrides POC&lt;/description&gt;

   &lt;properties&gt;
      &lt;java.version&gt;1.8&lt;/java.version&gt;
   &lt;/properties&gt;

   &lt;dependencies&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
         &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
         &lt;artifactId&gt;spring-boot-starter-data-rest&lt;/artifactId&gt;
      &lt;/dependency&gt;

      &lt;dependency&gt;
         &lt;groupId&gt;com.h2database&lt;/groupId&gt;
         &lt;artifactId&gt;h2&lt;/artifactId&gt;
         &lt;scope&gt;runtime&lt;/scope&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
         &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
         &lt;scope&gt;test&lt;/scope&gt;
      &lt;/dependency&gt;
        &lt;!--
         &lt;dependency&gt;
             &lt;groupId&gt;com.gs.spring&lt;/groupId&gt;
             &lt;artifactId&gt;gs-spring-boot-security&lt;/artifactId&gt;
             &lt;version&gt;2.1.4&lt;/version&gt;
         &lt;/dependency&gt;
        --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
            &lt;artifactId&gt;spring-security-core&lt;/artifactId&gt;
            &lt;version&gt;5.2.0.RELEASE&lt;/version&gt;
        &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;com.gs.opstech.common&lt;/groupId&gt;
         &lt;artifactId&gt;gsknex-security&lt;/artifactId&gt;
         &lt;version&gt;3.8.1&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;com.gs.spring&lt;/groupId&gt;
         &lt;artifactId&gt;gs-spring-boot-authenticator&lt;/artifactId&gt;
         &lt;version&gt;2.1.4&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;com.ibm.db2&lt;/groupId&gt;
         &lt;artifactId&gt;db2jcc4&lt;/artifactId&gt;
         &lt;version&gt;10.5.7.3.69.49&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;com.gs.spring&lt;/groupId&gt;
         &lt;artifactId&gt;gs-spring-boot-credential-vault&lt;/artifactId&gt;
         &lt;version&gt;2.1.7&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;com.vaadin.external.google&lt;/groupId&gt;
         &lt;artifactId&gt;android-json&lt;/artifactId&gt;
         &lt;version&gt;RELEASE&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
         &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;javax.interceptor&lt;/groupId&gt;
         &lt;artifactId&gt;javax.interceptor-api&lt;/artifactId&gt;
         &lt;version&gt;1.2.2&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;!--
      &lt;dependency&gt;
         &lt;groupId&gt;org.springframework.data&lt;/groupId&gt;
         &lt;artifactId&gt;spring-data-rest-hal-browser&lt;/artifactId&gt;
      &lt;/dependency&gt;
        --&gt;
   &lt;/dependencies&gt;

   &lt;build&gt;
      &lt;plugins&gt;
         &lt;plugin&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
         &lt;/plugin&gt;
      &lt;/plugins&gt;
   &lt;/build&gt;

&lt;/project&gt;</pre>
</div></div></td></tr></tbody></table></div>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Feb 12, 2021 23:35</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
