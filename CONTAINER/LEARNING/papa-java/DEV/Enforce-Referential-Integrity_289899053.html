<!DOCTYPE html>
<html>
    <head>
        <title>DevOps : Enforce Referential Integrity</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Home_603226548.html">DevOps Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_278921431.html">Tutorials</a></span>
                            </li>
                                                    <li>
                                <span><a href="Spring-Boot_278888737.html">Spring Boot</a></span>
                            </li>
                                                    <li>
                                <span><a href="Basic_289898911.html">Basic</a></span>
                            </li>
                                                    <li>
                                <span><a href="Library-Application-Example_289866546.html">Library Application Example</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps : Enforce Referential Integrity
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicholas Guner</span>, last modified on Apr 20, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p><code>Reader</code> Entity objects have a <code>ManyToOne</code> relationship with <code>Phone</code> Entity objects. Thus, we would not be able to delete a User object without first deleting Phone objects associated with that User.</p><p>We should also not be able to delete <code>Book</code> entity objects without first deleting a mapping in the READER_BOOK_MAP table between <code>Reader</code> and <code>Book</code> objects since these objects are in the <code>ManyToMany</code> relationship.  However, at this time, there is nothing to prevent us from deleting a <code>Book</code> object and to break the referential integrity:</p><p><br/>Enforce Referential Constraints Between READER, BOOK, and USER_BOOK_MAP Tables</p><h3 id="EnforceReferentialIntegrity-ChangeallEntityObjectstoUseSEQUENCE">Change all Entity Objects to Use SEQUENCE</h3><p>Change:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>From:</strong></p></th><td class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@GeneratedValue(strategy = GenerationType.IDENTITY)</pre>
</div></div></td></tr><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>To:</strong></p></th><td class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@GeneratedValue(strategy = GenerationType.SEQUENCE)</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h3 id="EnforceReferentialIntegrity-AddExplicitSchemaDefinition">Add Explicit Schema Definition</h3><p>To setup referential constraints, we need to provide the schema. Currently, our in-memory database is populated from records in <code>data.sql</code> file</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">-- USER
INSERT INTO USER(ID, name, type) VALUES(1, &#39;nick&#39;, &#39;employee&#39;)
INSERT INTO USER(ID, name, type) VALUES(2, &#39;paul&#39;, &#39;student&#39;)
INSERT INTO USER(ID, name, type) VALUES(3, &#39;sam&#39;, &#39;retired&#39;)
INSERT INTO USER(ID, name, type) VALUES(4, &#39;mary&#39;, &#39;employee&#39;)
INSERT INTO USER(ID, name, type) VALUES(5, &#39;jim&#39;, &#39;contractor&#39;)

--BOOK
INSERT INTO BOOK(ID, title, author) VALUES(1, &#39;Tom Sawyer&#39;, &#39;Mark Twain&#39;)
INSERT INTO BOOK(ID, title, author) VALUES(2, &#39;Catch 22&#39;, &#39;Joseph Heller&#39;)
INSERT INTO BOOK(ID, title, author) VALUES(3, &#39;War and Peace&#39;, &#39;Lev Tolstoy&#39;)

--READER-BOOK-MAP
INSERT INTO READER_BOOK_MAP(ID, READER_ID, BOOK_ID) VALUES(1, 1, 1)
INSERT INTO READER_BOOK_MAP(ID, READER_ID, BOOK_ID) VALUES(2, 1, 2)
INSERT INTO READER_BOOK_MAP(ID, READER_ID, BOOK_ID) VALUES(3, 2, 2)
INSERT INTO READER_BOOK_MAP(ID, READER_ID, BOOK_ID) VALUES(4, 2, 3)
INSERT INTO READER_BOOK_MAP(ID, READER_ID, BOOK_ID) VALUES(5, 3, 2)
INSERT INTO READER_BOOK_MAP(ID, READER_ID, BOOK_ID) VALUES(6, 4, 3)


-- PHONE
INSERT INTO PHONE(ID, phone_number, type, USER_ID) VALUES(1, &#39;212-456-9876&#39;, &#39;home&#39;, 1)
INSERT INTO PHONE(ID, phone_number, type, USER_ID) VALUES(2, &#39;201-444-9888&#39;, &#39;mobile&#39;, 1)
INSERT INTO PHONE(ID, phone_number, type, USER_ID) VALUES(3, &#39;917-751-0947&#39;, &#39;mobile&#39;, 2)
INSERT INTO PHONE(ID, phone_number, type, USER_ID) VALUES(4, &#39;845-765-0912&#39;, &#39;home&#39;, 3)
INSERT INTO PHONE(ID, phone_number, type, USER_ID) VALUES(5, &#39;203-754-6387&#39;, &#39;mobile&#39;, 3)
INSERT INTO PHONE(ID, phone_number, type, USER_ID) VALUES(6, &#39;212-532-1111&#39;, &#39;home&#39;, 4)
INSERT INTO PHONE(ID, phone_number, type, USER_ID) VALUES(7, &#39;201-432-9899&#39;, &#39;mobile&#39;, 5)</pre>
</div></div></td></tr></tbody></table></div><p>We will also add a schema file where we will need to explicitly define DDL commands for every table:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">create table READER (ID int not null, name varchar(255), type varchar(255))
create table BOOK (ID int not null, title varchar(255), author varchar(255))
create table READER_BOOK_MAP(ID int not null,  READER_ID int not null, BOOK_ID int not null)
create table PHONE (ID int not null, phone_number varchar(255), type varchar(255), READER_ID int not null)

alter table READER add constraint READER_PK primary key(ID)
alter table BOOK add constraint BOOK_PK primary key(ID)
alter table PHONE add constraint PHONE_PK primary key(ID)
alter table PHONE add constraint PHONE_READER_ID_CONSTRAINT foreign key (READER_ID) references  READER

alter table READER_BOOK_MAP add constraint READER_BOOK_MAP_PK primary key(ID)
alter table READER_BOOK_MAP add constraint READER_ID_CONSTRAINT foreign key (READER_ID) references  READER
alter table READER_BOOK_MAP add constraint BOOK_ID_CONSTRAINT foreign key (BOOK_ID) references  BOOK


create sequence HIBERNATE_SEQUENCE start with 100 increment by 1 no maxvalue</pre>
</div></div></td></tr></tbody></table></div><p>NOTE the presence of <code>HERNATE_SEQUENCE</code> which needs to be executed along with other DDL commands.</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td class="confluenceTd"><p><strong>create sequence HIBERNATE_SEQUENCE start with 100 increment by 1 no maxvalue</strong></p></td></tr></tbody></table></div><p><br/></p><h3 id="EnforceReferentialIntegrity-TurnAuto-SchemaGenerationOff">Turn Auto-Schema Generation Off</h3><p>We will also need to turn automatic DDL definitions off:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">...
spring.jpa.hibernate.ddl-auto=none</pre>
</div></div></td></tr></tbody></table></div><h2 id="EnforceReferentialIntegrity-TryDeletingReaderorBook">Try Deleting Reader or Book</h2><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Description</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>DELETE URL</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th></tr><tr><td class="confluenceTd"><p>Delete User/Book</p></td><td class="confluenceTd"><p><br/></p><p><code>localhost:8080/readers/1localhost:8080/books/1</code></p><p><br/></p></td><td class="confluenceTd"><p><br/></p><p><code>{</code><br/><code> &quot;timestamp&quot;: &quot;2019-10-07T20:21:56.429+0000&quot;,</code><br/><code> &quot;message&quot;: &quot;could not execute statement; SQL [n/a]; constraint [\&quot;PHONE_READER_ID_CONSTRAINT: PUBLIC.PHONE FOREIGN KEY(READER_ID) REFERENCES PUBLIC.READER(ID) (1)\&quot;; SQL statement:\ndelete from reader where id=? [23503-199]]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement&quot;,</code><br/><code> &quot;details&quot;: &quot;uri=/readers/1&quot;</code><br/><code>}</code></p><p><code>{</code><br/><code> &quot;timestamp&quot;: &quot;2019-10-07T20:21:40.300+0000&quot;,</code><br/><code> &quot;message&quot;: &quot;could not execute statement; SQL [n/a]; constraint [\&quot;BOOK_ID_CONSTRAINT: PUBLIC.READER_BOOK_MAP FOREIGN KEY(BOOK_ID) REFERENCES PUBLIC.BOOK(ID) (1)\&quot;; SQL statement:\ndelete from book where id=? [23503-199]]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement&quot;,</code><br/><code> &quot;details&quot;: &quot;uri=/books/1&quot;</code><br/><code>}</code></p><p><br/></p></td></tr></tbody></table></div><p>Consult data in the READER_BOOK_MAP table</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image confluence-external-resource image-center" src="https://confluence.apg.services.gs.com/download/thumbnails/609784160/image2019-10-7_16-23-25.png?version=1&amp;modificationDate=1570479805975&amp;api=v2" data-image-src="https://confluence.apg.services.gs.com/download/thumbnails/609784160/image2019-10-7_16-23-25.png?version=1&amp;modificationDate=1570479805975&amp;api=v2" loading="lazy"></span><p>If we delete Books with id=1 and id=2 from Reader with id=1 from READER_BOOK_MAP, we should be able to delete Bood with id=1 and Reader with id=1.</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td class="confluenceTd"><p>DELETE Commands</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">localhost:8080/readers/1/books/1
localhost:8080/readers/1/books/2
localhost:8080/books/1</pre>
</div></div><p><code>localhost:8080/readers/1</code></p><p><br/></p></td></tr></tbody></table></div><p>Running above commands we were able to delete Book with id=1 but we could not delete the Reader with id=1</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image confluence-external-resource image-center" src="https://confluence.apg.services.gs.com/download/thumbnails/609784160/image2019-10-1_15-50-48.png?version=1&amp;modificationDate=1570479671599&amp;api=v2" data-image-src="https://confluence.apg.services.gs.com/download/thumbnails/609784160/image2019-10-1_15-50-48.png?version=1&amp;modificationDate=1570479671599&amp;api=v2" loading="lazy"></span><p><br/></p><p>Now that Book with id=1 and Reader with id=1 are no longer in the READER_BOOK_MAP, we should be able to delete Book with id=1 and User with id=1 because of active records in the Phone table:</p><p>and if we try, will will see the constraint violation</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>DELETE Command</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th></tr><tr><td class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">localhost:8080/readers/1</pre>
</div></div></td><td class="confluenceTd"><p><code>{</code><br/><code> &quot;timestamp&quot;: &quot;2019-10-07T20:29:05.189+0000&quot;,</code><br/><code> &quot;message&quot;: &quot;could not execute statement; SQL [n/a]; constraint [\&quot;PHONE_READER_ID_CONSTRAINT: PUBLIC.PHONE FOREIGN KEY(READER_ID) REFERENCES PUBLIC.READER(ID) (1)\&quot;; SQL statement:\ndelete from reader where id=? [23503-199]]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement&quot;,</code><br/><code> &quot;details&quot;: &quot;uri=/readers/1&quot;</code><br/><code>}</code></p></td></tr></tbody></table></div><p>After deleting all Phones from Reader with id=1</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td class="confluenceTd"><p>Commands</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">localhost:8080/readers/1/phones/1
localhost:8080/readers/1/phones/2</pre>
</div></div><p><br/></p></td></tr></tbody></table></div><p>We should be able to delete the Reader with id=1</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td class="confluenceTd"><p>DELETE Command</p></td><td class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">localhost:8080/readers/1</pre>
</div></div></td></tr></tbody></table></div><p>We can verify that Reader with id=1 is deleted with the GET Command:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>GET Command</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th></tr><tr><td class="confluenceTd"><p><a href="http://localhost:8080/users/1" class="external-link" rel="nofollow">http://localhost:8080/readers/1</a></p></td><td class="confluenceTd"><p><code>{</code><br/><code> &quot;timestamp&quot;: &quot;2019-10-07T20:31:57.107+0000&quot;,</code><br/><code> &quot;message&quot;: &quot;id-1&quot;,</code><br/><code> &quot;details&quot;: &quot;uri=/readers/1&quot;</code><br/><code>}</code></p></td></tr></tbody></table></div><p />
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Feb 12, 2021 23:35</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
