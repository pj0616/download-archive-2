<!DOCTYPE html>
<html>
    <head>
        <title>DevOps : Add POST, PUT, and DELETE to Single Entity Controllers</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Home_603226548.html">DevOps Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_278921431.html">Tutorials</a></span>
                            </li>
                                                    <li>
                                <span><a href="Project-Profit-Application_315097089.html">Project Profit Application</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps : Add POST, PUT, and DELETE to Single Entity Controllers
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicholas Guner</span> on Apr 28, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>Single entity controllers, such as <code>EmployeeController, ProjectController,</code> and <code>SubscriptionController</code> should support 5 methods: GET-ALL, GET-ONE, POST, PUT, and DELETE.</p><p>Add POST, PUT, and DELETE to Single Entity Controllers</p><p>We present code for one of the controllers. Other entity controllers would be implemented in the same way.</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">...
@PostMapping(&quot;/employees&quot;)
public ResponseEntity&lt;?&gt; createEmployee(@RequestBody Employee employee)
{
    employeeRepository.save(employee);
    URI location = ServletUriComponentsBuilder
            .fromCurrentRequest()
            .path(&quot;/{id}&quot;)
            .buildAndExpand(employee.getID()).toUri();
    return ResponseEntity.created(location).build();
}
@PutMapping(&quot;/employees/{id}&quot;)
public ResponseEntity&lt;?&gt; updateEmployee(@PathVariable(&quot;id&quot;) int id, @RequestBody Employee employee)
{
    Optional&lt;Employee&gt; existingEmployeeOptional = employeeRepository.findById(id);
    if(!existingEmployeeOptional.isPresent())
    {
        throw new NotFoundException(&quot;employee-&quot; + id);
    }
    Employee existingEmployee = existingEmployeeOptional.get();
    if(StringUtils.hasText(employee.getEmployeeCode()))
    {
        existingEmployee.setEmployeeCode(employee.getEmployeeCode());
    }
    if(StringUtils.hasText(employee.getEmployeeName()))
    {
        existingEmployee.setEmployeeName(employee.getEmployeeName());
    }
    employeeRepository.save(existingEmployee);
    URI location = ServletUriComponentsBuilder
            .fromCurrentRequest()
            .buildAndExpand(existingEmployee).toUri();
    return ResponseEntity.created(location).build();
}
@DeleteMapping(&quot;/employees/{id}&quot;)
public ResponseEntity&lt;?&gt; deleteEmployee(@PathVariable(&quot;id&quot;) int id)
{
    Optional&lt;Employee&gt; existingEmployeeOptional = employeeRepository.findById(id);
    if(!existingEmployeeOptional.isPresent())
    {
        throw new NotFoundException(&quot;employee-&quot; + id);
    }
    Employee employee = existingEmployeeOptional.get();
    employeeRepository.delete(employee);
    URI location = ServletUriComponentsBuilder
            .fromCurrentRequest()
            .buildAndExpand().toUri();
    return ResponseEntity.created(location).build();
}
...</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><p>Note the error message when we attempt to delete an employee who is mapped to active projects and subscriptions:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><colgroup><col style="width: 189.0px;"/><col style="width: 569.0px;"/></colgroup><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>DELETE Request</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th></tr><tr><td class="confluenceTd"><p>localhost:8080/employees/1</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;timestamp&quot;: &quot;2020-04-28T08:26:14.317-04:00&quot;,
  &quot;message&quot;: &quot;could not execute statement; SQL [n/a]; constraint [\&quot;FKAL2GM8LSBT7626JGT5BGRJLQU: PUBLIC.EMPLOYEE_SUBSCRIPTION_MAP FOREIGN KEY(EMPLOYEE_ID) REFERENCES PUBLIC.EMPLOYEE(ID) (1)\&quot;; SQL statement:\ndelete from employee where id=? [23503-199]]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement&quot;,
  &quot;details&quot;: &quot;uri=/employees/1&quot;
}</pre>
</div></div><p><br/></p></td></tr></tbody></table></div><p><br/></p><p>On a positive note, JPA did not delete a record which would violate the referential constraint. However, the error message leaves a lot to be desired. Let's add a few custom exceptions and modify our delete method:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@ResponseStatus(HttpStatus.FAILED_DEPENDENCY)
public class EmployeeViolationException extends RuntimeException
{
    public EmployeeViolationException(String message)
    {
        super(message);
    }
}


@ResponseStatus(HttpStatus.FAILED_DEPENDENCY)
public class ProjectViolationException extends RuntimeException
{
    public ProjectViolationException(String message)
    {
        super(message);
    }
}


@ResponseStatus(HttpStatus.FAILED_DEPENDENCY)
public class SubscriptionViolationException extends RuntimeException
{
    public SubscriptionViolationException(String message)
    {
        super(message);
    }

}


@ControllerAdvice
@RestController
public class CustomizedResponseEntityExceptionHandler extends ResponseEntityExceptionHandler
{
    @ExceptionHandler(Exception.class)
    public final ResponseEntity&lt;Object&gt; handleAllExceptions(Exception ex, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), ex.getMessage(), request.getDescription(false));
        return new ResponseEntity(exceptionResponse, HttpStatus.INTERNAL_SERVER_ERROR);
    }


    @ExceptionHandler(NotFoundException.class)
    public final ResponseEntity&lt;Object&gt; handleReaderNotFoundException(NotFoundException ex, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), ex.getMessage(),
                request.getDescription(false));
        return new ResponseEntity(exceptionResponse, HttpStatus.NOT_FOUND);
    }

    @ExceptionHandler(ProjectViolationException.class)
    public final ResponseEntity&lt;Object&gt; handleProjectViolationException(ProjectViolationException ex, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), ex.getMessage(),
                request.getDescription(false));
        return new ResponseEntity(exceptionResponse, HttpStatus.FAILED_DEPENDENCY);
    }

    @ExceptionHandler(EmployeeViolationException.class)
    public final ResponseEntity&lt;Object&gt; handleEmployeeViolationException(EmployeeViolationException ex, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), ex.getMessage(),
                request.getDescription(false));
        return new ResponseEntity(exceptionResponse, HttpStatus.FAILED_DEPENDENCY);
    }

    @ExceptionHandler(SubscriptionViolationException.class)
    public final ResponseEntity&lt;Object&gt; handleSubscriptionViolationException(SubscriptionViolationException ex, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), ex.getMessage(),
                request.getDescription(false));
        return new ResponseEntity(exceptionResponse, HttpStatus.FAILED_DEPENDENCY);
    }

    @Override
    protected ResponseEntity&lt;Object&gt; handleMethodArgumentNotValid(MethodArgumentNotValidException ex,
                                                                  HttpHeaders headers, HttpStatus status, WebRequest request)
    {
        ExceptionResponse exceptionResponse = new ExceptionResponse(ZonedDateTime.now(), &quot;Validation Failed&quot;,
                ex.getBindingResult().toString());
        return new ResponseEntity(exceptionResponse, HttpStatus.BAD_REQUEST);
    }
}

</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">...
@DeleteMapping(&quot;/employees/{id}&quot;)
public ResponseEntity&lt;?&gt; deleteEmployee(@PathVariable(&quot;id&quot;) int id)
{
    List&lt;ProjectEmployeePair&gt; projectEmployeePairs = projectEmployeeMapRepository.findByEmployeeId(id);
    if(!projectEmployeePairs.isEmpty())
    {
        throw new ProjectViolationException(&quot;projects exist for employee-&quot; + id);
    }
    List&lt;EmployeeSubscriptionPair&gt; employeeSubscriptionPairs = employeeSubscriptionMapRepository.findByEmployeeId(id);
    if(!employeeSubscriptionPairs.isEmpty())
    {
        throw new SubscriptionViolationException(&quot;subscription exist for employee-&quot; + id);
    }
    Optional&lt;Employee&gt; existingEmployeeOptional = employeeRepository.findById(id);
    if(!existingEmployeeOptional.isPresent())
    {
        throw new NotFoundException(&quot;employee-&quot; + id);
    }
    Employee employee = existingEmployeeOptional.get();
    employeeRepository.delete(employee);
    URI location = ServletUriComponentsBuilder
            .fromCurrentRequest()
            .buildAndExpand().toUri();
    return ResponseEntity.created(location).build();
}
...</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><p><br/></p><p>Now, when we try to delete an employee who is currently mapped to a project or subscription, we see a more instructive error message:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><colgroup><col style="width: 252.0px;"/><col style="width: 442.0px;"/><col style="width: 64.0px;"/></colgroup><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>DELETE Request</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Status</strong></p></th></tr><tr><td class="confluenceTd"><p>localhost:8080/employees/1</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;timestamp&quot;: &quot;2020-04-28T08:47:24.845-04:00&quot;,
  &quot;message&quot;: &quot;projects exist for employee-1&quot;,
  &quot;details&quot;: &quot;uri=/employees/1&quot;
}</pre>
</div></div><p><br/></p></td><td class="confluenceTd"><p>424</p></td></tr><tr><td class="confluenceTd"><p>localhost:8080/employees/5</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;timestamp&quot;: &quot;2020-04-28T08:52:50.249-04:00&quot;,
  &quot;message&quot;: &quot;subscription exist for employee-5&quot;,
  &quot;details&quot;: &quot;uri=/employees/5&quot;
}</pre>
</div></div><p><br/></p></td><td class="confluenceTd"><p>424</p></td></tr><tr><td class="confluenceTd"><p>localhost:8080/employees/6</p></td><td class="confluenceTd"><p><br/></p></td><td class="confluenceTd"><p>201</p></td></tr></tbody></table></div><p><br/></p><h1 id="AddPOST,PUT,andDELETEtoSingleEntityControllers-ErroroncreatingnewentitieswithPOST">Error on creating new entities with POST</h1><p>After implementing required methods, we try to create a new entity object with a POST methods</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><colgroup><col style="width: 175.0px;"/><col style="width: 330.0px;"/><col style="width: 253.0px;"/></colgroup><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>POST Request</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>POST Body</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th></tr><tr><td class="confluenceTd"><p>localhost:8080/projects</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;projectName&quot;: &quot;P-X&quot;,
  &quot;projectDescription&quot;: &quot;Project X&quot;
}</pre>
</div></div><p><br/></p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;timestamp&quot;: &quot;2020-04-28T09:36:34.656-04:00&quot;,
  &quot;message&quot;: &quot;could not execute statement; SQL [n/a]; constraint [\&quot;PRIMARY KEY ON PUBLIC.PROJECT(ID) [1, &#39;Project one&#39;, &#39;P-1&#39;]\&quot;; SQL statement:\ninsert into project (project_description, project_name, id) values (?, ?, ?) [23505-199]]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement&quot;,
  &quot;details&quot;: &quot;uri=/projects&quot;
}</pre>
</div></div><p><br/></p></td></tr></tbody></table></div><p>The reason for this error is because our in-memory database already has objects with ID of 1 but our POST method knows nothing about it. We need to modify HIBERNATE_SEQUENCE to start at a higher number:</p><p>data.sql</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">...
alter sequence HIBERNATE_SEQUENCE restart with 101</pre>
</div></div></td></tr></tbody></table></div><p />
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Feb 12, 2021 23:36</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
