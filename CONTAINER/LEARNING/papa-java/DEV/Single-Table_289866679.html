<!DOCTYPE html>
<html>
    <head>
        <title>DevOps : Single Table</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Home_603226548.html">DevOps Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_278921431.html">Tutorials</a></span>
                            </li>
                                                    <li>
                                <span><a href="Spring-Boot_278888737.html">Spring Boot</a></span>
                            </li>
                                                    <li>
                                <span><a href="Basic_289898911.html">Basic</a></span>
                            </li>
                                                    <li>
                                <span><a href="295075841.html">Inheritance (with HATEOAS Links)</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps : Single Table
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicholas Guner</span> on Apr 20, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>Let us consider a hierarchy of products like Books and Pens. We will designate Product as an abstract base class and have Book and Pen Derive from Product.</p><p>We will use a single-table strategy with a discriminator column. We create an in-memory database using following statements:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">--BOOK
INSERT INTO PRODUCT(product_id, name, author, product_type) VALUES(1, &#39;Tom Sawyer&#39;, &#39;Mark Twain&#39;, &#39;Book&#39;)
INSERT INTO PRODUCT(product_id, name, author, product_type) VALUES(2, &#39;Catch 22&#39;, &#39;Joseph Heller&#39;, &#39;Book&#39;)
INSERT INTO PRODUCT(product_id, name, author, product_type) VALUES(3, &#39;War and Peace&#39;, &#39;Lev Tolstoy&#39;, &#39;Book&#39;)

--PEN
INSERT INTO PRODUCT(product_id, name, color, product_type) VALUES(4, &#39;ballpoint&#39;, &#39;blue&#39;, &#39;Pen&#39;)
INSERT INTO PRODUCT(product_id, name, color, product_type) VALUES(5, &#39;marker&#39;, &#39;red&#39;, &#39;Pen&#39;)
INSERT INTO PRODUCT(product_id, name, color, product_type) VALUES(6, &#39;felt-tip&#39;, &#39;green&#39;, &#39;Pen&#39;)</pre>
</div></div></td></tr></tbody></table></div><p>We also need to add properties to enable in-memory H2 database</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">spring.jpa.show-sql=true
spring.h2.console.enabled=true
spring.datasource.url=jdbc:h2:mem:db

spring.data.rest.defaultMediaType=application/json
spring.jackson.default-property-inclusion=NON_NULL</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><p>After our application starts, we can view the state of the in-memory database:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><colgroup><col style="width: 112.0px;"/><col style="width: 646.0px;"/></colgroup><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>URL:</strong></p></th><td class="confluenceTd"><p><a href="http://localhost:8080/h2-console" class="external-link" rel="nofollow">http://localhost:8080/h2-console</a></p></td></tr><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Display:</strong></p></th><td class="confluenceTd"><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image confluence-external-resource image-center" src="https://confluence.apg.services.gs.com/download/attachments/606027935/image2019-10-4_16-35-17.png?version=1&amp;modificationDate=1570221317673&amp;api=v2" data-image-src="https://confluence.apg.services.gs.com/download/attachments/606027935/image2019-10-4_16-35-17.png?version=1&amp;modificationDate=1570221317673&amp;api=v2" loading="lazy"></span></td></tr></tbody></table></div><h2 id="SingleTable-EntityObjects">Entity Objects</h2><h3 id="SingleTable-ProductEntity">Product Entity</h3><p>Note field marked with <code>@Column</code> annotation which will be used as the discriminator.</p><div class="table-wrap"><table data-layout="wide" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@Inheritance(strategy = InheritanceType.SINGLE_TABLE)
@DiscriminatorFormula(&quot;case when author is not null then &#39;Book&#39; else &#39;Pen&#39; end&quot;)
public abstract class Product extends ResourceSupport
{
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private int productId;
    private String name;
    @Column(insertable=false, updatable=false)
    private String productType;


    public int getProductId()
    {
        return productId;
    }

    public void setProductId(int productId)
    {
        this.productId = productId;
    }

    public String getName()
    {
        return name;
    }

    public void setName(String name)
    {
        this.name = name;
    }

    public String getProductType()
    {
        return productType;
    }

    public void setProductType(String productType)
    {
        this.productType = productType;
    }

    @Override
    public String toString()
    {
        return &quot;Product{&quot; +
                &quot;productId=&quot; + productId +
                &quot;, name=&#39;&quot; + name + &#39;\&#39;&#39; +
                &quot;, productType=&quot; + productType +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h3 id="SingleTable-BookandPenEntities">Book and Pen Entities</h3><p>Book</p><div class="table-wrap"><table data-layout="wide" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@DiscriminatorValue(&quot;Book&quot;)
public class Book extends Product
{
    private String author;

    public String getAuthor()
    {
        return author;
    }

    public void setAuthor(String author)
    {
        this.author = author;
    }

    @Override
    public String toString()
    {
        return &quot;Book{&quot; +
                &quot;author=&#39;&quot; + author + &#39;\&#39;&#39; +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><p>Pen</p><div class="table-wrap"><table data-layout="wide" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@DiscriminatorValue(&quot;Pen&quot;)
public class Pen extends Product
{
    private String color;

    public String getColor()
    {
        return color;
    }

    public void setColor(String color)
    {
        this.color = color;
    }

    @Override
    public String toString()
    {
        return &quot;Pen{&quot; +
                &quot;color=&#39;&quot; + color + &#39;\&#39;&#39; +
                &#39;}&#39;;
    }
}</pre>
</div></div></td></tr></tbody></table></div><h2 id="SingleTable-Controllers">Controllers</h2><p>We will create three controllers to demonstrate various methods of retrieving data.</p><h3 id="SingleTable-CriteriaController">Criteria Controller</h3><p>Use JPA Criteria API when you need to construct queries dynamically.</p><div class="table-wrap"><table data-layout="wide" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RestController
@RepositoryRestController
public class CriteriaController
{
    @Autowired
    private EntityManager entityManager;

    @GetMapping(&quot;/cri/products&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getProducts()
    {
        CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
        CriteriaQuery&lt;Product&gt; productQuery = criteriaBuilder.createQuery(Product.class);
        Root&lt;Product&gt; productRoot = productQuery.from(Product.class);
        productQuery.select(productRoot);

        TypedQuery&lt;Product&gt; typedQuery = entityManager.createQuery(productQuery);
        List&lt;Product&gt; products = typedQuery.getResultList();

        List&lt;Product&gt; linkedProducts = products.stream()
                .map(p -&gt; {p.add(linkTo(methodOn(getClass()).getProducts()).slash( &quot;/&quot; + p.getProductId()).withSelfRel()); return p;})
                .collect(Collectors.toList());


        Resources&lt;Product&gt; resources = new Resources&lt;&gt;(linkedProducts);
        resources.add(linkTo(methodOn(getClass()).getBooks()).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    @GetMapping(&quot;/cri/products/{id}&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getProduct(@PathVariable(&quot;id&quot;) int id)
    {

        Product product = entityManager.find(Product.class, id);
        Resource&lt;Product&gt; resource = new Resource&lt;&gt;(product);
        resource.add(linkTo(methodOn(getClass()).getProduct(id)).withSelfRel());
        return ResponseEntity.ok(resource);
    }


    @GetMapping(&quot;/cri/books&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getBooks()
    {
        CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
        CriteriaQuery&lt;Book&gt; productQuery = criteriaBuilder.createQuery(Book.class);
        Root&lt;Product&gt; productRoot = productQuery.from(Product.class);
        Root&lt;Book&gt; bookRoot = criteriaBuilder.treat(productRoot, Book.class);
        productQuery.select(bookRoot);

        TypedQuery&lt;Book&gt; typedQuery = entityManager.createQuery(productQuery);
        List&lt;Book&gt; books = typedQuery.getResultList();

        List&lt;Book&gt; linkedBooks = books.stream()
                .map(b -&gt; {b.add(linkTo(methodOn(getClass()).getBooks()).slash( &quot;/&quot; + b.getProductId()).withSelfRel()); return b;})
                .collect(Collectors.toList());


        Resources&lt;Book&gt; resources = new Resources&lt;&gt;(linkedBooks);
        resources.add(linkTo(methodOn(getClass()).getBooks()).withSelfRel());
        return ResponseEntity.ok(resources);
    }


    @GetMapping(&quot;/cri/books/{id}&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getBook(@PathVariable(&quot;id&quot;) int id)
    {

        Book book = entityManager.find(Book.class, id);
        Resource&lt;Book&gt; resource = new Resource&lt;&gt;(book);
        resource.add(linkTo(methodOn(getClass()).getBook(id)).withSelfRel());
        return ResponseEntity.ok(resource);
    }

    @GetMapping(&quot;/cri/pens&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getPens()
    {
        CriteriaBuilder criteriaBuilder = entityManager.getCriteriaBuilder();
        CriteriaQuery&lt;Pen&gt; productQuery = criteriaBuilder.createQuery(Pen.class);
        Root&lt;Product&gt; productRoot = productQuery.from(Product.class);
        Root&lt;Pen&gt; penRoot = criteriaBuilder.treat(productRoot, Pen.class);
        productQuery.select(penRoot);

        TypedQuery&lt;Pen&gt; typedQuery = entityManager.createQuery(productQuery);
        List&lt;Pen&gt; pens = typedQuery.getResultList();

        List&lt;Pen&gt; linkedPens = pens.stream()
                .map(p -&gt; {p.add(linkTo(methodOn(getClass()).getPens()).slash( &quot;/&quot; + p.getProductId()).withSelfRel()); return p;})
                .collect(Collectors.toList());


        Resources&lt;Pen&gt; resources = new Resources&lt;&gt;(linkedPens);
        resources.add(linkTo(methodOn(getClass()).getBooks()).withSelfRel());
        return ResponseEntity.ok(resources);
    }


    @GetMapping(&quot;/cri/pens/{id}&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getPen(@PathVariable(&quot;id&quot;) int id)
    {

        Pen pen = entityManager.find(Pen.class, id);
        Resource&lt;Pen&gt; resource = new Resource&lt;&gt;(pen);
        resource.add(linkTo(methodOn(getClass()).getPen(id)).withSelfRel());
        return ResponseEntity.ok(resource);
    }
}</pre>
</div></div></td></tr></tbody></table></div><h3 id="SingleTable-CriteriaControllerTests">Criteria Controller Tests</h3><div class="table-wrap"><table data-layout="wide" class="confluenceTable"><colgroup><col style="width: 268.0px;"/><col style="width: 692.0px;"/></colgroup><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Request</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th></tr><tr><td class="confluenceTd"><p>localhost:8080/cri/products</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/cri/books&quot;
    }
  ],
  &quot;content&quot;: [
    {
      &quot;name&quot;: &quot;Tom Sawyer&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Mark Twain&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/products/1&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;Catch 22&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Joseph Heller&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/products/2&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;War and Peace&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Lev Tolstoy&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/products/3&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;ballpoint&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;blue&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/products/4&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;marker&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;red&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/products/5&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;felt-tip&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;green&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/products/6&quot;
        }
      ]
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr><tr><td class="confluenceTd"><p>localhost:8080/cri/books</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/cri/books&quot;
    }
  ],
  &quot;content&quot;: [
    {
      &quot;name&quot;: &quot;Tom Sawyer&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Mark Twain&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/books/1&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;Catch 22&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Joseph Heller&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/books/2&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;War and Peace&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Lev Tolstoy&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/books/3&quot;
        }
      ]
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr><tr><td class="confluenceTd"><p>localhost:8080/cri/pens</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/cri/books&quot;
    }
  ],
  &quot;content&quot;: [
    {
      &quot;name&quot;: &quot;ballpoint&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;blue&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/pens/4&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;marker&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;red&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/pens/5&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;felt-tip&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;green&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/cri/pens/6&quot;
        }
      ]
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr><tr><td class="confluenceTd"><p><a href="http://localhost:8080/cri/products/1" class="external-link" rel="nofollow">http://localhost:8080/cri/products/1</a></p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;name&quot;: &quot;Tom Sawyer&quot;,
  &quot;productType&quot;: &quot;Book&quot;,
  &quot;author&quot;: &quot;Mark Twain&quot;,
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/cri/products/1&quot;
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr><tr><td class="confluenceTd"><p><a href="http://localhost:8080/cri/books/1" class="external-link" rel="nofollow">http://localhost:8080/cri/books/1</a></p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;name&quot;: &quot;Tom Sawyer&quot;,
  &quot;productType&quot;: &quot;Book&quot;,
  &quot;author&quot;: &quot;Mark Twain&quot;,
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/cri/books/1&quot;
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr><tr><td class="confluenceTd"><p><a href="http://localhost:8080/cri/pens/4" class="external-link" rel="nofollow">http://localhost:8080/cri/pens/4</a></p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;name&quot;: &quot;ballpoint&quot;,
  &quot;productType&quot;: &quot;Pen&quot;,
  &quot;color&quot;: &quot;blue&quot;,
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/cri/pens/4&quot;
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr></tbody></table></div><p><br/></p><p><br/></p><h3 id="SingleTable-JPQLController">JPQL Controller</h3><p>JPQL is a Hibernate version of SQL</p><div class="table-wrap"><table data-layout="wide" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RestController
@RepositoryRestController
public class JpqlController
{
    @Autowired
    private EntityManager entityManager;

    @GetMapping(&quot;/jpql/books&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getBooks()
    {
        List&lt;Book&gt; books = entityManager.createQuery(&quot;SELECT p FROM Product p WHERE TREAT(p As Book).productType = &#39;Book&#39;&quot;).getResultList();

        List&lt;Book&gt; linkedBooks = books.stream()
                .map(b -&gt; {b.add(linkTo(methodOn(getClass()).getBooks()).slash( &quot;/&quot; + b.getProductId()).withSelfRel()); return b;})
                .collect(Collectors.toList());

        Resources&lt;Book&gt; resources = new Resources&lt;&gt;(linkedBooks);
        resources.add(linkTo(methodOn(getClass()).getBooks()).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    @GetMapping(&quot;/jpql/books/{id}&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getBook(@PathVariable(&quot;id&quot;) int id)
    {

        Book book = entityManager.find(Book.class, id);
        Resource&lt;Book&gt; resource = new Resource&lt;&gt;(book);
        resource.add(linkTo(methodOn(getClass()).getBook(id)).withSelfRel());
        return ResponseEntity.ok(resource);
    }

    @GetMapping(&quot;/jpql/pens&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getPens()
    {
        List&lt;Pen&gt; pens = entityManager.createQuery(&quot;SELECT p FROM Product p WHERE TREAT(p As Pen).productType = &#39;Pen&#39;&quot;).getResultList();

        List&lt;Pen&gt; linkedPens = pens.stream()
                .map(p -&gt; {p.add(linkTo(methodOn(getClass()).getPens()).slash( &quot;/&quot; + p.getProductId()).withSelfRel()); return p;})
                .collect(Collectors.toList());

        Resources&lt;Pen&gt; resources = new Resources&lt;&gt;(linkedPens);
        resources.add(linkTo(methodOn(getClass()).getPens()).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    @GetMapping(&quot;/jpql/pens/{id}&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getPen(@PathVariable(&quot;id&quot;) int id)
    {

        Pen pen = entityManager.find(Pen.class, id);
        Resource&lt;Pen&gt; resource = new Resource&lt;&gt;(pen);
        resource.add(linkTo(methodOn(getClass()).getPen(id)).withSelfRel());
        return ResponseEntity.ok(resource);
    }
}</pre>
</div></div></td></tr></tbody></table></div><h3 id="SingleTable-JPQLControllerTests">JPQL Controller Tests</h3><div class="table-wrap"><table data-layout="wide" class="confluenceTable"><colgroup><col style="width: 316.0px;"/><col style="width: 644.0px;"/></colgroup><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Requests</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Responses</strong></p></th></tr><tr><td class="confluenceTd"><p><a href="http://localhost:8080/jpql/books" class="external-link" rel="nofollow">http://localhost:8080/jpql/books</a></p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/jpql/books&quot;
    }
  ],
  &quot;content&quot;: [
    {
      &quot;name&quot;: &quot;Tom Sawyer&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Mark Twain&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/jpql/books/1&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;Catch 22&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Joseph Heller&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/jpql/books/2&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;War and Peace&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Lev Tolstoy&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/jpql/books/3&quot;
        }
      ]
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr><tr><td class="confluenceTd"><p><a href="http://localhost:8080/jpql/pens" class="external-link" rel="nofollow">http://localhost:8080/jpql/pens</a></p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/jpql/pens&quot;
    }
  ],
  &quot;content&quot;: [
    {
      &quot;name&quot;: &quot;ballpoint&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;blue&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/jpql/pens/4&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;marker&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;red&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/jpql/pens/5&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;felt-tip&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;green&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/jpql/pens/6&quot;
        }
      ]
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr><tr><td class="confluenceTd"><p><a href="http://localhost:8080/jpql/books/1" class="external-link" rel="nofollow">http://localhost:8080/jpql/books/1</a></p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;name&quot;: &quot;Tom Sawyer&quot;,
  &quot;productType&quot;: &quot;Book&quot;,
  &quot;author&quot;: &quot;Mark Twain&quot;,
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/jpql/books/1&quot;
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr><tr><td class="confluenceTd"><p><a href="http://localhost:8080/jpql/pens/4" class="external-link" rel="nofollow">http://localhost:8080/jpql/pens/4</a></p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;name&quot;: &quot;ballpoint&quot;,
  &quot;productType&quot;: &quot;Pen&quot;,
  &quot;color&quot;: &quot;blue&quot;,
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/jpql/pens/4&quot;
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr></tbody></table></div><p><br/></p><p><br/></p><h3 id="SingleTable-RepositoryController">Repository Controller</h3><p>We can still use JPARepository interface and define custom queries with JPQL</p><p>We will create two Repository interfaces, for Books and Pens, respectively.</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RepositoryRestResource
public interface BookRepository extends JpaRepository&lt;Book, Integer&gt;
{
    @Query(&quot;SELECT p FROM Product p WHERE TREAT(p As Book).productType = &#39;Book&#39;&quot;)
    List&lt;Book&gt; findAll();
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RepositoryRestResource
public interface PenRepository extends JpaRepository&lt;Pen, Integer&gt;
{
    @Query(&quot;SELECT p FROM Product p WHERE TREAT(p As Pen).productType = &#39;Pen&#39;&quot;)
    List&lt;Pen&gt; findAll();
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RestController
@RepositoryRestController
public class RepoController
{
    @Autowired
    private BookRepository bookRepository;
    @Autowired
    private PenRepository penRepository;


    @GetMapping(&quot;/repo/books&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getBooks()
    {
        List&lt;Book&gt; books = bookRepository.findAll();

        List&lt;Book&gt; linkedBooks = books.stream()
                .map(b -&gt; {b.add(linkTo(methodOn(getClass()).getBooks()).slash( &quot;/&quot; + b.getProductId()).withSelfRel()); return b;})
                .collect(Collectors.toList());

        Resources&lt;Book&gt; resources = new Resources&lt;&gt;(linkedBooks);
        resources.add(linkTo(methodOn(getClass()).getBooks()).withSelfRel());
        return ResponseEntity.ok(resources);
    }

    @GetMapping(&quot;/repo/pens&quot;)
    public @ResponseBody
    ResponseEntity&lt;?&gt; getPens()
    {
        List&lt;Pen&gt; pens = penRepository.findAll();

        List&lt;Pen&gt; linkedPens = pens.stream()
                .map(p -&gt; {p.add(linkTo(methodOn(getClass()).getBooks()).slash( &quot;/&quot; + p.getProductId()).withSelfRel()); return p;})
                .collect(Collectors.toList());

        Resources&lt;Pen&gt; resources = new Resources&lt;&gt;(linkedPens);
        resources.add(linkTo(methodOn(getClass()).getPens()).withSelfRel());
        return ResponseEntity.ok(resources);
    }
}</pre>
</div></div></td></tr></tbody></table></div><h3 id="SingleTable-RepositoryControllerTests">Repository Controller Tests</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><colgroup><col style="width: 262.0px;"/><col style="width: 496.0px;"/></colgroup><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Requests</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Responses</strong></p></th></tr><tr><td class="confluenceTd"><p><a href="http://localhost:8080/repo/books" class="external-link" rel="nofollow">http://localhost:8080/repo/books</a></p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/repo/books&quot;
    }
  ],
  &quot;content&quot;: [
    {
      &quot;name&quot;: &quot;Tom Sawyer&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Mark Twain&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/repo/books/1&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;Catch 22&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Joseph Heller&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/repo/books/2&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;War and Peace&quot;,
      &quot;productType&quot;: &quot;Book&quot;,
      &quot;author&quot;: &quot;Lev Tolstoy&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/repo/books/3&quot;
        }
      ]
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr><tr><td class="confluenceTd"><p><a href="http://localhost:8080/repo/pens" class="external-link" rel="nofollow">http://localhost:8080/repo/pens</a></p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">{
  &quot;links&quot;: [
    {
      &quot;rel&quot;: &quot;self&quot;,
      &quot;href&quot;: &quot;http://localhost:8080/repo/pens&quot;
    }
  ],
  &quot;content&quot;: [
    {
      &quot;name&quot;: &quot;ballpoint&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;blue&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/repo/books/4&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;marker&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;red&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/repo/books/5&quot;
        }
      ]
    },
    {
      &quot;name&quot;: &quot;felt-tip&quot;,
      &quot;productType&quot;: &quot;Pen&quot;,
      &quot;color&quot;: &quot;green&quot;,
      &quot;links&quot;: [
        {
          &quot;rel&quot;: &quot;self&quot;,
          &quot;href&quot;: &quot;http://localhost:8080/repo/books/6&quot;
        }
      ]
    }
  ]
}</pre>
</div></div><p><br/></p></td></tr></tbody></table></div><p />
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Feb 12, 2021 23:35</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
