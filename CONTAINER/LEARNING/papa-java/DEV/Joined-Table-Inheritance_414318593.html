<!DOCTYPE html>
<html>
    <head>
        <title>DevOps : Joined Table Inheritance</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Home_603226548.html">DevOps Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_278921431.html">Tutorials</a></span>
                            </li>
                                                    <li>
                                <span><a href="Project-Profit-Application_315097089.html">Project Profit Application</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps : Joined Table Inheritance
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicholas Guner</span> on Jun 03, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>SeeÂ <a href="https://confluence.apg.services.gs.com/display/~gunern/Joined+Table" class="external-link" rel="nofollow">Joined Table</a></p><h1 id="JoinedTableInheritance-DatainWorker,Employee,andConsultantTables">Data in Worker, Employee, and Consultant Tables</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Worker</strong></p></th><td class="confluenceTd"><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image confluence-external-resource image-center" src="https://confluence.apg.services.gs.com/download/attachments/773988234/image2020-6-2_7-34-25.png?version=1&amp;modificationDate=1591097665194&amp;api=v2" data-image-src="https://confluence.apg.services.gs.com/download/attachments/773988234/image2020-6-2_7-34-25.png?version=1&amp;modificationDate=1591097665194&amp;api=v2" loading="lazy"></span></td></tr><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Employee</strong></p></th><td class="confluenceTd"><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image confluence-external-resource image-center" src="https://confluence.apg.services.gs.com/download/thumbnails/773988234/image2020-6-2_7-35-12.png?version=1&amp;modificationDate=1591097712141&amp;api=v2" data-image-src="https://confluence.apg.services.gs.com/download/thumbnails/773988234/image2020-6-2_7-35-12.png?version=1&amp;modificationDate=1591097712141&amp;api=v2" loading="lazy"></span></td></tr><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Consultant</strong></p></th><td class="confluenceTd"><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image confluence-external-resource image-center" src="https://confluence.apg.services.gs.com/download/thumbnails/773988234/image2020-6-2_7-35-52.png?version=1&amp;modificationDate=1591097752102&amp;api=v2" data-image-src="https://confluence.apg.services.gs.com/download/thumbnails/773988234/image2020-6-2_7-35-52.png?version=1&amp;modificationDate=1591097752102&amp;api=v2" loading="lazy"></span></td></tr></tbody></table></div><h1 id="JoinedTableInheritance-newin-memorydatabase">new in-memory database</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">...
-- EMPLOYEES
INSERT INTO EMPLOYEE(ID, BENE_CODE) VALUES(1, &#39;BENE-1&#39;)
INSERT INTO EMPLOYEE(ID, BENE_CODE) VALUES(2, &#39;BENE-1&#39;)
INSERT INTO EMPLOYEE(ID, BENE_CODE) VALUES(3, &#39;BENE-2&#39;)

-- CONSULTANTS
INSERT INTO CONSULTANT(ID, AGENCY_CODE) VALUES(4, &#39;AGENCY-1&#39;)
INSERT INTO CONSULTANT(ID, AGENCY_CODE) VALUES(5, &#39;AGENCY-2&#39;)
INSERT INTO CONSULTANT(ID, AGENCY_CODE) VALUES(6, &#39;AGENCY-3&#39;)
...</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="JoinedTableInheritance-entityclasses(newandmodified)">entity classes (new and modified)</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Entity
@Inheritance(strategy = InheritanceType.JOINED)
@Table(uniqueConstraints={
        @UniqueConstraint(columnNames = {&quot;auditId&quot;, &quot;out_utc&quot;})
})
public class Worker extends BaseEntity
{
    @Id
    @GeneratedValue(strategy = GenerationType.SEQUENCE)
    @Column(name=&quot;ID&quot;, updatable = false, nullable = false)
    @JsonProperty
    private int ID;
    private String auditId = UUID.randomUUID().toString();
    private String workerCode;
    private String workerName;
    private double compensation;
    @JsonIgnore
    @OneToMany(mappedBy = &quot;worker&quot;)
    private List&lt;ProjectWorkerPair&gt; projectWorkerPairs = new ArrayList&lt;&gt;();
    @JsonIgnore
    @OneToMany(mappedBy = &quot;worker&quot;)
    private List&lt;WorkerSubscriptionPair&gt; workerSubscriptionPairs = new ArrayList&lt;&gt;();
    @Transient
    private List&lt;Subscription&gt; subscriptions;
    @Transient
    private List&lt;Project&gt; projects;

    //  Constructor for the audit record
    public Worker(Worker other)
    {
        super();
        this.auditId = other.auditId;
        this.workerCode = other.workerCode;
        this.workerName = other.workerName;
        this.setOutUtc(ZonedDateTime.now());
        this.setInUtc(other.getInUtc());
    }

    public Worker()
    {
        super();
    }

    public Worker(int id, String workerCode, String workerName, double compensation)
    {
        this.ID = id;
        this.workerCode = workerCode;
        this.workerName = workerName;
        this.compensation = compensation;
    }


    public int getID()
    {
        return ID;
    }

    public void setID(int ID)
    {
        this.ID = ID;
    }

    public String getWorkerCode()
    {
        return workerCode;
    }

    public void setWorkerCode(String workerCode)
    {
        this.workerCode = workerCode;
    }

    public String getWorkerName()
    {
        return workerName;
    }

    public void setWorkerName(String workerName)
    {
        this.workerName = workerName;
    }

    public double getCompensation()
    {
        return compensation;
    }

    public void setCompensation(double compensation)
    {
        this.compensation = compensation;
    }

    public List&lt;ProjectWorkerPair&gt; getProjectWorkerPairs()
    {
        return projectWorkerPairs;
    }

    public void setProjectWorkerPairs(List&lt;ProjectWorkerPair&gt; projectWorkerPairs)
    {
        this.projectWorkerPairs = projectWorkerPairs;
    }

    public List&lt;WorkerSubscriptionPair&gt; getWorkerSubscriptionPairs()
    {
        return workerSubscriptionPairs;
    }

    public void setWorkerSubscriptionPairs(List&lt;WorkerSubscriptionPair&gt; workerSubscriptionPairs)
    {
        this.workerSubscriptionPairs = workerSubscriptionPairs;
    }

    public String getAuditId()
    {
        return auditId;
    }

    public void setAuditId(String auditId)
    {
        this.auditId = auditId;
    }

    public List&lt;Subscription&gt; getSubscriptions()
    {
        return subscriptions;
    }

    public void setSubscriptions(List&lt;Subscription&gt; subscriptions)
    {
        this.subscriptions = subscriptions;
    }

    public List&lt;Project&gt; getProjects()
    {
        return projects;
    }

    public void setProjects(List&lt;Project&gt; projects)
    {
        this.projects = projects;
    }

    @Override
    public boolean equals(Object o)
    {
        if (this == o) return true;
        if (o == null || getClass() != o.getClass()) return false;
        if (!super.equals(o)) return false;
        Worker worker = (Worker) o;
        return ID == worker.ID &amp;&amp;
                Objects.equals(workerCode, worker.workerCode) &amp;&amp;
                Objects.equals(workerName, worker.workerName);
    }

    @Override
    public int hashCode()
    {
        return Objects.hash(super.hashCode(), ID, workerCode, workerName);
    }
}


@Entity
public class Employee extends Worker
{
    private String beneCode;

    //  Required by the mapping controllers
    public Employee()
    {
        super();
    }

    //  Default Constructor needed for the audit controller
    public Employee(Employee other)
    {
        super(other);
        this.beneCode = other.getBeneCode();
    }

    public String getBeneCode()
    {
        return beneCode;
    }

    public void setBeneCode(String beneCode)
    {
        this.beneCode = beneCode;
    }
}


@Entity
public class Consultant extends Worker
{
    private String agencyCode;

    //  Required by the mapping controllers
    public Consultant()
    {
        super();
    }

    //  Default Constructor needed for the audit controller
    public Consultant(Consultant other)
    {
        super(other);
        this.agencyCode = other.getAgencyCode();
    }

    public String getAgencyCode()
    {
        return agencyCode;
    }

    public void setAgencyCode(String agencyCode)
    {
        this.agencyCode = agencyCode;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p>Note change on Worker to enable Joined table inheritance.</p><h1 id="JoinedTableInheritance-dtonewobjects">dto new objects</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class ConsultantDTO extends WorkerDTO
{
    private String agencyCode;

    public ConsultantDTO(Consultant consultant)
    {
        setWorkerID(consultant.getID());
        setWorkerCode(consultant.getWorkerCode());
        setWorkerName(consultant.getWorkerName());
        setCompensation(consultant.getCompensation());
        this.agencyCode = consultant.getAgencyCode();
    }

    public ConsultantDTO()
    {
    }

    public String getAgencyCode()
    {
        return agencyCode;
    }

    public void setAgencyCode(String agencyCode)
    {
        this.agencyCode = agencyCode;
    }
}


public class EmployeeDTO extends WorkerDTO
{
    private String beneCode;

    public EmployeeDTO(Employee employee)
    {
        setWorkerID(employee.getID());
        setWorkerCode(employee.getWorkerCode());
        setWorkerName(employee.getWorkerName());
        setCompensation(employee.getCompensation());
        this.beneCode = employee.getBeneCode();
    }

    public EmployeeDTO()
    {
    }

    public String getBeneCode()
    {
        return beneCode;
    }

    public void setBeneCode(String beneCode)
    {
        this.beneCode = beneCode;
    }
}</pre>
</div></div></td></tr></tbody></table></div><h1 id="JoinedTableInheritance-repoobjects">repo objects</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public interface ConsultantRepository extends JpaRepository&lt;Consultant, Integer&gt;
{
    @Query(&quot;from Consultant where id =:id and outUtc = &quot; + BaseEntity.DATE_INFINITY_STRING)
    Optional&lt;Consultant&gt; findById(@Param(&quot;id&quot;) int id);

    @Query(&quot;from Consultant where id =:id&quot;)
    Optional&lt;Consultant&gt; findAllById(@Param(&quot;id&quot;) int id);

    @Query(&quot;from Consultant where outUtc = &quot; + BaseEntity.DATE_INFINITY_STRING)
    List&lt;Consultant&gt; findAll();

    @Query(&quot;from Consultant where auditId =:auditId&quot;)
    List&lt;Consultant&gt; findByAuditId(@Param(&quot;auditId&quot;) String auditId);

    @Query(&quot;from Consultant&quot;)
    List&lt;Consultant&gt; findAllWithAudit();

    @Query(&quot;from Consultant where outUtc &lt;&gt; &quot; + BaseEntity.DATE_INFINITY_STRING)
    List&lt;Consultant&gt; findOnlyAudit();
}


public interface EmployeeRepository extends JpaRepository&lt;Employee, Integer&gt;
{
    @Query(&quot;from Employee where id =:id and outUtc = &quot; + BaseEntity.DATE_INFINITY_STRING)
    Optional&lt;Employee&gt; findById(@Param(&quot;id&quot;) int id);

    @Query(&quot;from Employee where id =:id&quot;)
    Optional&lt;Employee&gt; findAllById(@Param(&quot;id&quot;) int id);

    @Query(&quot;from Employee where outUtc = &quot; + BaseEntity.DATE_INFINITY_STRING)
    List&lt;Employee&gt; findAll();

    @Query(&quot;from Employee where auditId =:auditId&quot;)
    List&lt;Employee&gt; findByAuditId(@Param(&quot;auditId&quot;) String auditId);

    @Query(&quot;from Employee&quot;)
    List&lt;Employee&gt; findAllWithAudit();

    @Query(&quot;from Employee where outUtc &lt;&gt; &quot; + BaseEntity.DATE_INFINITY_STRING)
    List&lt;Employee&gt; findOnlyAudit();
}</pre>
</div></div></td></tr></tbody></table></div><h1 id="JoinedTableInheritance-modifiedWorkerController">modified WorkerController</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RestController
public class WorkerController
{
    @Autowired
    private WorkerRepository workerRepository;
    @Autowired
    private WorkerSubscriptionMapRepository workerSubscriptionMapRepository;
    @Autowired
    private ProjectWorkerMapRepository projectWorkerMapRepository;
    @Autowired
    private WorkerLinks workerLinks;

    @GetMapping(&quot;/workers&quot;)
    public ResponseEntity&lt;List&lt;WorkerDTO&gt;&gt; getWorkers()
    {
        List&lt;Worker&gt; workers = workerRepository.findAll();

        List&lt;WorkerDTO&gt; workerDTOs = createWorkerResources(workers);

        return ResponseEntity.ok(workerDTOs);
    }

    @GetMapping(&quot;/workers/{id}&quot;)
    public ResponseEntity&lt;WorkerDTO&gt; getWorkers(@PathVariable(&quot;id&quot;) int id)
    {
        Optional&lt;Worker&gt; workerOptional = workerRepository.findById(id);
        if(!workerOptional.isPresent())
        {
            throw new NotFoundException(&quot;worker-&quot; + id);
        }
        Worker worker = workerOptional.get();

        WorkerDTO workerDTO = new WorkerDTO(worker);
        Link link = linkTo(methodOn(getClass()).getWorkers(workerDTO.getWorkerID())).withSelfRel();
        workerLinks.addLinks(workerDTO, link);
        workerDTO.add(linkTo(methodOn(getClass()).getWorkers()).withRel(&quot;all&quot;));

        return ResponseEntity.ok(workerDTO);
    }


    @PostMapping(&quot;/workers&quot;)
    public ResponseEntity&lt;?&gt; createWorker(@RequestBody Worker worker)
    {
        workerRepository.save(worker);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .path(&quot;/{id}&quot;)
                .buildAndExpand(worker.getID()).toUri();

        return ResponseEntity.created(location).build();
    }

    @Transactional
    @PutMapping(&quot;/workers/{id}&quot;)
    public ResponseEntity&lt;?&gt; updateWorker(@PathVariable(&quot;id&quot;) int id, @RequestBody Worker worker)
    {
        Optional&lt;Worker&gt; existingWorkerOptional = workerRepository.findById(id);
        if(!existingWorkerOptional.isPresent())
        {
            throw new NotFoundException(&quot;worker-&quot; + id);
        }

        Worker existingWorker = existingWorkerOptional.get();
        Worker auditWorker = new Worker(existingWorker);
        existingWorker.setInUtc(new Date());

        if(StringUtils.hasText(worker.getWorkerCode()))
        {
            existingWorker.setWorkerCode(worker.getWorkerCode());
        }
        if(StringUtils.hasText(worker.getWorkerName()))
        {
            existingWorker.setWorkerName(worker.getWorkerName());
        }

        workerRepository.save(existingWorker);
        workerRepository.save(auditWorker);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand(existingWorker).toUri();

        return ResponseEntity.created(location).build();
    }

    @DeleteMapping(&quot;/workers/{id}&quot;)
    public ResponseEntity&lt;?&gt; deleteWorker(@PathVariable(&quot;id&quot;) int id)
    {
        List&lt;ProjectWorkerPair&gt; projectWorkerPairs = projectWorkerMapRepository.findByWorkerId(id);
        if(!projectWorkerPairs.isEmpty())
        {
            throw new ProjectViolationException(&quot;projects exist for worker-&quot; + id);
        }

        List&lt;WorkerSubscriptionPair&gt; workerSubscriptionPairs = workerSubscriptionMapRepository.findByWorkerId(id);
        if(!workerSubscriptionPairs.isEmpty())
        {
            throw new SubscriptionViolationException(&quot;subscription exist for worker-&quot; + id);
        }

        Optional&lt;Worker&gt; existingWorkerOptional = workerRepository.findById(id);
        if(!existingWorkerOptional.isPresent())
        {
            throw new NotFoundException(&quot;worker-&quot; + id);
        }

        Worker worker = existingWorkerOptional.get();
        worker.setOutUtc(ZonedDateTime.now());
        workerRepository.save(worker);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand().toUri();

        return ResponseEntity.created(location).build();
    }

    private List&lt;WorkerDTO&gt; createWorkerResources(List&lt;Worker&gt; workers)
    {
        List&lt;WorkerDTO&gt; workerDTOs = new ArrayList&lt;&gt;();

        for(Worker worker : workers)
        {
            WorkerDTO workerDTO = new WorkerDTO(worker);
            Link link = linkTo(methodOn(getClass()).getWorkers(workerDTO.getWorkerID())).withSelfRel();
            workerLinks.addLinks(workerDTO, link);
            workerDTOs.add(workerDTO);
        }
        return workerDTOs;
    }
}</pre>
</div></div></td></tr></tbody></table></div><h1 id="JoinedTableInheritance-newcontrollers">new controllers</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RestController
public class EmployeeController
{
    @Autowired
    private EmployeeRepository employeeRepository;
    @Autowired
    private WorkerLinks workerLinks;
    @Autowired
    private WorkerController workerController;

    @GetMapping(&quot;/employees&quot;)
    public ResponseEntity&lt;List&lt;EmployeeDTO&gt;&gt; getEmployees()
    {
        List&lt;Employee&gt; employees = employeeRepository.findAll();

        List&lt;EmployeeDTO&gt; employeeDTOs = createEmployeeResources(employees);

        return ResponseEntity.ok(employeeDTOs);
    }

    @GetMapping(&quot;/employees/{id}&quot;)
    public ResponseEntity&lt;EmployeeDTO&gt; getEmployees(@PathVariable(&quot;id&quot;) int id)
    {
        Optional&lt;Employee&gt; employeeOptional = employeeRepository.findById(id);
        if(!employeeOptional.isPresent())
        {
            throw new NotFoundException(&quot;employee-&quot; + id);
        }
        Employee employee = employeeOptional.get();

        EmployeeDTO employeeDTO = new EmployeeDTO(employee);
        Link link = linkTo(methodOn(getClass()).getEmployees(employeeDTO.getWorkerID())).withSelfRel();
        workerLinks.addLinks(employeeDTO, link);
        employeeDTO.add(linkTo(methodOn(getClass()).getEmployees()).withRel(&quot;all&quot;));

        return ResponseEntity.ok(employeeDTO);
    }

    @PostMapping(&quot;/employees&quot;)
    public ResponseEntity&lt;?&gt; createEmployee(@RequestBody Employee employee)
    {
        employeeRepository.save(employee);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .path(&quot;/{id}&quot;)
                .buildAndExpand(employee.getID()).toUri();

        return ResponseEntity.created(location).build();
    }

    @Transactional
    @PutMapping(&quot;/employees/{id}&quot;)
    public ResponseEntity&lt;?&gt; updateEmployee(@PathVariable(&quot;id&quot;) int id, @RequestBody Employee employee)
    {
        Optional&lt;Employee&gt; existingEmployeeOptional = employeeRepository.findById(id);
        if(!existingEmployeeOptional.isPresent())
        {
            throw new NotFoundException(&quot;employee-&quot; + id);
        }

        Employee existingEmployee = existingEmployeeOptional.get();
        Employee auditEmployee = new Employee(existingEmployee);
        existingEmployee.setInUtc(new Date());

        if(StringUtils.hasText(employee.getWorkerCode()))
        {
            existingEmployee.setWorkerCode(employee.getWorkerCode());
        }
        if(StringUtils.hasText(employee.getWorkerName()))
        {
            existingEmployee.setWorkerName(employee.getWorkerName());
        }
        if(StringUtils.hasText(employee.getBeneCode()))
        {
            existingEmployee.setBeneCode(employee.getBeneCode());
        }

        employeeRepository.save(existingEmployee);
        employeeRepository.save(auditEmployee);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand(existingEmployee).toUri();

        return ResponseEntity.created(location).build();
    }

    @DeleteMapping(&quot;/employees/{id}&quot;)
    public ResponseEntity&lt;?&gt; deleteEmployee(@PathVariable(&quot;id&quot;) int id)
    {
        workerController.deleteWorker(id);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand().toUri();

        return ResponseEntity.created(location).build();
    }

    private List&lt;EmployeeDTO&gt; createEmployeeResources(List&lt;Employee&gt; employees)
    {
        List&lt;EmployeeDTO&gt; employeeDTOs = new ArrayList&lt;&gt;();

        for(Employee employee : employees)
        {
            EmployeeDTO employeeDTO = new EmployeeDTO(employee);
            Link link = linkTo(methodOn(getClass()).getEmployees(employeeDTO.getWorkerID())).withSelfRel();
            workerLinks.addLinks(employeeDTO, link);
            employeeDTOs.add(employeeDTO);
        }
        return employeeDTOs;
    }
}


@RestController
public class ConsultantController
{
    @Autowired
    private ConsultantRepository consultantRepository;
    @Autowired
    private WorkerLinks workerLinks;
    @Autowired
    private WorkerController workerController;

    @GetMapping(&quot;/consultants&quot;)
    public ResponseEntity&lt;List&lt;ConsultantDTO&gt;&gt; getConsultants()
    {
        List&lt;Consultant&gt; consultants = consultantRepository.findAll();

        List&lt;ConsultantDTO&gt; consultantDTOs = createConsultantResources(consultants);

        return ResponseEntity.ok(consultantDTOs);
    }

    @GetMapping(&quot;/consultants/{id}&quot;)
    public ResponseEntity&lt;ConsultantDTO&gt; getConsultants(@PathVariable(&quot;id&quot;) int id)
    {
        Optional&lt;Consultant&gt; consultantOptional = consultantRepository.findById(id);
        if(!consultantOptional.isPresent())
        {
            throw new NotFoundException(&quot;consultant-&quot; + id);
        }
        Consultant consultant = consultantOptional.get();

        ConsultantDTO consultantDTO = new ConsultantDTO(consultant);
        Link link = linkTo(methodOn(getClass()).getConsultants(consultantDTO.getWorkerID())).withSelfRel();
        workerLinks.addLinks(consultantDTO, link);
        consultantDTO.add(linkTo(methodOn(getClass()).getConsultants()).withRel(&quot;all&quot;));

        return ResponseEntity.ok(consultantDTO);
    }

    @PostMapping(&quot;/consultants&quot;)
    public ResponseEntity&lt;?&gt; createConsultant(@RequestBody Consultant consultant)
    {
        consultantRepository.save(consultant);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .path(&quot;/{id}&quot;)
                .buildAndExpand(consultant.getID()).toUri();

        return ResponseEntity.created(location).build();
    }

    @Transactional
    @PutMapping(&quot;/consultants/{id}&quot;)
    public ResponseEntity&lt;?&gt; updateConsultant(@PathVariable(&quot;id&quot;) int id, @RequestBody Consultant consultant)
    {
        Optional&lt;Consultant&gt; existingConsultantOptional = consultantRepository.findById(id);
        if(!existingConsultantOptional.isPresent())
        {
            throw new NotFoundException(&quot;consultant-&quot; + id);
        }

        Consultant existingConsultant = existingConsultantOptional.get();
        Consultant auditConsultant = new Consultant(existingConsultant);
        existingConsultant.setInUtc(new Date());

        if(StringUtils.hasText(consultant.getWorkerCode()))
        {
            existingConsultant.setWorkerCode(consultant.getWorkerCode());
        }
        if(StringUtils.hasText(consultant.getWorkerName()))
        {
            existingConsultant.setWorkerName(consultant.getWorkerName());
        }
        if(StringUtils.hasText(consultant.getAgencyCode()))
        {
            existingConsultant.setAgencyCode(consultant.getAgencyCode());
        }

        consultantRepository.save(existingConsultant);
        consultantRepository.save(auditConsultant);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand(existingConsultant).toUri();

        return ResponseEntity.created(location).build();
    }

    @DeleteMapping(&quot;/consultants/{id}&quot;)
    public ResponseEntity&lt;?&gt; deleteEmployee(@PathVariable(&quot;id&quot;) int id)
    {
        workerController.deleteWorker(id);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand().toUri();

        return ResponseEntity.created(location).build();
    }

    private List&lt;ConsultantDTO&gt; createConsultantResources(List&lt;Consultant&gt; consultants)
    {
        List&lt;ConsultantDTO&gt; consultantDTOs = new ArrayList&lt;&gt;();

        for(Consultant consultant : consultants)
        {
            ConsultantDTO consultantDTO = new ConsultantDTO(consultant);
            Link link = linkTo(methodOn(getClass()).getConsultants(consultantDTO.getWorkerID())).withSelfRel();
            workerLinks.addLinks(consultantDTO, link);
            consultantDTOs.add(consultantDTO);
        }
        return consultantDTOs;
    }
}</pre>
</div></div></td></tr></tbody></table></div><h1 id="JoinedTableInheritance-newintegrationtests">new integration tests</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
public class ConsultantControllerTest
{
    @LocalServerPort
    private int port;

    @Autowired
    private TestRestTemplate testRestTemplate;

    @Test
    public void testA_getConsultants() throws JSONException
    {
        Set&lt;Integer&gt; consultantIDs = new HashSet(Arrays.asList(4, 5, 6));

        ResponseEntity&lt;List&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/consultants&quot;), List.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));

        JSONArray jsonArray = new JSONArray(response.getBody());

        for (int i = 0; i &lt; jsonArray.length(); ++i)
        {
            JSONObject jsonObject = (JSONObject) jsonArray.get(i);

            consultantIDs.remove(jsonObject.get(&quot;workerID&quot;));
        }

        assertTrue(consultantIDs.isEmpty());
    }

    @Test
    public void testB_getConsultant() throws JSONException
    {
        ResponseEntity&lt;ConsultantDTO&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/consultants/4&quot;), ConsultantDTO.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));

        ConsultantDTO consultantDTO = response.getBody();

        assertEquals(4, consultantDTO.getWorkerID());
        assertEquals(&quot;CODE-4&quot;, consultantDTO.getWorkerCode());
        assertEquals(&quot;Four Forth&quot;, consultantDTO.getWorkerName());
        assertEquals(&quot;AGENCY-1&quot;, consultantDTO.getAgencyCode());
    }

    @Test
    public void testC_createConsultant()
    {
        //  Create new consultant
        Consultant consultant = new Consultant();
        consultant.setWorkerCode(&quot;CODE-C&quot;);
        consultant.setWorkerName(&quot;New Consultant&quot;);
        consultant.setAgencyCode(&quot;AGENCY-CODE&quot;);

        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/consultants&quot;), consultant, Consultant.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));

        //  Read newly created consultant
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String idString = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);

        ResponseEntity&lt;ConsultantDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/consultants/&quot; + idString), ConsultantDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        ConsultantDTO consultantDTO = getResponse.getBody();

        int id = Integer.valueOf(idString);

        assertEquals(id, consultantDTO.getWorkerID());
        assertEquals(&quot;CODE-C&quot;, consultantDTO.getWorkerCode());
        assertEquals(&quot;New Consultant&quot;, consultantDTO.getWorkerName());
        assertEquals(&quot;AGENCY-CODE&quot;, consultantDTO.getAgencyCode());
    }

    @Test
    public void testD_updateConsultant()
    {
        //  Create new consultant
        Consultant consultant = new Consultant();
        consultant.setWorkerCode(&quot;CODE-C&quot;);
        consultant.setWorkerName(&quot;New Consultant&quot;);
        consultant.setAgencyCode(&quot;AGENCY-CODE&quot;);

        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/consultants&quot;), consultant, Consultant.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));

        //  Read newly created consultant
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String idString = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);

        ResponseEntity&lt;ConsultantDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/consultants/&quot; + idString), ConsultantDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        ConsultantDTO consultantDTO = getResponse.getBody();

        int id = Integer.valueOf(idString);

        assertEquals(id, consultantDTO.getWorkerID());
        assertEquals(&quot;CODE-C&quot;, consultantDTO.getWorkerCode());
        assertEquals(&quot;New Consultant&quot;, consultantDTO.getWorkerName());
        assertEquals(&quot;AGENCY-CODE&quot;, consultantDTO.getAgencyCode());

        //  Update this employee
        consultant.setWorkerCode(&quot;CODE-X&quot;);
        consultant.setWorkerName(&quot;NEW CONSULTANT&quot;);
        consultant.setAgencyCode(&quot;AGENCY-CODE-NEW&quot;);

        HttpHeaders headers = new HttpHeaders();
        HttpEntity&lt;Consultant&gt; entity = new HttpEntity&lt;&gt;(consultant, headers);
        ResponseEntity&lt;?&gt; putResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/consultants/&quot; + idString), HttpMethod.PUT, entity, Consultant.class);
        assertThat(putResponse.getStatusCode(), equalTo(HttpStatus.CREATED));

        //  Read modified consultant
        getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/consultants/&quot; + idString), ConsultantDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        consultantDTO = getResponse.getBody();

        assertEquals(&quot;CODE-X&quot;, consultantDTO.getWorkerCode());
        assertEquals(&quot;NEW CONSULTANT&quot;, consultantDTO.getWorkerName());
        assertEquals(&quot;AGENCY-CODE-NEW&quot;, consultantDTO.getAgencyCode());
    }

    @Test
    public void testE_deleteConsultant()
    {
        //  Consultant ID=6 is not associated with any projects or subscriptions
        //  delete this consultant
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/consultants/6&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = deleteResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/consultants/6&quot;));

        //  Try reading deleted consultant
        ResponseEntity&lt;String&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/consultants/6&quot;), String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.NOT_FOUND));
    }


    private String createUrlWithPort(String url)
    {
        return &quot;http://localhost:&quot; + port + url;
    }

}


@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
public class EmployeeControllerTest
{
    @LocalServerPort
    private int port;

    @Autowired
    private TestRestTemplate testRestTemplate;

    private String createUrlWithPort(String url)
    {
        return &quot;http://localhost:&quot; + port + url;
    }

    @Test
    public void testA_getEmployees() throws JSONException
    {
        Set&lt;Integer&gt; employeeIDs = new HashSet(Arrays.asList(1, 2, 3));

        ResponseEntity&lt;List&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/employees&quot;), List.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));

        JSONArray jsonArray = new JSONArray(response.getBody());

        for (int i = 0; i &lt; jsonArray.length(); ++i)
        {
            JSONObject jsonObject = (JSONObject) jsonArray.get(i);

            employeeIDs.remove(jsonObject.get(&quot;workerID&quot;));
        }

        assertTrue(employeeIDs.isEmpty());
    }

    @Test
    public void testB_getEmployee() throws JSONException
    {
        ResponseEntity&lt;EmployeeDTO&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/employees/1&quot;), EmployeeDTO.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));

        EmployeeDTO employeeDTO = response.getBody();

        assertEquals(1, employeeDTO.getWorkerID());
        assertEquals(&quot;CODE-1&quot;, employeeDTO.getWorkerCode());
        assertEquals(&quot;One First&quot;, employeeDTO.getWorkerName());
        assertEquals(&quot;BENE-1&quot;, employeeDTO.getBeneCode());
    }

    @Test
    public void testC_createEmployee()
    {
        //  Create new employee
        Employee employee = new Employee();
        employee.setWorkerCode(&quot;CODE-E&quot;);
        employee.setWorkerName(&quot;New Employee&quot;);
        employee.setBeneCode(&quot;BENE-CODE&quot;);

        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/employees&quot;), employee, Employee.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));

        //  Read newly created employee
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String idString = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);

        ResponseEntity&lt;EmployeeDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/employees/&quot; + idString), EmployeeDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        EmployeeDTO employeeDTO = getResponse.getBody();

        int id = Integer.valueOf(idString);

        assertEquals(id, employeeDTO.getWorkerID());
        assertEquals(&quot;CODE-E&quot;, employeeDTO.getWorkerCode());
        assertEquals(&quot;New Employee&quot;, employeeDTO.getWorkerName());
        assertEquals(&quot;BENE-CODE&quot;, employeeDTO.getBeneCode());
    }

    @Test
    public void testD_updateEmployee()
    {
        //  Create new employee
        Employee employee = new Employee();
        employee.setWorkerCode(&quot;CODE-E&quot;);
        employee.setWorkerName(&quot;New Employee&quot;);
        employee.setBeneCode(&quot;BENE-CODE&quot;);

        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/employees&quot;), employee, Employee.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));

        //  Read newly created employee
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String idString = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);

        ResponseEntity&lt;EmployeeDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/employees/&quot; + idString), EmployeeDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        EmployeeDTO employeeDTO = getResponse.getBody();

        int id = Integer.valueOf(idString);

        assertEquals(id, employeeDTO.getWorkerID());
        assertEquals(&quot;CODE-E&quot;, employeeDTO.getWorkerCode());
        assertEquals(&quot;New Employee&quot;, employeeDTO.getWorkerName());
        assertEquals(&quot;BENE-CODE&quot;, employeeDTO.getBeneCode());

        //  Update this employee
        employee.setWorkerCode(&quot;CODE-X&quot;);
        employee.setWorkerName(&quot;NEW EMPLOYEE&quot;);
        employee.setBeneCode(&quot;BENE-CODE-NEW&quot;);

        HttpHeaders headers = new HttpHeaders();
        HttpEntity&lt;Employee&gt; entity = new HttpEntity&lt;&gt;(employee, headers);
        ResponseEntity&lt;?&gt; putResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/employees/&quot; + idString), HttpMethod.PUT, entity, Employee.class);
        assertThat(putResponse.getStatusCode(), equalTo(HttpStatus.CREATED));

        //  Read modified employee
        getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/employees/&quot; + idString), EmployeeDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        employeeDTO = getResponse.getBody();

        assertEquals(&quot;CODE-X&quot;, employeeDTO.getWorkerCode());
        assertEquals(&quot;NEW EMPLOYEE&quot;, employeeDTO.getWorkerName());
        assertEquals(&quot;BENE-CODE-NEW&quot;, employeeDTO.getBeneCode());
    }
}</pre>
</div></div></td></tr></tbody></table></div><p />
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Feb 12, 2021 23:36</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
