<!DOCTYPE html>
<html>
    <head>
        <title>DevOps : Some Refactoring</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Home_603226548.html">DevOps Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_278921431.html">Tutorials</a></span>
                            </li>
                                                    <li>
                                <span><a href="Project-Profit-Application_315097089.html">Project Profit Application</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps : Some Refactoring
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicholas Guner</span> on Jun 02, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <ol><li><p>Consolidate Projects and Subscription links under /worker</p></li><li><p>Can we return List&lt;DTO&gt; instead of List&lt;Resource&lt;DTO&gt;&gt; since DTO derives from a Resource?</p></li></ol><h1 id="SomeRefactoring-Currentdisplayofworkers">Current display of workers</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>GET Request</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th></tr><tr><td class="confluenceTd"><p>localhost:8081/workers</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">[
  {
    &quot;workerID&quot;: 1,
    &quot;workerCode&quot;: &quot;CODE-1&quot;,
    &quot;workerName&quot;: &quot;One First&quot;,
    &quot;compensation&quot;: 120000,
    &quot;links&quot;: [
      {
        &quot;rel&quot;: &quot;self&quot;,
        &quot;href&quot;: &quot;http://localhost:8081/workers/1&quot;
      },
      {
        &quot;rel&quot;: &quot;subscription&quot;,
        &quot;href&quot;: &quot;http://localhost:8081/subscriptions/1&quot;,
        &quot;title&quot;: &quot;SUB-1&quot;
      },
      {
        &quot;rel&quot;: &quot;subscription&quot;,
        &quot;href&quot;: &quot;http://localhost:8081/subscriptions/2&quot;,
        &quot;title&quot;: &quot;SUB-2&quot;
      },
      {
        &quot;rel&quot;: &quot;subscription&quot;,
        &quot;href&quot;: &quot;http://localhost:8081/subscriptions/3&quot;,
        &quot;title&quot;: &quot;SUB-3&quot;
      },
      {
        &quot;rel&quot;: &quot;project&quot;,
        &quot;href&quot;: &quot;http://localhost:8081/projects/1&quot;,
        &quot;title&quot;: &quot;P-1&quot;
      },
      {
        &quot;rel&quot;: &quot;project&quot;,
        &quot;href&quot;: &quot;http://localhost:8081/projects/3&quot;,
        &quot;title&quot;: &quot;P-3&quot;
      }
    ]
  },</pre>
</div></div><p><br/></p></td></tr></tbody></table></div><h1 id="SomeRefactoring-DesiredDisplayofworkers">Desired Display of workers</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>GET Request</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th></tr><tr><td class="confluenceTd"><p>localhost:8081/workers</p></td><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">[
  {
    &quot;workerID&quot;: 1,
    &quot;workerCode&quot;: &quot;CODE-1&quot;,
    &quot;workerName&quot;: &quot;One First&quot;,
    &quot;compensation&quot;: 120000,
    &quot;links&quot;: [
      {
        &quot;rel&quot;: &quot;self&quot;,
        &quot;href&quot;: &quot;http://localhost:8081/workers/1&quot;
      },
      {
        &quot;rel&quot;: &quot;subscriptions&quot;,
        &quot;href&quot;: &quot;http://localhost:8081/workers/1/subscriptions&quot;
      },
      {
        &quot;rel&quot;: &quot;projects&quot;,
        &quot;href&quot;: &quot;http://localhost:8081/workers/1/projects&quot;
      }
    ]
  },
...</pre>
</div></div><p><br/></p></td></tr></tbody></table></div><h1 id="SomeRefactoring-CodingChangestoconsolidatelinks">Coding Changes to consolidate links</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Component
public class SubscriptionLinks
{
...
    private void addWorkerLinks(Resource&lt;?&gt; subscriptionResource, int id)
    {
        Link subscrriptionsLink = linkTo(methodOn(WorkerSubscriptionController.class)
                .getSubscriptionsWorkers(id))
                .withRel(&quot;workers&quot;);
        subscriptionResource.add(subscrriptionsLink);
    }
}


@Component
public class WorkerLinks
{
...
    private void addProjectSubscriptionLinks(Resource&lt;?&gt; workerResource, int id)
    {
        Link subscriptionsLink = linkTo(methodOn(WorkerSubscriptionController.class)
                .getWorkersSubscriptions(id))
                .withRel(&quot;subscriptions&quot;);
        workerResource.add(subscriptionsLink);

        Link projectsLink = linkTo(methodOn(ProjectWorkerController.class)
                .getWorkersProjects(id))
                .withRel(&quot;projects&quot;);
        workerResource.add(projectsLink);
    }
}


@Component
public class ProjectLinks
{
...
    private void addWorkerLinks(Resource&lt;?&gt; projectResource, int id)
    {
        Link workersLink = linkTo(methodOn(ProjectWorkerController.class)
                .getProjectsWorkers(id))
                .withRel(&quot;workers&quot;);
        projectResource.add(workersLink);
    }
}</pre>
</div></div></td></tr></tbody></table></div><h1 id="SomeRefactoring-ReturnList&lt;DTO&gt;insteadofList&lt;Resource&lt;DTO&gt;&gt;">Return List&lt;DTO&gt; instead of List&lt;Resource&lt;DTO&gt;&gt;</h1><h3 id="SomeRefactoring-MakesuretheDTOinheritsfromResourceSupport">Make sure the DTO inherits from ResourceSupport</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">public class ProjectDTO extends ResourceSupport
...
public class WorkerDTO extends ResourceSupport
...</pre>
</div></div></td></tr></tbody></table></div><h3 id="SomeRefactoring-ModifyControllerstoreturnList&lt;ProjectDTO&gt;insteadofList&lt;Resource&lt;ProjectDTO&gt;&gt;">Modify Controllers to return List&lt;ProjectDTO&gt; instead of List&lt;Resource&lt;ProjectDTO&gt;&gt;</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">...
@GetMapping(&quot;/projects&quot;)
public ResponseEntity&lt;List&lt;ProjectDTO&gt;&gt; getProjects()
{
    List&lt;Project&gt; projects = projectRepository.findAll();
    List&lt;ProjectDTO&gt; projectResources = createProjectResources(projects);
    return ResponseEntity.ok(projectResources);
}
...
private List&lt;ProjectDTO&gt; createProjectResources(List&lt;Project&gt; projects)
{
    List&lt;ProjectDTO&gt; projectResources = new ArrayList&lt;&gt;();
    for(Project project : projects)
    {
        ProjectDTO projectDTO = new ProjectDTO(project);
        Link link = linkTo(methodOn(getClass()).getProjects(projectDTO.getProjectID())).withSelfRel();
        projectLinks.addLinks(projectDTO, link);
        projectResources.add(projectDTO);
    }
    return projectResources;
}</pre>
</div></div></td></tr></tbody></table></div><h3 id="SomeRefactoring-AddnewmethodtoProjectLinks">Add new method to ProjectLinks</h3><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">...
public void addLinks(ProjectDTO projectDTO, Link link)
{
    projectDTO.add(link);
    addWorkerLinks(projectDTO, projectDTO.getProjectID());
}
...</pre>
</div></div></td></tr></tbody></table></div><h1 id="SomeRefactoring-CodeforLinks">Code for Links</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Component
public class ProjectLinks
{
    public void addLinks(ProjectDTO projectDTO, Link link)
    {
        projectDTO.add(link);
        addWorkerLinks(projectDTO, projectDTO.getProjectID());
    }

    public void addLinks(Project project, Link link)
    {
        project.add(link);
        addWorkerLinks(project, project.getID());
    }

    private void addWorkerLinks(ResourceSupport resource, int id)
    {
        Link workersLink = linkTo(methodOn(ProjectWorkerController.class)
                .getProjectsWorkers(id))
                .withRel(&quot;workers&quot;);
        resource.add(workersLink);
    }
}


@Component
public class WorkerLinks
{
    public void addLinks(WorkerDTO workerDTO, Link link)
    {
        workerDTO.add(link);
        addProjectLinks(workerDTO, workerDTO.getWorkerID());
        addSubscriptionLinks(workerDTO, workerDTO.getWorkerID());
    }

    public void addLinks(Worker worker, Link link)
    {
        worker.add(link);
        addProjectLinks(worker, worker.getID());
        addSubscriptionLinks(worker, worker.getID());
    }

    private void addProjectLinks(ResourceSupport resource, int id)
    {
        Link projectLink = linkTo(methodOn(ProjectWorkerController.class)
                .getWorkersProjects(id))
                .withRel(&quot;projects&quot;);
        resource.add(projectLink);
    }

    private void addSubscriptionLinks(ResourceSupport resource, int id)
    {
        Link subscriptionLink = linkTo(methodOn(WorkerSubscriptionController.class)
                .getWorkersSubscriptions(id))
                .withRel(&quot;subscriptions&quot;);
        resource.add(subscriptionLink);
    }
}


@Component
public class SubscriptionLinks
{
    public void addLinks(SubscriptionDTO subscriptionDTO, Link link)
    {
        subscriptionDTO.add(link);
        addWorkerLinks(subscriptionDTO, subscriptionDTO.getSubscriptionID());
    }

    public void addLinks(Subscription subscription, Link link)
    {
        subscription.add(link);
        addWorkerLinks(subscription, subscription.getID());
    }

    private void addWorkerLinks(ResourceSupport resource, int id)
    {
        Link workersLink = linkTo(methodOn(WorkerSubscriptionController.class)
                .getSubscriptionsWorkers(id))
                .withRel(&quot;workers&quot;);
        resource.add(workersLink);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="SomeRefactoring-CodeforControllers">Code for Controllers</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RestController
public class ProjectController
{
    @Autowired
    private ProjectRepository projectRepository;
    @Autowired
    private ProjectWorkerMapRepository projectWorkerMapRepository;
    @Autowired
    private ProjectLinks projectLinks;

    @GetMapping(&quot;/projects&quot;)
    public ResponseEntity&lt;List&lt;ProjectDTO&gt;&gt; getProjects()
    {
        List&lt;Project&gt; projects = projectRepository.findAll();

        List&lt;ProjectDTO&gt; projectResources = createProjectResources(projects);

        return ResponseEntity.ok(projectResources);
    }

    @GetMapping(&quot;/projects/{id}&quot;)
    public ResponseEntity&lt;ProjectDTO&gt; getProjects(@PathVariable(&quot;id&quot;) int id)
    {
        Optional&lt;Project&gt; projectOptional = projectRepository.findById(id);
        if(!projectOptional.isPresent())
        {
            throw new NotFoundException(&quot;project-&quot; + id);
        }
        Project project = projectOptional.get();

        ProjectDTO projectDTO = new ProjectDTO(project);
        Link link = linkTo(methodOn(getClass()).getProjects(projectDTO.getProjectID())).withSelfRel();
        projectLinks.addLinks(projectDTO, link);
        projectDTO.add(linkTo(methodOn(getClass()).getProjects()).withRel(&quot;all&quot;));
        return ResponseEntity.ok(projectDTO);
    }

    @PostMapping(&quot;/projects&quot;)
    public ResponseEntity&lt;?&gt; createProject(@RequestBody Project project)
    {
        projectRepository.save(project);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .path(&quot;/{id}&quot;)
                .buildAndExpand(project.getID()).toUri();

        return ResponseEntity.created(location).build();
    }

    @Transactional
    @PutMapping(&quot;/projects/{id}&quot;)
    public ResponseEntity&lt;?&gt; updateProject(@PathVariable(&quot;id&quot;) int id, @RequestBody Project project)
    {
        Optional&lt;Project&gt; existingProjectOptional = projectRepository.findById(id);
        if(!existingProjectOptional.isPresent())
        {
            throw new NotFoundException(&quot;project-&quot; + id);
        }

        Project existingProject = existingProjectOptional.get();
        Project autitProject = new Project(existingProject);
        existingProject.setInUtc(new Date());

        if(StringUtils.hasText(project.getProjectName()))
        {
            existingProject.setProjectName(project.getProjectName());
        }
        if(StringUtils.hasText(project.getProjectDescription()))
        {
            existingProject.setProjectDescription(project.getProjectDescription());
        }

        projectRepository.save(existingProject);
        projectRepository.save(autitProject);


        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand(existingProject).toUri();

        return ResponseEntity.created(location).build();
    }

    @DeleteMapping(&quot;/projects/{id}&quot;)
    public ResponseEntity&lt;?&gt; deleteProject(@PathVariable(&quot;id&quot;) int id)
    {
        List&lt;ProjectWorkerPair&gt; projectWorkerPairs = projectWorkerMapRepository.findByProjectId(id);
        if(!projectWorkerPairs.isEmpty())
        {
            throw new ProjectViolationException(&quot;worker exist for project-&quot; + id);
        }

        Optional&lt;Project&gt; existingProjectOptional = projectRepository.findById(id);
        if(!existingProjectOptional.isPresent())
        {
            throw new NotFoundException(&quot;project-&quot; + id);
        }

        Project project = existingProjectOptional.get();
        project.setOutUtc(ZonedDateTime.now());
        projectRepository.save(project);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand().toUri();

        return ResponseEntity.created(location).build();
    }


    private List&lt;ProjectDTO&gt; createProjectResources(List&lt;Project&gt; projects)
    {
        List&lt;ProjectDTO&gt; projectResources = new ArrayList&lt;&gt;();

        for(Project project : projects)
        {
            ProjectDTO projectDTO = new ProjectDTO(project);
            Link link = linkTo(methodOn(getClass()).getProjects(projectDTO.getProjectID())).withSelfRel();
            projectLinks.addLinks(projectDTO, link);

            projectResources.add(projectDTO);
        }
        return projectResources;
    }
}


@RestController
public class SubscriptionController
{
    @Autowired
    private SubscriptionRepository subscriptionRepository;
    @Autowired
    private WorkerSubscriptionMapRepository workerSubscriptionMapRepository;
    @Autowired
    private SubscriptionLinks subscriptionLinks;

    @GetMapping(&quot;/subscriptions&quot;)
    public ResponseEntity&lt;List&lt;SubscriptionDTO&gt;&gt; getSubscriptions()
    {
        List&lt;Subscription&gt; subscriptions = subscriptionRepository.findAll();

        List&lt;SubscriptionDTO&gt; subscriptionDTOs = createSubscriptionResources(subscriptions);

        return ResponseEntity.ok(subscriptionDTOs);
    }

    @GetMapping(&quot;/subscriptions/{id}&quot;)
    public ResponseEntity&lt;SubscriptionDTO&gt; getSubscriptions(@PathVariable(&quot;id&quot;) int id)
    {
        Optional&lt;Subscription&gt; subscriptionOptional = subscriptionRepository.findById(id);
        if(!subscriptionOptional.isPresent())
        {
            throw new NotFoundException(&quot;subscription-&quot; + id);
        }
        Subscription subscription = subscriptionOptional.get();

        SubscriptionDTO subscriptionDTO = new SubscriptionDTO(subscription);
        Link link = linkTo(methodOn(getClass()).getSubscriptions(subscriptionDTO.getSubscriptionID())).withSelfRel();
        subscriptionLinks.addLinks(subscriptionDTO, link);
        subscriptionDTO.add(linkTo(methodOn(getClass()).getSubscriptions()).withRel(&quot;all&quot;));
        return ResponseEntity.ok(subscriptionDTO);
    }

    @PostMapping(&quot;/subscriptions&quot;)
    public ResponseEntity&lt;?&gt; createSubscription(@RequestBody Subscription subscription)
    {
        subscriptionRepository.save(subscription);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .path(&quot;/{id}&quot;)
                .buildAndExpand(subscription.getID()).toUri();

        return ResponseEntity.created(location).build();
    }

    @Transactional
    @PutMapping(&quot;/subscriptions/{id}&quot;)
    public ResponseEntity&lt;?&gt; updateSubscription(@PathVariable(&quot;id&quot;) int id, @RequestBody Subscription subscription)
    {
        Optional&lt;Subscription&gt; existingSubscriptionOptional = subscriptionRepository.findById(id);
        if(!existingSubscriptionOptional.isPresent())
        {
            throw new NotFoundException(&quot;subscription-&quot; + id);
        }

        Subscription existingSubscription = existingSubscriptionOptional.get();
        Subscription autitSubscription = new Subscription(existingSubscription);
        existingSubscription.setInUtc(new Date());

        if(StringUtils.hasText(subscription.getSubscriptionCode()))
        {
            existingSubscription.setSubscriptionCode(subscription.getSubscriptionCode());
        }
        if(StringUtils.hasText(subscription.getSubscriptionName()))
        {
            existingSubscription.setSubscriptionName(subscription.getSubscriptionName());
        }

        subscriptionRepository.save(existingSubscription);
        subscriptionRepository.save(autitSubscription);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand(existingSubscription).toUri();

        return ResponseEntity.created(location).build();
    }

    @DeleteMapping(&quot;/subscriptions/{id}&quot;)
    public ResponseEntity&lt;?&gt; deleteSubscription(@PathVariable(&quot;id&quot;) int id)
    {
        List&lt;WorkerSubscriptionPair&gt; workerSubscriptionPairs = workerSubscriptionMapRepository.findBySubscriptionId(id);
        if(!workerSubscriptionPairs.isEmpty())
        {
            throw new ProjectViolationException(&quot;subscription exist for worker-&quot; + id);
        }

        Optional&lt;Subscription&gt; existingSubscriptionOptional = subscriptionRepository.findById(id);
        if(!existingSubscriptionOptional.isPresent())
        {
            throw new NotFoundException(&quot;subscription-&quot; + id);
        }

        Subscription subscription = existingSubscriptionOptional.get();
        subscription.setOutUtc(ZonedDateTime.now());
        subscriptionRepository.save(subscription);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand().toUri();

        return ResponseEntity.created(location).build();
    }

    private List&lt;SubscriptionDTO&gt; createSubscriptionResources(List&lt;Subscription&gt; subscriptions)
    {
        List&lt;SubscriptionDTO&gt; subscriptionDTOs = new ArrayList&lt;&gt;();

        for(Subscription subscription : subscriptions)
        {
            SubscriptionDTO subscriptionDTO = new SubscriptionDTO(subscription);
            Link link = linkTo(methodOn(getClass()).getSubscriptions(subscriptionDTO.getSubscriptionID())).withSelfRel();
            subscriptionLinks.addLinks(subscriptionDTO, link);

            subscriptionDTOs.add(subscriptionDTO);
        }
        return subscriptionDTOs;
    }
}


@RestController
public class WorkerController
{
    @Autowired
    private WorkerRepository workerRepository;
    @Autowired
    private WorkerSubscriptionMapRepository workerSubscriptionMapRepository;
    @Autowired
    private ProjectWorkerMapRepository projectWorkerMapRepository;
    @Autowired
    private WorkerLinks workerLinks;

    @GetMapping(&quot;/workers&quot;)
    public ResponseEntity&lt;List&lt;WorkerDTO&gt;&gt; getWorkers()
    {
        List&lt;Worker&gt; workers = workerRepository.findAll();

        List&lt;WorkerDTO&gt; workerDTOs = createWorkerResources(workers);

        return ResponseEntity.ok(workerDTOs);
    }

    @GetMapping(&quot;/workers/{id}&quot;)
    public ResponseEntity&lt;WorkerDTO&gt; getWorkers(@PathVariable(&quot;id&quot;) int id)
    {
        Optional&lt;Worker&gt; workerOptional = workerRepository.findById(id);
        if(!workerOptional.isPresent())
        {
            throw new NotFoundException(&quot;worker-&quot; + id);
        }
        Worker worker = workerOptional.get();

        WorkerDTO workerDTO = new WorkerDTO(worker);
        Link link = linkTo(methodOn(getClass()).getWorkers(workerDTO.getWorkerID())).withSelfRel();
        workerLinks.addLinks(workerDTO, link);
        workerDTO.add(linkTo(methodOn(getClass()).getWorkers()).withRel(&quot;all&quot;));

        return ResponseEntity.ok(workerDTO);
    }

    @PostMapping(&quot;/workers&quot;)
    public ResponseEntity&lt;?&gt; createWorker(@RequestBody Worker worker)
    {
        workerRepository.save(worker);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .path(&quot;/{id}&quot;)
                .buildAndExpand(worker.getID()).toUri();

        return ResponseEntity.created(location).build();
    }

    @Transactional
    @PutMapping(&quot;/workers/{id}&quot;)
    public ResponseEntity&lt;?&gt; updateWorker(@PathVariable(&quot;id&quot;) int id, @RequestBody Worker worker)
    {
        Optional&lt;Worker&gt; existingWorkerOptional = workerRepository.findById(id);
        if(!existingWorkerOptional.isPresent())
        {
            throw new NotFoundException(&quot;worker-&quot; + id);
        }

        Worker existingWorker = existingWorkerOptional.get();
        Worker autitWorker = new Worker(existingWorker);
        existingWorker.setInUtc(new Date());

        if(StringUtils.hasText(worker.getWorkerCode()))
        {
            existingWorker.setWorkerCode(worker.getWorkerCode());
        }
        if(StringUtils.hasText(worker.getWorkerName()))
        {
            existingWorker.setWorkerName(worker.getWorkerName());
        }

        workerRepository.save(existingWorker);
        workerRepository.save(autitWorker);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand(existingWorker).toUri();

        return ResponseEntity.created(location).build();
    }

    @DeleteMapping(&quot;/workers/{id}&quot;)
    public ResponseEntity&lt;?&gt; deleteWorker(@PathVariable(&quot;id&quot;) int id)
    {
        List&lt;ProjectWorkerPair&gt; projectWorkerPairs = projectWorkerMapRepository.findByWorkerId(id);
        if(!projectWorkerPairs.isEmpty())
        {
            throw new ProjectViolationException(&quot;projects exist for worker-&quot; + id);
        }

        List&lt;WorkerSubscriptionPair&gt; workerSubscriptionPairs = workerSubscriptionMapRepository.findByWorkerId(id);
        if(!workerSubscriptionPairs.isEmpty())
        {
            throw new SubscriptionViolationException(&quot;subscription exist for worker-&quot; + id);
        }

        Optional&lt;Worker&gt; existingWorkerOptional = workerRepository.findById(id);
        if(!existingWorkerOptional.isPresent())
        {
            throw new NotFoundException(&quot;worker-&quot; + id);
        }

        Worker worker = existingWorkerOptional.get();
        worker.setOutUtc(ZonedDateTime.now());
        workerRepository.save(worker);

        URI location = ServletUriComponentsBuilder
                .fromCurrentRequest()
                .buildAndExpand().toUri();

        return ResponseEntity.created(location).build();
    }

    private List&lt;WorkerDTO&gt; createWorkerResources(List&lt;Worker&gt; workers)
    {
        List&lt;WorkerDTO&gt; workerDTOs = new ArrayList&lt;&gt;();

        for(Worker worker : workers)
        {
            WorkerDTO workerDTO = new WorkerDTO(worker);
            Link link = linkTo(methodOn(getClass()).getWorkers(workerDTO.getWorkerID())).withSelfRel();
            workerLinks.addLinks(workerDTO, link);
            workerDTOs.add(workerDTO);
        }
        return workerDTOs;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="SomeRefactoring-CodeforAuditControllers">Code for Audit Controllers</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RequestMapping(value = &quot;/audit&quot;)
@RestController
public class ProjectAuditController
{
    @Autowired
    private ProjectRepository projectRepository;
    @Autowired
    private ProjectLinks projectLinks;

    @GetMapping(&quot;/projects&quot;)
    public ResponseEntity&lt;List&lt;Project&gt;&gt; getProjects(@RequestParam(defaultValue = &quot;false&quot;) boolean showAuditOnly)
    {
        List&lt;Project&gt; projects;

        if(showAuditOnly)
        {
            projects = projectRepository.findOnlyAudit();
        }
        else
        {
            projects = projectRepository.findAllWithAudit();
        }

        addLinksToProjects(projects);

        return ResponseEntity.ok(projects);
    }

    @GetMapping(&quot;/projects/{id}&quot;)
    public ResponseEntity&lt;List&lt;Project&gt;&gt; getProjects(@PathVariable(&quot;id&quot;) int id)
    {
        Optional&lt;Project&gt; projectOptional = projectRepository.findAllById(id);
        if(!projectOptional.isPresent())
        {
            throw new NotFoundException(&quot;project-&quot; + id);
        }
        Project liveProject = projectOptional.get();

        List&lt;Project&gt; projects = projectRepository.findByAuditId(liveProject.getAuditId());

        addLinksToProjects(projects);

        return ResponseEntity.ok(projects);
    }


    private void addLinksToProjects(List&lt;Project&gt; projects)
    {
        List&lt;Resource&lt;Project&gt;&gt; projectResources = new ArrayList&lt;&gt;();

        for(Project project : projects)
        {
            Resource&lt;Project&gt; projectResource = new Resource&lt;&gt;(project);

            Link link = linkTo(methodOn(getClass()).getProjects(project.getID())).withSelfRel();
            projectLinks.addLinks(project, link);

            projectResources.add(projectResource);
        }
    }
}


@RequestMapping(value = &quot;/audit&quot;)
@RestController
public class SubscriptionAuditController
{
    @Autowired
    private SubscriptionRepository subscriptionRepository;
    @Autowired
    private SubscriptionLinks subscriptionLinks;

    @GetMapping(&quot;/subscriptions&quot;)
    public ResponseEntity&lt;List&lt;Subscription&gt;&gt; getSubscriptions(@RequestParam(defaultValue = &quot;false&quot;) boolean showAuditOnly)
    {
        List&lt;Subscription&gt; subscriptions;

        if(showAuditOnly)
        {
            subscriptions = subscriptionRepository.findOnlyAudit();
        }
        else
        {
            subscriptions = subscriptionRepository.findAllWithAudit();
        }

        createSubscriptionResources(subscriptions);

        return ResponseEntity.ok(subscriptions);
    }


    @GetMapping(&quot;/subscriptions/{id}&quot;)
    public ResponseEntity&lt;List&lt;Subscription&gt;&gt; getSubscriptions(@PathVariable(&quot;id&quot;) int id)
    {
        Optional&lt;Subscription&gt; subscriptionOptional = subscriptionRepository.findAllById(id);
        if(!subscriptionOptional.isPresent())
        {
            throw new NotFoundException(&quot;subscription-&quot; + id);
        }
        Subscription liveSubscription = subscriptionOptional.get();

        List&lt;Subscription&gt; subscriptions = subscriptionRepository.findByAuditId(liveSubscription.getAuditId());

        createSubscriptionResources(subscriptions);

        return ResponseEntity.ok(subscriptions);
    }

    private void createSubscriptionResources(List&lt;Subscription&gt; subscriptions)
    {

        for(Subscription subscription : subscriptions)
        {
            Link link = linkTo(methodOn(getClass()).getSubscriptions(subscription.getID())).withSelfRel();
            subscriptionLinks.addLinks(subscription, link);
        }
    }
}


@RequestMapping(value = &quot;/audit&quot;)
@RestController
public class WorkerAuditController
{
    @Autowired
    private WorkerRepository workerRepository;
    @Autowired
    private WorkerLinks workerLinks;

    @GetMapping(&quot;/workers&quot;)
    public ResponseEntity&lt;List&lt;Worker&gt;&gt; getWorkers(@RequestParam(defaultValue = &quot;false&quot;) boolean showAuditOnly)
    {
        List&lt;Worker&gt; workers;

        if(showAuditOnly)
        {
            workers = workerRepository.findOnlyAudit();
        }
        else
        {
            workers = workerRepository.findAllWithAudit();
        }

        createWorkerResources(workers);

        return ResponseEntity.ok(workers);
    }

    @GetMapping(&quot;/workers/{id}&quot;)
    public ResponseEntity&lt;List&lt;Worker&gt;&gt; getWorkers(@PathVariable(&quot;id&quot;) int id)
    {
        Optional&lt;Worker&gt; workerOptional = workerRepository.findAllById(id);
        if(!workerOptional.isPresent())
        {
            throw new NotFoundException(&quot;worker-&quot; + id);
        }
        Worker liveWorker = workerOptional.get();

        List&lt;Worker&gt; workers = workerRepository.findByAuditId(liveWorker.getAuditId());

        createWorkerResources(workers);

        return ResponseEntity.ok(workers);
    }

    private void createWorkerResources(List&lt;Worker&gt; workers)
    {
        for(Worker worker : workers)
        {
            Link link = linkTo(methodOn(getClass()).getWorkers(worker.getID())).withSelfRel();
            workerLinks.addLinks(worker, link);
        }
    }
}</pre>
</div></div></td></tr></tbody></table></div>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Feb 12, 2021 23:36</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
