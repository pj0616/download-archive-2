<!DOCTYPE html>
<html>
    <head>
        <title>DevOps : Unit &amp; Integration Tests</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Home_603226548.html">DevOps Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_278921431.html">Tutorials</a></span>
                            </li>
                                                    <li>
                                <span><a href="Spring-Boot_278888737.html">Spring Boot</a></span>
                            </li>
                                                    <li>
                                <span><a href="Bi-Temporal-Design_289865729.html">Bi-Temporal Design</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps : Unit &amp; Integration Tests
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicholas Guner</span>, last modified on Apr 18, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="Unit&amp;IntegrationTests-IntegrationTests">Integration Tests</h1><p>The purpose of integration tests is to validate the current design. Should future coding changes invalidate any aspects of this design, the integration test will fail. For example, consider what happens when we update some entity.</p><ol><li><p>An existing entity corresponding to the supplied ID will by updated with new values. The <code>out_utc</code> value of that entity will remain to be set to infinity.</p></li><li><p>A new record will be created to reflect the old state and the <code>out_utc</code> value of this record will be set to a date in the past.</p></li></ol><p>Thus, when we write an integration test to update an existing entity, we may execute following operations:</p><ol><li><p>Create a new record and note it's auto-generated ID.</p></li><li><p>Update record with the captured ID to new values.</p></li><li><p>Get the record with captured ID and verify that new values took effect.</p></li><li><p>Use Audit controller to get the record with captured ID + 1 and verify that this record contains old values.</p></li></ol><div class="table-wrap"><table data-layout="wide" class="confluenceTable"><colgroup><col style="width: 960.0px;"/></colgroup><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
public class DutyControllerIntegrationTest
{
    @LocalServerPort
    private int port;

    @Autowired
    private TestRestTemplate testRestTemplate;

    HttpHeaders headers = new HttpHeaders();

    //@Test
    public void test_getDuties() throws JSONException
    {
        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(null, headers);
        ResponseEntity&lt;String&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/test/duties&quot;), String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));

        JSONObject jsonObject = new JSONObject(response.getBody());
        JSONArray content = (JSONArray)jsonObject.get(&quot;content&quot;);

        List&lt;Duty&gt; duties = new ArrayList&lt;&gt;();
        for(int i = 0; i &lt; content.length(); ++i)
        {
            JSONObject o  = (JSONObject)content.get(i);
            int x = 1;
        }

        JSONArray links = (JSONArray)jsonObject.get(&quot;links&quot;);
    }

    @Test
    public void testA_getDuties()
    {
        ResponseEntity&lt;?&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/duties&quot;), Resources.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));

        ResponseEntity&lt;Resources&lt;LinkedHashMap&lt;String,String&gt;&gt;&gt; dutiesResponse = (ResponseEntity&lt;Resources&lt;LinkedHashMap&lt;String,String&gt;&gt;&gt;)response;

        //  Check out_utc for all duties inside in-memory database
        for(LinkedHashMap&lt;String,String&gt; map : dutiesResponse.getBody().getContent())
        {
            String outUtcString = map.get(&quot;outUtc&quot;);
            ZonedDateTime outUtcDate = ZonedDateTime.parse(outUtcString);
            assertEquals(BaseEntity.DATE_INFINITY.toInstant().toEpochMilli(), outUtcDate.toInstant().toEpochMilli());
        }

        //  Check one of Duties
        LinkedHashMap&lt;String,String&gt; duty1 = dutiesResponse.getBody().iterator().next();

        assertEquals(&quot;duty name 1&quot;, duty1.get(&quot;dutyName&quot;));
        assertEquals(&quot;duty type 1&quot;, duty1.get(&quot;dutyType&quot;));
        assertEquals(&quot;1&quot;, duty1.get(&quot;dutyId&quot;));
        List&lt;Link&gt; links = dutiesResponse.getBody().getLinks();
        Link link = links.get(0);
        assertEquals(&quot;self&quot;, link.getRel());
    }


    @Test
    public void testB_getExistingDuty()
    {
        ResponseEntity&lt;Duty&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/duties/1&quot;), Duty.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));

        Duty duty = response.getBody();
        assertEquals(&quot;duty name 1&quot;, duty.getDutyName());
        assertEquals(&quot;duty type 1&quot;, duty.getDutyType());
        assertEquals(&quot;1&quot;, duty.getDutyId());

        assertEquals(BaseEntity.DATE_INFINITY.toInstant().toEpochMilli(), duty.getOutUtc().toInstant().toEpochMilli());
    }

    @Test
    public void testC_getNonExistingDuty()
    {
        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(null, headers);
        ResponseEntity&lt;String&gt; response = testRestTemplate.exchange(createUrlWithPort(&quot;/duties/9&quot;),
                HttpMethod.GET, entity, String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.NOT_FOUND));
        assertTrue(response.getBody().contains(&quot;uri=/duties/9&quot;));
    }

    @Test
    public void testD_createDuty()
    {
        Duty postDuty = new Duty();
        postDuty.setDutyName(&quot;duty test&quot;);

        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/duties&quot;), postDuty, Duty.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));

        ResponseEntity&lt;?&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/duties/100&quot;), Duty.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        Duty getDuty = (Duty)getResponse.getBody();
        assertEquals(&quot;duty test&quot;, getDuty.getDutyName());

        boolean exceptionThrown = false;
        try
        {
            UUID.fromString(getDuty.getDutyId());
        }
        catch(IllegalArgumentException e)
        {
            exceptionThrown = true;
        }
        assertFalse(exceptionThrown);

        assertEquals(BaseEntity.DATE_INFINITY.toInstant().toEpochMilli(), getDuty.getOutUtc().toInstant().toEpochMilli());
    }

    @Test
    public void testE_createDuty1()
    {
        //  Insert new Duty
        Duty postDuty = new Duty();
        postDuty.setDutyName(&quot;duty test&quot;);

        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(postDuty, headers);

        ResponseEntity&lt;String&gt; postResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/duties&quot;),
                HttpMethod.POST, entity, String.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String id = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);
        assertTrue(actual.contains(&quot;/duties/&quot; + id));

        //  Read newly inserted Duty
        entity = new HttpEntity&lt;&gt;(null, headers);
        ResponseEntity&lt;Duty&gt; getResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/duties/100&quot;),
                HttpMethod.GET, entity, Duty.class);

        Duty getDuty = (Duty)getResponse.getBody();
        assertEquals(&quot;duty test&quot;, getDuty.getDutyName());

        boolean exceptionThrown = false;
        try
        {
            UUID.fromString(getDuty.getDutyId());
        }
        catch(IllegalArgumentException e)
        {
            exceptionThrown = true;
        }
        assertFalse(exceptionThrown);

        assertEquals(BaseEntity.DATE_INFINITY.toInstant().toEpochMilli(), getDuty.getOutUtc().toInstant().toEpochMilli());
    }

    @Test
    public void testF_updateDuty()
    {
        Duty postDuty = new Duty();
        postDuty.setDutyName(&quot;duty test&quot;);

        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(postDuty, headers);

        ResponseEntity&lt;String&gt; postResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/duties&quot;),
                HttpMethod.POST, entity, String.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String id = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);
        assertTrue(actual.contains(&quot;/duties/&quot; + id));

        //  Read newly inserted Duty
        entity = new HttpEntity&lt;&gt;(null, headers);
        ResponseEntity&lt;Duty&gt; getResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/duties/&quot; + id),
                HttpMethod.GET, entity, Duty.class);

        Duty getDuty = (Duty)getResponse.getBody();
        assertEquals(&quot;duty test&quot;, getDuty.getDutyName());

        boolean exceptionThrown = false;
        try
        {
            UUID.fromString(getDuty.getDutyId());
        }
        catch(IllegalArgumentException e)
        {
            exceptionThrown = true;
        }
        assertFalse(exceptionThrown);

        assertEquals(BaseEntity.DATE_INFINITY.toInstant().toEpochMilli(), getDuty.getOutUtc().toInstant().toEpochMilli());


        //  Change data in existing Duty
        Duty putDuty = new Duty();
        putDuty.setDutyName(&quot;DUTY TEST&quot;);

        entity = new HttpEntity&lt;&gt;(putDuty, headers);
        ResponseEntity&lt;String&gt; putResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/duties/&quot; + id),
                HttpMethod.PUT, entity, String.class);
        actual = putResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        assertTrue(actual.contains(&quot;/duties/&quot; + id));

        //  Read modified Duty
        entity = new HttpEntity&lt;&gt;(null, headers);
        getResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/duties/&quot; + id),
                HttpMethod.GET, entity, Duty.class);

        getDuty = (Duty)getResponse.getBody();
        assertEquals(&quot;DUTY TEST&quot;, getDuty.getDutyName());
        assertEquals(BaseEntity.DATE_INFINITY.toInstant().toEpochMilli(), getDuty.getOutUtc().toInstant().toEpochMilli());


        //  Read audit Duty
        int newId = Integer.valueOf(id) + 1;
        getResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/audit/duties/&quot; + newId),
                HttpMethod.GET, entity, Duty.class);
        getDuty = (Duty)getResponse.getBody();
        assertEquals(&quot;duty test&quot;, getDuty.getDutyName());
        assertNotEquals(BaseEntity.DATE_INFINITY.toInstant().toEpochMilli(), getDuty.getOutUtc().toInstant().toEpochMilli());
    }

    @Test
    public void testG_deleteUnmappedDuty()
    {
        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(null, headers);
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/duties/5&quot;),
                HttpMethod.DELETE, entity, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = deleteResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/duties/5&quot;));

        //  Read deleted Duty
        ResponseEntity&lt;String&gt; response = testRestTemplate.exchange(createUrlWithPort(&quot;/duties/5&quot;),
                HttpMethod.GET, entity, String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.NOT_FOUND));
        assertTrue(response.getBody().contains(&quot;uri=/duties/5&quot;));

        //  Read audit Duty
        ResponseEntity&lt;Duty&gt; auditResponse = testRestTemplate.getForEntity(createUrlWithPort( &quot;/audit/duties/5&quot;), Duty.class);
        assertThat(auditResponse.getStatusCode(), equalTo(HttpStatus.OK));

        Duty duty = auditResponse.getBody();
        assertEquals(&quot;duty name 5&quot;, duty.getDutyName());
        assertEquals(&quot;duty type 5&quot;, duty.getDutyType());
        assertEquals(&quot;5&quot;, duty.getDutyId());

        assertNotEquals(BaseEntity.DATE_INFINITY.toInstant().toEpochMilli(), duty.getOutUtc().toInstant().toEpochMilli());
    }

    @Test
    public void testH_deleteMappedDuty()
    {
        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(null, headers);
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/duties/1&quot;),
                HttpMethod.DELETE, entity, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.FAILED_DEPENDENCY));
        assertTrue(deleteResponse.getBody().contains(&quot;mapping to rules exists for dutyId-1&quot;));
   }

    private String createUrlWithPort(String uri)
    {
        return &quot;http://localhost:&quot; + port + uri;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
public class DutyRuleMapControllerIntegrationTest
{
    @LocalServerPort
    private int port;

    @Autowired
    private TestRestTemplate testRestTemplate;

    HttpHeaders headers = new HttpHeaders();

    @Test
    public void testA_getDutiesRules()
    {
        ResponseEntity&lt;?&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/duties/rules&quot;), Resources.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));

        ResponseEntity&lt;Resources&lt;LinkedHashMap&lt;String,Object&gt;&gt;&gt; dutiesRulesResponse = (ResponseEntity&lt;Resources&lt;LinkedHashMap&lt;String,Object&gt;&gt;&gt;)response;

        //  Check out_utc for all duties/rules inside in-memory database
        for(LinkedHashMap&lt;String,Object&gt; map : dutiesRulesResponse.getBody().getContent())
        {
            String outUtcString = (String)map.get(&quot;outUtc&quot;);
            ZonedDateTime outUtcDate = ZonedDateTime.parse(outUtcString);
            assertEquals(BaseEntity.DATE_INFINITY.toInstant().toEpochMilli(), outUtcDate.toInstant().toEpochMilli());
        }

        //  Check one of Duties/Rules
        for(LinkedHashMap&lt;String,Object&gt; dutyRuleMap : dutiesRulesResponse.getBody())
        {
            String id = (String)dutyRuleMap.get(&quot;dutyId&quot;);
            if(id.equals(&quot;1&quot;))
            {
                LinkedHashMap&lt;String,LinkedHashMap&lt;String,String&gt;&gt; linksMap = (LinkedHashMap&lt;String,LinkedHashMap&lt;String,String&gt;&gt;)dutyRuleMap.get(&quot;_links&quot;);

                LinkedHashMap&lt;String,String&gt; ruleLinksMap = linksMap.get(&quot;rule&quot;);
                assertEquals(createUrlWithPort(&quot;/rules/1&quot;), ruleLinksMap.get(&quot;href&quot;));
                break;
            }
        }
    }

    @Test
    public void testB_getRulesDuties()
    {
        ResponseEntity&lt;?&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/rules/duties&quot;), Resources.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));

        ResponseEntity&lt;Resources&lt;LinkedHashMap&lt;String,Object&gt;&gt;&gt; rulesDutiesResponse = (ResponseEntity&lt;Resources&lt;LinkedHashMap&lt;String,Object&gt;&gt;&gt;)response;

        //  Check out_utc for all rules/duties inside in-memory database
        for(LinkedHashMap&lt;String,Object&gt; map : rulesDutiesResponse.getBody().getContent())
        {
            String outUtcString = (String)map.get(&quot;outUtc&quot;);
            ZonedDateTime outUtcDate = ZonedDateTime.parse(outUtcString);
            assertEquals(BaseEntity.DATE_INFINITY.toInstant().toEpochMilli(), outUtcDate.toInstant().toEpochMilli());
        }

        //  Check one of Rules/Duties
        for(LinkedHashMap&lt;String,Object&gt; ruleDutyMap : rulesDutiesResponse.getBody())
        {
            String id = (String)ruleDutyMap.get(&quot;ruleId&quot;);
            if(id.equals(&quot;1&quot;))
            {
                LinkedHashMap&lt;String,List&lt;LinkedHashMap&lt;String,String&gt;&gt;&gt; linksMap = (LinkedHashMap&lt;String,List&lt;LinkedHashMap&lt;String,String&gt;&gt;&gt;)ruleDutyMap.get(&quot;_links&quot;);
                List&lt;LinkedHashMap&lt;String,String&gt;&gt; dutyLinks = linksMap.get(&quot;duty&quot;);

                Set&lt;String&gt; links = new HashSet&lt;&gt;();
                dutyLinks.stream().map(e -&gt; e.get(&quot;href&quot;)).forEach(x -&gt; links.add(x));
                assertTrue(links.contains(createUrlWithPort(&quot;/duties/1&quot;)));
                break;
            }
        }
    }

    @Test
    public void testC_postExistingDutyToExistingRule()
    {
        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(null, headers);

        ResponseEntity&lt;String&gt; postResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/rules/2/duties/5&quot;),
                HttpMethod.POST, entity, String.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/rules/2/duties/5&quot;));

        //  Read newly inserted Duty for Rule
        ResponseEntity&lt;Rule&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/rules/2/duties&quot;), Rule.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        Rule rule = getResponse.getBody();
        assertEquals(&quot;rule name 2&quot;, rule.getRuleName());
        assertEquals(&quot;rule type 2&quot;, rule.getRuleType());

        Set&lt;String&gt; dutyLinks = rule.getLinks().stream().filter(l -&gt; l.getRel().equals(&quot;duty&quot;)).map(l -&gt; l.getHref()).collect(Collectors.toSet());
        assertTrue(dutyLinks.contains(createUrlWithPort(&quot;/duties/5&quot;)));
    }

    @Test
    public void testD_postExistingRuleToExistingDuty()
    {
        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(null, headers);

        ResponseEntity&lt;String&gt; postResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/duties/1/rules/3&quot;),
                HttpMethod.POST, entity, String.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/duties/1/rules/3&quot;));

        //  Read newly inserted Rule for Duty
        ResponseEntity&lt;Duty&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/duties/1/rules&quot;), Duty.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        Duty duty = getResponse.getBody();
        assertEquals(&quot;duty name 1&quot;, duty.getDutyName());
        assertEquals(&quot;duty type 1&quot;, duty.getDutyType());

        Set&lt;String&gt; ruleLinks = duty.getLinks().stream().filter(l -&gt; l.getRel().equals(&quot;rule&quot;)).map(l -&gt; l.getHref()).collect(Collectors.toSet());
        assertTrue(ruleLinks.contains(createUrlWithPort(&quot;/rules/3&quot;)));
    }

    @Test
    public void testE_postNonExistingDutyToExistingRule()
    {
        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(null, headers);

        ResponseEntity&lt;String&gt; response = testRestTemplate.exchange(createUrlWithPort(&quot;/rules/2/duties/9&quot;),
                HttpMethod.POST, entity, String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.NOT_FOUND));
        assertTrue(response.getBody().contains(&quot;uri=/rules/2/duties/9&quot;));
    }


    @Test
    public void testF_deleteExistingDutyFromExistingRule()
    {
        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(null, headers);
        ResponseEntity&lt;String&gt; response = testRestTemplate.exchange(createUrlWithPort(&quot;/rules/1/duties/1&quot;),
                HttpMethod.DELETE, entity, String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = response.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/rules/1/duties/1&quot;));

        //  Read Duty for Rule mapping
        ResponseEntity&lt;Rule&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort( &quot;/rules/1/duties&quot;), Rule.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        Rule rule = getResponse.getBody();
        List&lt;String&gt; dutyLinks = rule.getLinks().stream().filter(e -&gt; e.getRel().equals(&quot;duty&quot;)).map(l -&gt; l.getHref()).collect(Collectors.toList());
        assertFalse(dutyLinks.contains(createUrlWithPort(&quot;/duties/1&quot;)));

        //  Read audit Duty for Rule mapping
        getResponse = testRestTemplate.getForEntity(createUrlWithPort( &quot;/audit/rules/1/duties&quot;), Rule.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        rule = getResponse.getBody();
        dutyLinks = rule.getLinks().stream().filter(e -&gt; e.getRel().equals(&quot;duty&quot;)).map(l -&gt; l.getHref()).collect(Collectors.toList());
        assertTrue(dutyLinks.contains(createUrlWithPort(&quot;/duties/1&quot;)));
   }

    @Test
    public void testG_deleteExistingRuleFromExistingDuty()
    {
        HttpEntity&lt;Duty&gt; entity = new HttpEntity&lt;&gt;(null, headers);
        ResponseEntity&lt;String&gt; response = testRestTemplate.exchange(createUrlWithPort(&quot;/duties/2/rules/1&quot;),
                HttpMethod.DELETE, entity, String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = response.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/duties/2/rules/1&quot;));

        //  Read Rule for Duty mapping
        ResponseEntity&lt;Duty&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort( &quot;/duties/2/rules&quot;), Duty.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.NOT_FOUND));


        //  Read audit Rule for Duty mapping
        getResponse = testRestTemplate.getForEntity(createUrlWithPort( &quot;/audit/duties/2/rules&quot;), Duty.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));

        Duty duty = getResponse.getBody();
        List&lt;String&gt; ruleLinks = duty.getLinks().stream().filter(e -&gt; e.getRel().equals(&quot;rule&quot;)).map(l -&gt; l.getHref()).collect(Collectors.toList());
        assertTrue(ruleLinks.contains(createUrlWithPort(&quot;/rules/1&quot;)));
    }

    private String createUrlWithPort(String uri)
    {
        return &quot;http://localhost:&quot; + port + uri;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="Unit&amp;IntegrationTests-UnitTests">Unit Tests</h1><p>Unit tests are designed to test publicly exposed methods of the class. Thus, unit tests can not validate design and are to flag minor bugs. We can use Mockito in combination for MockMvc to execute unit tests.</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RunWith(SpringRunner.class)
@SpringBootTest
@AutoConfigureMockMvc
public class DutyControllerMockitoUnitTest
{
    private List&lt;Duty&gt; dutiesData = Arrays.asList(
            new Duty(1, &quot;duty name 1&quot;, &quot;duty type 1&quot;),
            new Duty(2, &quot;duty name 2&quot;, &quot;duty type 2&quot;),
            new Duty(3, &quot;duty name 3&quot;, &quot;duty type 3&quot;),
            new Duty(4, &quot;duty name 4&quot;, &quot;duty type 4&quot;));

    @Mock
    private DutyRepository dutyRepository;

    @InjectMocks
    private DutyController dutyController;


    @Test
    public void getDuties()
    {
        Mockito.when(dutyRepository.findAll()).thenReturn(dutiesData);

        ResponseEntity&lt;Resources&lt;Duty&gt;&gt; dutiesResponse = dutyController.getDuties();
        for(Duty duty : dutiesResponse.getBody())
        {
            assertEquals(0, duty.getOutUtc().compareTo(BaseEntity.DATE_INFINITY));
            boolean exceptionThrown = false;
            try
            {
                UUID.fromString(duty.getDutyId());
            }
            catch(IllegalArgumentException e)
            {
                exceptionThrown = true;
            }
            assertFalse(exceptionThrown);
        }

        Duty duty1 = dutiesResponse.getBody().iterator().next();
        assertEquals(1, duty1.getID());
        assertEquals(&quot;duty name 1&quot;, duty1.getDutyName());
        assertEquals(&quot;duty type 1&quot;, duty1.getDutyType());

        List&lt;Link&gt; links = dutiesResponse.getBody().getLinks();
        assertEquals(1, links.size());
        Link link = links.get(0);
        assertEquals(&quot;self&quot;, link.getRel());
    }

    @Test
    public void getExistingDuty()
    {
        Mockito.when(dutyRepository.findById(Mockito.anyInt())).thenReturn(Optional.of(dutiesData.get(1)));

        ResponseEntity&lt;Resource&lt;Duty&gt;&gt; dutyResponse = dutyController.getDuty(1);
        Resource&lt;Duty&gt; dutyResource = dutyResponse.getBody();
        Duty duty = dutyResource.getContent();

        assertEquals(2, duty.getID());
        assertEquals(&quot;duty name 2&quot;, duty.getDutyName());
        assertEquals(&quot;duty type 2&quot;, duty.getDutyType());

        List&lt;Link&gt; links = dutyResponse.getBody().getLinks();
        assertEquals(1, links.size());
        Link link = links.get(0);
        assertEquals(&quot;all-duties&quot;, link.getRel());
    }

    @Test
    public void getNonExistingDuty()
    {
        Mockito.when(dutyRepository.findById(Mockito.anyInt())).thenReturn(Optional.empty());

        boolean notFoundException = false;
        ResponseEntity&lt;Resource&lt;Duty&gt;&gt; dutyResponse;
        try
        {
            dutyResponse = dutyController.getDuty(1);
        }
        catch(NotFoundException e)
        {
            notFoundException = true;
        }
        assertTrue(notFoundException);
    }

    @Test
    public void createNewDuty()
    {
        Duty newDuty = new Duty();
        newDuty.setDutyName(&quot;duty name 4&quot;);

        Mockito.when(dutyRepository.save(newDuty)).thenReturn(Mockito.any());

        ResponseEntity&lt;?&gt; response = dutyController.createDuty(newDuty);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.CREATED));
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RunWith(SpringRunner.class)
@SpringBootTest
@AutoConfigureMockMvc
public class DutyControllerMockMvcUnitTest
{
    @Autowired
    MockMvc mockMvc;

    @MockBean
    private DutyRepository dutyRepository;

    @Test
    public void getDutyById() throws Exception
    {
        Duty mockDuty = new Duty(1, &quot;duty name 1&quot;, &quot;duty type 1&quot;);
        Mockito.when(dutyRepository.findById(Mockito.anyInt())).thenReturn(Optional.of(mockDuty));

        RequestBuilder requestBuilder = MockMvcRequestBuilders.get(&quot;/duties/1&quot;).accept(MediaType.APPLICATION_JSON);
        MvcResult result = mockMvc.perform(requestBuilder).andReturn();

        String resultAsString = result.getResponse().getContentAsString();
        JSONObject jsonObject = new JSONObject(resultAsString);

        assertEquals(&quot;duty name 1&quot;, jsonObject.get(&quot;dutyName&quot;));
        assertEquals(&quot;duty type 1&quot;, jsonObject.get(&quot;dutyType&quot;));

        JSONArray links = (JSONArray)jsonObject.get(&quot;links&quot;);
        JSONObject linksJson = (JSONObject)links.get(0);
        assertEquals(&quot;http://localhost/duties&quot;, linksJson.get(&quot;href&quot;));
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Feb 12, 2021 23:35</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
