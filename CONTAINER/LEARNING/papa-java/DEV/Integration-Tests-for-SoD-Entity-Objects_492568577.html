<!DOCTYPE html>
<html>
    <head>
        <title>DevOps : Integration Tests for SoD Entity Objects</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Home_603226548.html">DevOps Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_278921431.html">Tutorials</a></span>
                            </li>
                                                    <li>
                                <span><a href="Project-Profit-Application_315097089.html">Project Profit Application</a></span>
                            </li>
                                                    <li>
                                <span><a href="Unit-and-Integration-Tests-for-Subscription-Tracker_344522760.html">Unit and Integration Tests for Subscription Tracker</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps : Integration Tests for SoD Entity Objects
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicholas Guner</span> on Jul 01, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="IntegrationTestsforSoDEntityObjects-AssignableControllerTest">AssignableControllerTest</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
@TestPropertySource(locations= &quot;classpath:application-integrated.properties&quot;)
public class AssignableControllerTest
{
    @LocalServerPort
    private int port;
 
    @Autowired
    private TestRestTemplate testRestTemplate;
 
    private String createUrlWithPort(String url)
    {
        return &quot;http://localhost:&quot; + port + url;
    }
 
    @Test
    public void testA_getAllAssignables() throws JSONException
    {
        //  Verify existence of all assignables
        Set&lt;Integer&gt; assignableIDs = IntStream.rangeClosed(1, 34).boxed().collect(Collectors.toSet());
 
        ResponseEntity&lt;String&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/sod/assignables&quot;), String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        JSONArray jsonArray = new JSONArray(response.getBody());
 
        for (int i = 0; i &lt; jsonArray.length(); ++i)
        {
            JSONObject jsonObject = (JSONObject) jsonArray.get(i);
 
            int id = (int)jsonObject.get(&quot;ID&quot;);
            assignableIDs.remove(id);
        }
 
        assertTrue(assignableIDs.isEmpty());
    }
 
    @Test
    public void testB_getAssignableByID()
    {
        ResponseEntity&lt;AssignableDTO&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/sod/assignables/1&quot;), AssignableDTO.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        AssignableDTO assignableDTO = response.getBody();
 
        assertEquals(1, assignableDTO.getID());
        assertEquals(&quot;9fb49ead-06fe-36a4-b31b-8e5982603e01&quot;, assignableDTO.getPrivilegeId());
        assertEquals(&quot;PA-1&quot;, assignableDTO.getName());
    }
 
    @Test
    public void testC_createAssignable()
    {
        //  Create new assignable
        AssignableDTO assignableDTO = new AssignableDTO();
        assignableDTO.setName(&quot;new assignable&quot;);
 
        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/sod/assignables&quot;), assignableDTO, AssignableDTO.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Read newly created assignable
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String idString = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);
 
        ResponseEntity&lt;AssignableDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/assignables/&quot; + idString), AssignableDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        assignableDTO = getResponse.getBody();
 
        int id = Integer.valueOf(idString);
 
        assertEquals(id, assignableDTO.getID());
        assertEquals(&quot;new assignable&quot;, assignableDTO.getName());
    }
 
    @Test
    public void testD_updateAssignable()
    {
        //  Create new assignable
        AssignableDTO assignableDTO = new AssignableDTO();
        assignableDTO.setName(&quot;new assignable&quot;);
 
        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/sod/assignables&quot;), assignableDTO, AssignableDTO.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Read newly created assignable
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String idString = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);
 
        ResponseEntity&lt;AssignableDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/assignables/&quot; + idString), AssignableDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        assignableDTO = getResponse.getBody();
 
        int id = Integer.valueOf(idString);
 
        assertEquals(id, assignableDTO.getID());
        assertEquals(&quot;new assignable&quot;, assignableDTO.getName());
 
        //  Update this assignable
        assignableDTO.setName(&quot;NEW ASSIGNABLE&quot;);
 
        HttpHeaders headers = new HttpHeaders();
        HttpEntity&lt;AssignableDTO&gt; entity = new HttpEntity&lt;&gt;(assignableDTO, headers);
        ResponseEntity&lt;?&gt; putResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/assignables/&quot; + idString), HttpMethod.PUT, entity, AssignableDTO.class);
        assertThat(putResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Read modified assignable
        getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/assignables/&quot; + idString), AssignableDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        assignableDTO = getResponse.getBody();
 
        assertEquals(&quot;NEW ASSIGNABLE&quot;, assignableDTO.getName());
    }
 
    @Test
    public void testE_deleteUnmappedAssignable()
    {
        //  Assignable PA-99 (ID=34) is  not assigned to any duty.
        //  thus, we should be able to delete it
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/assignables/34&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = deleteResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/sod/assignables/34&quot;));
 
        //  Try reading deleted assignable
        ResponseEntity&lt;String&gt; response = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/assignables/34&quot;), HttpMethod.GET, null, String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.NOT_FOUND));
    }
 
    @Test
    public void testF_deleteMappedAssignable() throws JSONException
    {
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/assignables/16&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.BAD_REQUEST));
        JSONObject jsonObject = new JSONObject(deleteResponse.getBody());
        String debugMessage = (String) jsonObject.get(&quot;debugMessage&quot;);
        assertEquals(&quot;Cannot Delete Assignable with existing mappings&quot;, debugMessage);
    }
 
    @Test
    public void testG_deleteMappedAssignableAfterDeleteMapping() throws JSONException
    {
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/assignables/16&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.BAD_REQUEST));
        JSONObject jsonObject = new JSONObject(deleteResponse.getBody());
        String debugMessage = (String) jsonObject.get(&quot;debugMessage&quot;);
        assertEquals(&quot;Cannot Delete Assignable with existing mappings&quot;, debugMessage);
 
        AssignableIdsRequest assignableIdsRequest = new AssignableIdsRequest();
        assignableIdsRequest.setAssignableIds(Arrays.asList(16L));
        HttpEntity httpEntity = new HttpEntity(assignableIdsRequest, null);
        deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/duties/1/assignables&quot;), HttpMethod.DELETE, httpEntity, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/assignables/16&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = deleteResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/sod/assignables/16&quot;));
 
        //  Try reading deleted assignable
        ResponseEntity&lt;String&gt; response = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/assignables/16&quot;), HttpMethod.GET, null, String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.NOT_FOUND));
    }
}</pre>
</div></div></td></tr></tbody></table></div><h1 id="IntegrationTestsforSoDEntityObjects-DutyControllerTest">DutyControllerTest</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
@TestPropertySource(locations= &quot;classpath:application-integrated.properties&quot;)
public class DutyControllerTest
{
    @LocalServerPort
    private int port;
 
    @Autowired
    private TestRestTemplate testRestTemplate;
 
    private String createUrlWithPort(String url)
    {
        return &quot;http://localhost:&quot; + port + url;
    }
 
    @Test
    public void testA_getAllDuties() throws JSONException
    {
        Set&lt;Integer&gt; dutyIDs = IntStream.rangeClosed(1, 6).boxed().collect(Collectors.toSet());
 
        ResponseEntity&lt;String&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/sod/duties&quot;), String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        JSONArray jsonArray = new JSONArray(response.getBody());
 
        for (int i = 0; i &lt; jsonArray.length(); ++i)
        {
            JSONObject jsonObject = (JSONObject) jsonArray.get(i);
 
            int id = (int)jsonObject.get(&quot;ID&quot;);
            dutyIDs.remove(id);
        }
 
        assertTrue(dutyIDs.isEmpty());
    }
 
    @Test
    public void testB_getDutyByID()
    {
        ResponseEntity&lt;DutyDTO&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/sod/duties/1&quot;), DutyDTO.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        DutyDTO dutyDTO = response.getBody();
 
        assertEquals(1, dutyDTO.getID());
        assertEquals(&quot;Duty-A&quot;, dutyDTO.getName());
    }
 
    @Test
    public void testC_createDuty()
    {
        //  Create new duty
        DutyDTO dutyDTO = new DutyDTO();
        dutyDTO.setName(&quot;new duty&quot;);
 
        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/sod/duties&quot;), dutyDTO, DutyDTO.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Read newly created duty
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String idString = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);
 
        ResponseEntity&lt;DutyDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/&quot; + idString), DutyDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        dutyDTO = getResponse.getBody();
 
        int id = Integer.valueOf(idString);
 
        assertEquals(id, dutyDTO.getID());
        assertEquals(&quot;new duty&quot;, dutyDTO.getName());
    }
 
    @Test
    public void testD_updateDuty()
    {
        //  Create new duty
        DutyDTO dutyDTO = new DutyDTO();
        dutyDTO.setName(&quot;new duty&quot;);
 
        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/sod/duties&quot;), dutyDTO, DutyDTO.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Read newly created duty
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String idString = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);
 
        ResponseEntity&lt;DutyDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/&quot; + idString), DutyDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        dutyDTO = getResponse.getBody();
 
        int id = Integer.valueOf(idString);
 
        assertEquals(id, dutyDTO.getID());
        assertEquals(&quot;new duty&quot;, dutyDTO.getName());
 
        //  Update this duty
        dutyDTO.setName(&quot;NEW DUTY&quot;);
 
        HttpHeaders headers = new HttpHeaders();
        HttpEntity&lt;DutyDTO&gt; entity = new HttpEntity&lt;&gt;(dutyDTO, headers);
        ResponseEntity&lt;?&gt; putResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/duties/&quot; + idString), HttpMethod.PUT, entity, DutyDTO.class);
        assertThat(putResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Read modified duty
        getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/&quot; + idString), DutyDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        dutyDTO = getResponse.getBody();
 
        assertEquals(&quot;NEW DUTY&quot;, dutyDTO.getName());
    }
 
    @Test
    public void testE_deleteUnmappedDuty()
    {
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/duties/6&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = deleteResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/sod/duties/6&quot;));
 
        //  Try reading deleted duty
        ResponseEntity&lt;String&gt; response = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/duties/6&quot;), HttpMethod.GET, null, String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.NOT_FOUND));
    }
 
    @Test
    public void testF_deleteMappedDuty() throws JSONException
    {
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/duties/1&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.BAD_REQUEST));
        JSONObject jsonObject = new JSONObject(deleteResponse.getBody());
        String debugMessage = (String) jsonObject.get(&quot;debugMessage&quot;);
        assertEquals(&quot;Cannot Delete Duty with existing mappings&quot;, debugMessage);
    }
 
    @Test
    public void testG_deleteMappedDutyAfterDeleteMapping() throws JSONException
    {
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/duties/1&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.BAD_REQUEST));
        JSONObject jsonObject = new JSONObject(deleteResponse.getBody());
        String debugMessage = (String) jsonObject.get(&quot;debugMessage&quot;);
        assertEquals(&quot;Cannot Delete Duty with existing mappings&quot;, debugMessage);
 
        AssignableIdsRequest assignableIdsRequest = new AssignableIdsRequest();
        assignableIdsRequest.setAssignableIds(Arrays.asList(16L));
        HttpEntity httpEntity = new HttpEntity(assignableIdsRequest, null);
        deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/duties/1/assignables&quot;), HttpMethod.DELETE, httpEntity, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/assignables/16&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = deleteResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/sod/assignables/16&quot;));
 
        //  Try reading deleted assignable
        ResponseEntity&lt;String&gt; response = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/assignables/16&quot;), HttpMethod.GET, null, String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.NOT_FOUND));
    }
}</pre>
</div></div></td></tr></tbody></table></div><h1 id="IntegrationTestsforSoDEntityObjects-RuleControllerTest">RuleControllerTest</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
@TestPropertySource(locations= &quot;classpath:application-integrated.properties&quot;)
public class RuleControllerTest
{
    @LocalServerPort
    private int port;
 
    @Autowired
    private TestRestTemplate testRestTemplate;
 
    private String createUrlWithPort(String url)
    {
        return &quot;http://localhost:&quot; + port + url;
    }
 
    @Test
    public void testA_getAllRules() throws JSONException
    {
        Set&lt;Integer&gt; ruleIDs = IntStream.rangeClosed(1, 3).boxed().collect(Collectors.toSet());
 
        ResponseEntity&lt;String&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/sod/rules&quot;), String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        JSONArray jsonArray = new JSONArray(response.getBody());
 
        for (int i = 0; i &lt; jsonArray.length(); ++i)
        {
            JSONObject jsonObject = (JSONObject) jsonArray.get(i);
 
            int id = (int)jsonObject.get(&quot;ID&quot;);
            ruleIDs.remove(id);
        }
 
        assertTrue(ruleIDs.isEmpty());
    }
 
    @Test
    public void testB_getRuleByID()
    {
        ResponseEntity&lt;RuleDTO&gt; response = testRestTemplate.getForEntity(createUrlWithPort( &quot;/sod/rules/1&quot;), RuleDTO.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        RuleDTO ruleDTO = response.getBody();
 
        assertEquals(1, ruleDTO.getID());
        assertEquals(&quot;Rule-AB&quot;, ruleDTO.getName());
    }
 
    @Test
    public void testC_createSegregationRule()
    {
        //  Create new rule
        RuleDTO ruleDTO = new RuleDTO();
        ruleDTO.setName(&quot;new rule&quot;);
        ruleDTO.setRuleType(&quot;SEGREGATION&quot;);
        ruleDTO.setState(&quot;DRAFT&quot;);
        ruleDTO.setControlId(2097);
 
        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/sod/rules&quot;), ruleDTO, RuleDTO.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Read newly created rule
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String idString = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);
 
        ResponseEntity&lt;RuleDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/rules/&quot; + idString), RuleDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        ruleDTO = getResponse.getBody();
 
        int id = Integer.valueOf(idString);
 
        assertEquals(id, ruleDTO.getID());
        assertEquals(&quot;new rule&quot;, ruleDTO.getName());
    }
 
    @Test
    public void testD_updateSegregationRule()
    {
        //  Create new rule
        RuleDTO ruleDTO = new RuleDTO();
        ruleDTO.setName(&quot;new rule&quot;);
        ruleDTO.setRuleType(&quot;SEGREGATION&quot;);
        ruleDTO.setState(&quot;DRAFT&quot;);
        ruleDTO.setControlId(2097);
 
        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/sod/rules&quot;), ruleDTO, RuleDTO.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Read newly created rule
        String actual = postResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        String idString = actual.substring(actual.lastIndexOf(&quot;/&quot;) + 1);
 
        ResponseEntity&lt;RuleDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/rules/&quot; + idString), RuleDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        ruleDTO = getResponse.getBody();
 
        int id = Integer.valueOf(idString);
 
        assertEquals(id, ruleDTO.getID());
        assertEquals(&quot;new rule&quot;, ruleDTO.getName());
 
        //  Update this Rule
        ruleDTO.setName(&quot;NEW RULE&quot;);
 
        HttpHeaders headers = new HttpHeaders();
        HttpEntity&lt;RuleDTO&gt; entity = new HttpEntity&lt;&gt;(ruleDTO, headers);
        ResponseEntity&lt;?&gt; putResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/rules/&quot; + idString), HttpMethod.PUT, entity, RuleDTO.class);
        assertThat(putResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Read modified rule
        getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/rules/&quot; + idString), RuleDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        ruleDTO = getResponse.getBody();
 
        assertEquals(&quot;NEW RULE&quot;, ruleDTO.getName());
    }
 
    @Test
    public void testE_deleteUnmappedRule()
    {
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/rules/3&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
        String actual = deleteResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/sod/rules/3&quot;));
 
        //  Try reading deleted duty
        ResponseEntity&lt;String&gt; response = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/rules/3&quot;), HttpMethod.GET, null, String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.NOT_FOUND));
    }
 
    @Test
    public void testF_deleteMappedRule() throws JSONException
    {
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/rules/1&quot;), HttpMethod.DELETE, null, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.BAD_REQUEST));
        JSONObject jsonObject = new JSONObject(deleteResponse.getBody());
        String debugMessage = (String) jsonObject.get(&quot;debugMessage&quot;);
        assertEquals(&quot;Cannot delete Rule with existing mappings&quot;, debugMessage);
    }
}</pre>
</div></div></td></tr></tbody></table></div><h1 id="IntegrationTestsforSoDEntityObjects-DutyAssignableMapControllerTest">DutyAssignableMapControllerTest</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
@TestPropertySource(locations= &quot;classpath:application-integrated.properties&quot;)
public class DutyAssignableMapControllerTest
{
    @LocalServerPort
    private int port;
 
    @Autowired
    private TestRestTemplate testRestTemplate;
 
    private String createUrlWithPort(String url)
    {
        return &quot;http://localhost:&quot; + port + url;
    }
 
    @Test
    public void testA_getDutiesAssignables() throws JSONException
    {
        //  Verify that we have 5 Duties (Duty-A, Duty-B, Duty-C, Duty-X, Duty-Y) which contain assignables
        //  Note: Duty - &quot;Duty-Test&quot; does not have any assignables
        List&lt;String&gt; expectedDuties = new ArrayList(Arrays.asList(&quot;Duty-A&quot;, &quot;Duty-B&quot;, &quot;Duty-C&quot;, &quot;Duty-X&quot;, &quot;Duty-Y&quot;));
 
        ResponseEntity&lt;String&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/assignables&quot;), String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        JSONArray jsonArray = new JSONArray(response.getBody());
 
        for (int i = 0; i &lt; jsonArray.length(); ++i)
        {
            JSONObject jsonObject = (JSONObject) jsonArray.get(i);
 
            String dutyName = (String)jsonObject.get(&quot;name&quot;);
            expectedDuties.remove(dutyName);
        }
 
        assertTrue(expectedDuties.isEmpty());
    }
 
    @Test
    public void testBB_getAssignablesForDuty()
    {
        //  Verify that Duty-A (ID=1) has following assignables:
        //  PA-1, PA-2, PA-3, PA-4, PA-10, PA-11, PA-12, PAB-10, PAX-10
        List&lt;String&gt; expectedAssignables = Arrays.asList(&quot;PA-1&quot;, &quot;PA-10&quot;, &quot;PA-11&quot;, &quot;PA-12&quot;,  &quot;PA-2&quot;, &quot;PA-3&quot;, &quot;PA-4&quot;, &quot;PAB-10&quot;, &quot;PAX-1&quot;, &quot;PAX-10&quot;);
 
        ResponseEntity&lt;DutyDTO&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/1/assignables&quot;), DutyDTO.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        DutyDTO dutyDTO = response.getBody();
        List&lt;String&gt; actualAssignables = dutyDTO.getAssignables().stream().map(AssignableDTO::getName).sorted().collect(Collectors.toList());
 
        assertArrayEquals(expectedAssignables.toArray(new String[0]), actualAssignables.toArray(new String[0]));
     }
 
 
    @Test
    public void testC_getAssignablesDuties() throws JSONException
    {
        //  Verify that we have 33 assignables that are mapped to duties
        //  Note: assignable PA-99 (id=34) is not mapped to any duty
        Set&lt;Integer&gt; dutyAssignableIDs = IntStream.rangeClosed(1, 33).boxed().collect(Collectors.toSet());
 
        ResponseEntity&lt;String&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/assignables/duties&quot;), String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        JSONArray jsonArray = new JSONArray(response.getBody());
 
        for (int i = 0; i &lt; jsonArray.length(); ++i)
        {
            JSONObject jsonObject = (JSONObject) jsonArray.get(i);
 
            int id = (int)jsonObject.get(&quot;ID&quot;);
            dutyAssignableIDs.remove(id);
        }
 
        assertTrue(dutyAssignableIDs.isEmpty());
    }
 
    @Test
    public void testD_getDutiesForAssignable()
    {
        //  Verify that one of the assignables (PA-1, ID=1) is assigned to Duty-A (ID=1)
        ResponseEntity&lt;AssignableDTO&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/assignables/1/duties&quot;), AssignableDTO.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        AssignableDTO assignableDTO = response.getBody();
        assertTrue(assignableDTO.getDuties().stream().map(DutyDTO::getName).anyMatch(a -&gt; a.equals(&quot;Duty-A&quot;)));
    }
 
    @Test
    public void testE_createDutyAssignableMapping()
    {
        //  Check to make sure that Duty-A does not have Assignable PA-99 (ID=34)
        ResponseEntity&lt;DutyDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/1/assignables&quot;), DutyDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        DutyDTO dutyDTO = getResponse.getBody();
        boolean match = dutyDTO.getAssignables().stream().anyMatch(a -&gt; a.getID() == 34);
        assertFalse(match);
 
        //  Add assignable PA-99 (ID=34) to Duty-A (ID=1)
        AssignableIdsRequest assignableIdsRequest = new AssignableIdsRequest();
        assignableIdsRequest.setAssignableIds(Arrays.asList(34L));
 
        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/sod/duties/1/assignables&quot;), assignableIdsRequest, AssignableIdsRequest.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Check to make sure that Duty-A now has Assignable PA-99 (ID=34)
        getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/1/assignables&quot;), DutyDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        dutyDTO = getResponse.getBody();
        match = dutyDTO.getAssignables().stream().anyMatch(a -&gt; a.getID() == 34);
        assertTrue(match);
    }
 
    @Test
    public void testF_removeAssignableDutyMapping()
    {
        //  Check to make sure that Assignable PA-10 (ID=16) is mapped to Duty-A (ID=1)
        ResponseEntity&lt;DutyDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/1/assignables&quot;), DutyDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        DutyDTO dutyDTO = getResponse.getBody();
        boolean match = dutyDTO.getAssignables().stream().anyMatch(a -&gt; a.getID() == 16);
        assertTrue(match);
 
        // Remove assignable PA-10 (ID=16) from Duty-A (ID=1)
        AssignableIdsRequest assignableIdsRequest = new AssignableIdsRequest();
        assignableIdsRequest.setAssignableIds(Arrays.asList(16L));
 
        HttpEntity httpEntity = new HttpEntity(assignableIdsRequest, null);
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/duties/1/assignables&quot;), HttpMethod.DELETE, httpEntity, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        String actual = deleteResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/sod/duties/1/assignables&quot;));
 
        //  Check to make sure that Assignable PA-10 (ID=16) is NOT mapped to Duty-A (ID=1)
        getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/1/assignables&quot;), DutyDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        dutyDTO = getResponse.getBody();
        match = dutyDTO.getAssignables().stream().anyMatch(a -&gt; a.getID() == 16);
        assertFalse(match);
    }
}</pre>
</div></div></td></tr></tbody></table></div><h1 id="IntegrationTestsforSoDEntityObjects-RuleDutyMapControllerTest">RuleDutyMapControllerTest</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@RunWith(SpringRunner.class)
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@FixMethodOrder(MethodSorters.NAME_ASCENDING)
@DirtiesContext(classMode = DirtiesContext.ClassMode.BEFORE_EACH_TEST_METHOD)
@TestPropertySource(locations= &quot;classpath:application-integrated.properties&quot;)
public class RuleDutyMapControllerTest
{
    @LocalServerPort
    private int port;
 
    @Autowired
    private TestRestTemplate testRestTemplate;
 
    private String createUrlWithPort(String url)
    {
        return &quot;http://localhost:&quot; + port + url;
    }
 
    @Test
    public void testA_getRulesDuties() throws JSONException
    {
        //  Verify that we have 2 Rules (Rule-AB, Rule-XY) which are mapped to Duties assignables
        //  Note: Rule - &quot;Rule-Test&quot; does not have any duties
        List&lt;String&gt; expectedRules = new ArrayList(Arrays.asList(&quot;Rule-AB&quot;, &quot;Rule-XY&quot;));
 
        ResponseEntity&lt;String&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/rules/duties&quot;), String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        JSONArray jsonArray = new JSONArray(response.getBody());
 
        for (int i = 0; i &lt; jsonArray.length(); ++i)
        {
            JSONObject jsonObject = (JSONObject) jsonArray.get(i);
 
            String dutyName = (String)jsonObject.get(&quot;name&quot;);
            expectedRules.remove(dutyName);
        }
 
        assertTrue(expectedRules.isEmpty());
    }
 
    @Test
    public void testB_getDutiesForRule()
    {
        //  Verify that Rule-AB (ID=1) has following duties:
        //  Duty-A, Duty-B
        List&lt;String&gt; expectedDuties = Arrays.asList(&quot;Duty-A&quot;, &quot;Duty-B&quot;);
 
        ResponseEntity&lt;RuleDTO&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/rules/1/duties&quot;), RuleDTO.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        RuleDTO ruleDTO = response.getBody();
        List&lt;String&gt; actualDuties = ruleDTO.getDuties().stream().map(DutyDTO::getName).sorted().collect(Collectors.toList());
 
        assertArrayEquals(expectedDuties.toArray(new String[0]), actualDuties.toArray(new String[0]));
    }
 
    @Test
    public void testC_getDutiesRules() throws JSONException
    {
        //  Verify that we have 5 duties that are mapped to rules
        //  Note: duties &quot;Duty-C&quot; and &quot;Duty-Test&quot; are not mapped to any rule
        List&lt;String&gt; expectedDuties = new ArrayList(Arrays.asList(&quot;Duty-A&quot;, &quot;Duty-B&quot;, &quot;Duty-X&quot;, &quot;Duty-Y&quot;));
 
        ResponseEntity&lt;String&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/rules&quot;), String.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        JSONArray jsonArray = new JSONArray(response.getBody());
 
        for (int i = 0; i &lt; jsonArray.length(); ++i)
        {
            JSONObject jsonObject = (JSONObject) jsonArray.get(i);
 
            String name = (String)jsonObject.get(&quot;name&quot;);
            expectedDuties.remove(name);
        }
 
        assertTrue(expectedDuties.isEmpty());
    }
 
    @Test
    public void testD_getDutiesForAssignable()
    {
        //  Verify that Rule-AB is mapped to Duty-A
        ResponseEntity&lt;DutyDTO&gt; response = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/duties/1/rules&quot;), DutyDTO.class);
        assertThat(response.getStatusCode(), equalTo(HttpStatus.OK));
 
        DutyDTO dutyDTO = response.getBody();
        assertTrue(dutyDTO.getRules().stream().map(RuleDTO::getName).anyMatch(a -&gt; a.equals(&quot;Rule-AB&quot;)));
    }
 
    @Test
    public void testE_createRuleDutyMapping()
    {
        //  Check to make sure that Rule_TEST does not have Duty-C
        ResponseEntity&lt;RuleDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/rules/3/duties&quot;), RuleDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        RuleDTO ruleDTO = getResponse.getBody();
        boolean match = ruleDTO.getDuties().stream().anyMatch(a -&gt; a.getName().equals(&quot;Duty-C&quot;));
        assertFalse(match);
 
        //  Add Duty-C to Rule-TEST
        DutyIdsRequest dutyIdsRequest = new DutyIdsRequest();
        dutyIdsRequest.setDutyIds(Arrays.asList(3L));
 
        ResponseEntity&lt;?&gt; postResponse = testRestTemplate.postForEntity(createUrlWithPort(&quot;/sod/rules/3/duties&quot;), dutyIdsRequest, DutyIdsRequest.class);
        assertThat(postResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        //  Check to make sure that Rule-TEST now has Duty-C
        getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/rules/3/duties&quot;), RuleDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        ruleDTO = getResponse.getBody();
        match = ruleDTO.getDuties().stream().anyMatch(a -&gt; a.getName().equals(&quot;Duty-C&quot;));
        assertTrue(match);
    }
 
    @Test
    public void testF_removeDutyRuleMapping()
    {
        //  Check to make sure that Duty-A is mapped to Rule-AB
        ResponseEntity&lt;RuleDTO&gt; getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/rules/1/duties&quot;), RuleDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        RuleDTO ruleDTO = getResponse.getBody();
        boolean match = ruleDTO.getDuties().stream().anyMatch(a -&gt; a.getID() == 1);
        assertTrue(match);
 
        // Remove Duty-A from Rule-AB
        DutyIdsRequest dutyIdsRequest = new DutyIdsRequest();
        dutyIdsRequest.setDutyIds(Arrays.asList(1L));
 
        HttpEntity httpEntity = new HttpEntity(dutyIdsRequest, null);
        ResponseEntity&lt;String&gt; deleteResponse = testRestTemplate.exchange(createUrlWithPort(&quot;/sod/rules/1/duties&quot;), HttpMethod.DELETE, httpEntity, String.class);
        assertThat(deleteResponse.getStatusCode(), equalTo(HttpStatus.CREATED));
 
        String actual = deleteResponse.getHeaders().get(HttpHeaders.LOCATION).get(0);
        assertTrue(actual.contains(&quot;/sod/rules/1/duties&quot;));
 
        //  Check to make sure that Duty-A is NOT mapped to Rule-AB
        getResponse = testRestTemplate.getForEntity(createUrlWithPort(&quot;/sod/rules/1/duties&quot;), RuleDTO.class);
        assertThat(getResponse.getStatusCode(), equalTo(HttpStatus.OK));
 
        ruleDTO = getResponse.getBody();
        match = ruleDTO.getDuties().stream().anyMatch(a -&gt; a.getID() == 1);
        assertFalse(match);
    }
 
}</pre>
</div></div></td></tr></tbody></table></div>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Feb 12, 2021 23:36</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
