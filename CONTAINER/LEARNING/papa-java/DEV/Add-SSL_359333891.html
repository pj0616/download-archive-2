<!DOCTYPE html>
<html>
    <head>
        <title>DevOps : Add SSL</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">DevOps</a></span>
                            </li>
                                                    <li>
                                <span><a href="DevOps-Home_603226548.html">DevOps Home</a></span>
                            </li>
                                                    <li>
                                <span><a href="Tutorials_278921431.html">Tutorials</a></span>
                            </li>
                                                    <li>
                                <span><a href="Project-Profit-Application_315097089.html">Project Profit Application</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            DevOps : Add SSL
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nicholas Guner</span>, last modified on May 12, 2020
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <p>Install &quot;JSON View&quot; add-on for Chrome</p><h1 id="AddSSL-CreateKeyStore">Create Key Store</h1><p>Start Java Console</p><p>If you already have an SSL certificate, you can import it into the keystore with:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td class="confluenceTd"><p>Command:</p></td><td class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">keytool -import -alias eligibility -file &lt;file_name&gt;.crt -keystore eligibility.jks -storepass password</pre>
</div></div></td></tr></tbody></table></div><p>To create new key store, execute:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td class="confluenceTd"><p>Command:</p></td><td class="confluenceTd"><p><code>keytool -genkeypair -alias ssl-key -keyalg RSA -keysize 2048 -keystore ssl-key.jks -validity 3650</code></p></td></tr></tbody></table></div><p>Specify &quot;<code>password</code>&quot; for password and hit &lt;Return&gt; for all other prompts</p><p>Note the file <code>ssl-key.jsk</code> will be generated in the same directory</p><p>Test generated file:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Command:</strong></p></th><td class="confluenceTd"><p><code>keytool -list -v -keystore ssl-key.jks</code></p></td></tr><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response:</strong></p></th><td class="confluenceTd"><p><br/></p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">Alias name: ssl-key
Creation date: May 12, 2020
Entry type: PrivateKeyEntry
Certificate chain length: 1
Certificate[1]:
Owner: CN=first name, OU=org, O=org, L=city, ST=state, C=AA
Issuer: CN=first name, OU=org, O=org, L=city, ST=state, C=AA
Serial number: 16aa441f
Valid from: Tue May 12 08:59:46 EDT 2020 until: Fri May 10 08:59:46 EDT 2030
Certificate fingerprints:
 MD5: 2B:D2:B6:38:76:5B:E7:9A:2C:6D:38:81:E0:BB:86:C0
 SHA1: 3F:4C:F6:54:AC:03:DB:8F:8B:FB:90:EF:AF:22:7F:8A:1A:58:33:F8
 SHA256: C1:6B:7F:FC:37:76:26:D6:03:7F:64:52:62:B4:DE:5A:3A:C8:31:99:8E:73:68:B0:43:67:79:17:9C:FA:90:17
Signature algorithm name: SHA256withRSA
Subject Public Key Algorithm: 2048-bit RSA key
Version: 3
Extensions:
#1: ObjectId: 2.5.29.14 Criticality=false
SubjectKeyIdentifier [
KeyIdentifier [
0000: 95 D3 73 2C 9F 40 28 39 B7 90 AE 69 E2 35 E6 31 ..s,.@(9...i.5.1
0010: 07 6F 85 B1 .o..
]
]</pre>
</div></div><p><br/></p></td></tr></tbody></table></div><p>Move <code>ssl-key.jsk</code> file under <code>resources</code> directory.</p><h1 id="AddSSL-Integration&amp;UnitTestsmustbeshieldedfromSSLConfiguration">Integration &amp; Unit Tests must be shielded from SSL Configuration</h1><p>We will create a new application.properties file which will be used only when we run against the database. Note that the local port needs to be changed from 8080 to 8081</p><p><code>application-ssl.properties</code></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">server.http.port=8081
server.port=8443
server.ssl.key-store-type=JKS
server.ssl.key-store=classpath:ssl-key.jks
server.ssl.key-store-password=password
server.ssl.key-alias=ssl-key</pre>
</div></div></td></tr></tbody></table></div><p>Modify <code>application-db2.properties</code> and <code>application-h2.properties</code> to source <code>application-ssl.properties</code></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">spring.profiles.include=ssl
...

</pre>
</div></div></td></tr></tbody></table></div><p><code>application-h2.properties</code></p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">spring.profiles.include=ssl
spring.jpa.properties.hbm2ddl.import_files=data.sql</pre>
</div></div></td></tr></tbody></table></div><h1 id="AddSSL-AfterenablingHTTPS,addclasstoconfigpackagetobeabletorunwithHTTP">After enabling HTTPS, add class to <code>config</code> package to be able to run with HTTP</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Component
@Profile({&quot;h2&quot;, &quot;db2&quot;})
public class HttpServer
{
    @Bean
    public ServletWebServerFactory servletContainer(@Value(&quot;${server.http.port}&quot;) int httpPort)
    {
        Connector connector = new Connector(TomcatServletWebServerFactory.DEFAULT_PROTOCOL);
        connector.setPort(httpPort);

        TomcatServletWebServerFactory tomcat = new TomcatServletWebServerFactory();
        tomcat.addAdditionalTomcatConnectors(connector);
        return tomcat;
    }
}</pre>
</div></div></td></tr></tbody></table></div><p><br/></p><h1 id="AddSSL-TestHTTPSwithPostman">Test HTTPS with Postman</h1><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Request</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th></tr><tr><td class="confluenceTd"><p><a href="https://localhost:8443/employees" class="external-link" rel="nofollow">https://localhost:8443/employees</a></p></td><td class="confluenceTd"><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image confluence-external-resource image-center" src="https://confluence.apg.services.gs.com/download/attachments/761171351/image2020-5-12_6-50-18.png?version=1&amp;modificationDate=1589280618054&amp;api=v2" data-image-src="https://confluence.apg.services.gs.com/download/attachments/761171351/image2020-5-12_6-50-18.png?version=1&amp;modificationDate=1589280618054&amp;api=v2" loading="lazy"></span></td></tr></tbody></table></div><p>To understand why we got this response, let's try it from the browser. Click on the suggested link.</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Browser Request</strong></p></th><th data-highlight-colour="#f0f0f0" class="confluenceTh"><p><strong>Response</strong></p></th></tr><tr><td class="confluenceTd"><p><a href="https://localhost:8443/employees" class="external-link" rel="nofollow">https://localhost:8443/employees</a></p></td><td class="confluenceTd"><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image confluence-external-resource image-center" src="https://confluence.apg.services.gs.com/download/attachments/761171351/image2020-5-12_6-52-15.png?version=1&amp;modificationDate=1589280736036&amp;api=v2" data-image-src="https://confluence.apg.services.gs.com/download/attachments/761171351/image2020-5-12_6-52-15.png?version=1&amp;modificationDate=1589280736036&amp;api=v2" loading="lazy"></span></td></tr></tbody></table></div><p>Click on &quot;Advanced&quot; and click on link &quot;Proceed to localhost (unsafe)&quot;</p><span class="confluence-embedded-file-wrapper image-center-wrapper"><img class="confluence-embedded-image confluence-external-resource image-center" src="https://confluence.apg.services.gs.com/download/thumbnails/761171351/image2020-5-12_6-53-11.png?version=1&amp;modificationDate=1589280791609&amp;api=v2" data-image-src="https://confluence.apg.services.gs.com/download/thumbnails/761171351/image2020-5-12_6-53-11.png?version=1&amp;modificationDate=1589280791609&amp;api=v2" loading="lazy"></span><p>Note that data is displayed in the browser:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">[{&quot;employeeID&quot;:1,&quot;employeeCode&quot;:&quot;EC-1&quot;,&quot;employeeName&quot;:&quot;One First&quot;,&quot;links&quot;:[{&quot;rel&quot;:&quot;self&quot;,&quot;href&quot;:&quot;https://localhost:8443/employees/1&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/1&quot;,&quot;title&quot;:&quot;SUB-1&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/2&quot;,&quot;title&quot;:&quot;SUB-2&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/3&quot;,&quot;title&quot;:&quot;SUB-3&quot;},{&quot;rel&quot;:&quot;project&quot;,&quot;href&quot;:&quot;https://localhost:8443/projects/1&quot;,&quot;title&quot;:&quot;P-1&quot;},{&quot;rel&quot;:&quot;project&quot;,&quot;href&quot;:&quot;https://localhost:8443/projects/3&quot;,&quot;title&quot;:&quot;P-3&quot;}]},{&quot;employeeID&quot;:2,&quot;employeeCode&quot;:&quot;EC-2&quot;,&quot;employeeName&quot;:&quot;Two Second&quot;,&quot;links&quot;:[{&quot;rel&quot;:&quot;self&quot;,&quot;href&quot;:&quot;https://localhost:8443/employees/2&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/1&quot;,&quot;title&quot;:&quot;SUB-1&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/2&quot;,&quot;title&quot;:&quot;SUB-2&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/3&quot;,&quot;title&quot;:&quot;SUB-3&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/4&quot;,&quot;title&quot;:&quot;SUB-4&quot;},{&quot;rel&quot;:&quot;project&quot;,&quot;href&quot;:&quot;https://localhost:8443/projects/2&quot;,&quot;title&quot;:&quot;P-2&quot;},{&quot;rel&quot;:&quot;project&quot;,&quot;href&quot;:&quot;https://localhost:8443/projects/3&quot;,&quot;title&quot;:&quot;P-3&quot;}]},{&quot;employeeID&quot;:3,&quot;employeeCode&quot;:&quot;EC-3&quot;,&quot;employeeName&quot;:&quot;Three Third&quot;,&quot;links&quot;:[{&quot;rel&quot;:&quot;self&quot;,&quot;href&quot;:&quot;https://localhost:8443/employees/3&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/1&quot;,&quot;title&quot;:&quot;SUB-1&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/3&quot;,&quot;title&quot;:&quot;SUB-3&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/5&quot;,&quot;title&quot;:&quot;SUB-5&quot;},{&quot;rel&quot;:&quot;project&quot;,&quot;href&quot;:&quot;https://localhost:8443/projects/1&quot;,&quot;title&quot;:&quot;P-1&quot;},{&quot;rel&quot;:&quot;project&quot;,&quot;href&quot;:&quot;https://localhost:8443/projects/3&quot;,&quot;title&quot;:&quot;P-3&quot;}]},{&quot;employeeID&quot;:4,&quot;employeeCode&quot;:&quot;EC-4&quot;,&quot;employeeName&quot;:&quot;Four Forth&quot;,&quot;links&quot;:[{&quot;rel&quot;:&quot;self&quot;,&quot;href&quot;:&quot;https://localhost:8443/employees/4&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/2&quot;,&quot;title&quot;:&quot;SUB-2&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/4&quot;,&quot;title&quot;:&quot;SUB-4&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/6&quot;,&quot;title&quot;:&quot;SUB-6&quot;},{&quot;rel&quot;:&quot;project&quot;,&quot;href&quot;:&quot;https://localhost:8443/projects/2&quot;,&quot;title&quot;:&quot;P-2&quot;},{&quot;rel&quot;:&quot;project&quot;,&quot;href&quot;:&quot;https://localhost:8443/projects/3&quot;,&quot;title&quot;:&quot;P-3&quot;}]},{&quot;employeeID&quot;:5,&quot;employeeCode&quot;:&quot;EC-5&quot;,&quot;employeeName&quot;:&quot;Five Fifth&quot;,&quot;links&quot;:[{&quot;rel&quot;:&quot;self&quot;,&quot;href&quot;:&quot;https://localhost:8443/employees/5&quot;},{&quot;rel&quot;:&quot;subscription&quot;,&quot;href&quot;:&quot;https://localhost:8443/subscriptions/1&quot;,&quot;title&quot;:&quot;SUB-1&quot;}]},{&quot;employeeID&quot;:6,&quot;employeeCode&quot;:&quot;EC-6&quot;,&quot;employeeName&quot;:&quot;Six Sixth&quot;,&quot;links&quot;:[{&quot;rel&quot;:&quot;self&quot;,&quot;href&quot;:&quot;https://localhost:8443/employees/6&quot;}]}]</pre>
</div></div></td></tr></tbody></table></div><p>After installing &quot;JSON View&quot; plugin the browser output looks like this:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">[{employeeID: 1,

employeeCode: &quot;EC-1&quot;,

employeeName: &quot;One First&quot;,

links: [{rel: &quot;self&quot;,

href: &quot;https://localhost:8443/employees/1&quot;


},
{rel: &quot;subscription&quot;,

href: &quot;https://localhost:8443/subscriptions/1&quot;,

title: &quot;SUB-1&quot;


},
{rel: &quot;subscription&quot;,

href: &quot;https://localhost:8443/subscriptions/2&quot;,

title: &quot;SUB-2&quot;


},
{rel: &quot;subscription&quot;,

href: &quot;https://localhost:8443/subscriptions/3&quot;,

title: &quot;SUB-3&quot;


},
{rel: &quot;project&quot;,

href: &quot;https://localhost:8443/projects/1&quot;,

title: &quot;P-1&quot;


},
{rel: &quot;project&quot;,

href: &quot;https://localhost:8443/projects/3&quot;,

title: &quot;P-3&quot;


}

]

},
....</pre>
</div></div></td></tr></tbody></table></div><h1 id="AddSSL-EncryptSSLPassword">Encrypt SSL Password</h1><p>Note that currently we are storing SSL password in the <code>application-ssl.properties</code> file unencrypted.</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">...
server.ssl.key-store-password=password
...</pre>
</div></div></td></tr></tbody></table></div><p>Let's use the <code>SecurityEncoder</code> to encrypt this password:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">j63qzV58IESMd8YTlzXnbg==
password</pre>
</div></div></td></tr></tbody></table></div><p>Use encrypted password in<code> application-ssl.properties</code> file:</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">...
server.ssl.key-store-password=j63qzV58IESMd8YTlzXnbg==
...</pre>
</div></div></td></tr></tbody></table></div><p>Add new class to <code>config</code> package to decrypt the password</p><div class="table-wrap"><table data-layout="default" class="confluenceTable"><tbody><tr><td data-highlight-colour="#ffffff" class="confluenceTd"><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">@Component
@Profile({&quot;h2&quot;, &quot;db2&quot;})
public class SSLConfig implements WebServerFactoryCustomizer&lt;ConfigurableServletWebServerFactory&gt;
{
    @Value(&quot;${server.ssl.key-store}&quot;)
    private  String keyStore;

    @Value(&quot;${server.ssl.key-store-type}&quot;)
    private  String keyStoreType;

    @Value(&quot;${server.ssl.key-store-password}&quot;)
    private  String password;

    @Override
    public void customize(ConfigurableServletWebServerFactory serverFactory)
    {
        String password = SecurityEncoder.decrypt(this.password);

        Ssl ssl = new Ssl();
        ssl.setKeyStore(keyStore);
        ssl.setKeyStoreType(keyStoreType);
        ssl.setKeyPassword(password);
        ssl.setKeyStorePassword(password);
        serverFactory.setSsl(ssl);
    }
}</pre>
</div></div></td></tr></tbody></table></div><p />
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Feb 12, 2021 23:36</p>
                    <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>
                </section>
            </div>
        </div>     </body>
</html>
